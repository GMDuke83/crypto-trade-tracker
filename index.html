<!DOCTYPE html>
<html data-theme="dark" lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Crypto Trade Tracker Â· Modern</title>
<!-- SheetJS for XLSX export (loaded lazily in code with fallback to CSV) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- TRADINGVIEW -->
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
/* ===== Theme Tokens (Light / Dark in Schwarz-Grau) ===== */
:root{
  --bg: #0a0a0a;
  --bg-2:#111115;
  --panel:#121216;
  --panel-2:#17181c;
  --text:#f5f5f5;
  --muted:#9aa0aa;
  --border:#26282f;
  --pos:#22c55e;
  --neg:#ef4444;
  --brand:#60a5fa;
  --input:#0e0e12;
  --hover:rgba(255,255,255,.06);
  --shadow: 0 8px 24px rgba(0,0,0,.35);
  --ring: 0 0 0 3px rgba(96,165,250,.35);
  --btn-grad: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.06));
}
[data-theme="light"]{
  --bg:#f7f8fb;
  --bg-2:#eef1f6;
  --panel:#ffffff;
  --panel-2:#f3f4f6;
  --text:#0f172a;
  --muted:#6b7280;
  --border:#e5e7eb;
  --pos:#059669;
  --neg:#dc2626;
  --brand:#2563eb;
  --input:#ffffff;
  --hover:rgba(2,6,23,.04);
  --shadow: 0 6px 18px rgba(2,6,23,.06);
  --ring: 0 0 0 3px rgba(37,99,235,.18);
  --btn-grad: linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.04));
}
/* ===== Base ===== */
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{min-height:100vh;display:flex;flex-direction:column}
header{
  position:sticky; top:0; z-index:50;
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
}
.header-inner{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:12px clamp(12px,2vw,24px);
}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{
  width:28px;height:28px;border-radius:8px;
  background:var(--btn-grad); display:grid; place-items:center;
  border:1px solid var(--border);
}
.brand h1{font-size:18px;margin:0}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
/* Modern Buttons */
.btn{
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
  box-shadow:var(--shadow);
}
.btn:hover{ background:var(--hover) }
.btn:active{ transform:translateY(1px) }
.btn:focus-visible{ outline:none; box-shadow: var(--ring) }
.btn.primary{ background: var(--btn-grad); border-color: rgba(96,165,250,.35) }
.btn.ghost{ background:transparent }
.btn.danger{ border-color: rgba(239,68,68,.35) }
.btn.small{ padding:6px 10px; border-radius:10px }
.btn.icon{ padding:8px 10px; display:inline-flex; gap:8px; align-items:center }
/* Tabs */
.topnav{
  display:flex; gap:8px; padding:8px clamp(12px,2vw,24px); border-top:1px solid var(--border); background:var(--panel-2);
  flex-wrap:wrap;
}
.tab-btn{border-radius:999px; padding:8px 12px; cursor:pointer; border:1px solid var(--border); background:var(--panel);}
.tab-btn.active{ background:var(--btn-grad); border-color:rgba(96,165,250,.35) }
/* Status Bar (Dashboard) */
.statusbar{
  padding:10px clamp(12px,2vw,24px);
  display:grid; gap:10px;
  grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
  background:var(--bg-2);
  border-bottom:1px solid var(--border);
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  box-shadow:var(--shadow);
}
.card .t{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
.card .v{font-size:22px;font-weight:800;margin-top:4px}
/* Main content */
main{ flex:1; padding:16px clamp(12px,2vw,24px); display:flex; flex-direction:column; gap:14px }
.panel{ background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow) }
.panel .h{ padding:12px 14px; border-bottom:1px solid var(--border); font-weight:700; display:flex; justify-content:space-between; align-items:center }
.panel .b{ padding:14px }
/* Responsive two columns when wide */
.grid-2{ display:grid; gap:14px }
@media(min-width:1100px){ .grid-2{ grid-template-columns:1.15fr .85fr } }
/* Form */
.form-grid{ display:grid; gap:10px; grid-template-columns:repeat(6,1fr) }
.col-2{ grid-column:span 2 } .col-3{ grid-column:span 3 } .col-6{ grid-column:span 6 }
label{ display:block; font-size:12px; color:var(--muted); margin:4px 0 }
input,select{ width:100%; padding:10px 12px; border-radius:12px; background:var(--input); border:1px solid var(--border); color:var(--text) }
input:focus,select:focus{ outline:none; box-shadow: var(--ring) }
.chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px }
.chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel-2); cursor:grab }
.chip:hover{ background:var(--hover) }
/* Tables */
.table-wrap{ width:100%; overflow:auto }
table{ width:100%; border-collapse:separate; border-spacing:0 }
thead th{ position:sticky; top:0; background:var(--panel-2); z-index:1 }
th,td{ padding:10px 12px; border-bottom:1px dashed var(--border); white-space:nowrap; text-align:left }
tbody tr:hover td{ background:var(--hover) }
.num{ text-align:right; font-variant-numeric: tabular-nums }
.pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px }
.pill.open{ background:rgba(96,165,250,.08) }
.pill.closed{ background:rgba(34,197,94,.08) }
.pos{ color:var(--pos) } .neg{ color:var(--neg) }
/* Footer */
footer{ padding:18px; color:var(--muted); text-align:center; border-top:1px solid var(--border); background:var(--panel) }
/* Market Modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:20px; z-index:60 }
.modal.open{ display:flex }
.modal .box{ width:min(1000px,95vw); max-height:85vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px }
.modal .box .h{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border) }
.market-grid{ display:grid; gap:10px; padding:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)) }
.mkt{ border:1px solid var(--border); border-radius:12px; padding:10px; cursor:pointer; background:var(--panel-2) }
.mkt:hover{ background:var(--hover) }
.mkt .row{ display:flex; align-items:center; justify-content:space-between }
.badge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border) }
.badge.pos{ color:var(--pos); border-color:rgba(34,197,94,.35) }
.badge.neg{ color:var(--neg); border-color:rgba(239,68,68,.35) }
.fav{ cursor:pointer; opacity:.7 } .fav.active{ opacity:1 }
/* Filters bar */
.filters{ display:grid; gap:10px; grid-template-columns:repeat(6,1fr); padding:12px; border-bottom:1px solid var(--border); background:var(--panel-2); border-top-left-radius:16px; border-top-right-radius:16px }
/* Icon dots */
.legend{ display:flex; gap:12px; align-items:center; font-size:12px; color:var(--muted) }
.legend .dot{ width:10px; height:10px; display:inline-block; border-radius:999px }
/* Icons inline (SVG size) */
.icon{ width:16px; height:16px; display:inline-block; vertical-align:-3px }
.icon-24{ width:20px; height:20px; vertical-align:-4px }
/* Closed rows soft color */
#tbl-closed tbody tr.row-pos td{ background: rgba(34,197,94,.06) }
#tbl-closed tbody tr.row-neg td{ background: rgba(239,68,68,.06) }
#tbl-closed tbody tr.row-zero td{ background: rgba(107,114,128,.06) }
#tbl-closed tbody tr.row-pos td:first-child{ border-left:3px solid var(--pos) }
#tbl-closed tbody tr.row-neg td:first-child{ border-left:3px solid var(--neg) }
#tbl-closed tbody tr.row-zero td:first-child{ border-left:3px solid var(--border) }
/* Footer sums */
tfoot td{ border-top:1px solid var(--border); background:rgba(255,255,255,.02) }
tfoot td.bold{ font-weight:700 }
tfoot td.num{ text-align:right }

/* Spot pill dot visible */
.pill.open, .pill.closed { gap:6px }


/* Slow mode Badge (Backoff) */
#cg-updated.slow {
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
#cg-updated.slow::before {
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* In der Registerkarte 'Neue Trades' sind Bearbeiten-Buttons tabu */
#tab-new [data-edit],
[data-tab="new"] [data-edit],
.tab-new [data-edit]{
  display:none !important;
  pointer-events:none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Bereich "Auto-Kasse buchen" + "Live (Binance WS)" verstecken */
    display: none !important;
}
/* Falls in einem Wrapper-Div */
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Nur den Text von "Auto-Kasse buchen" unsichtbar machen, Checkbox bleibt sichtbar */
label[for="autoCash"],
label:has(input#autoCash) {
    color: transparent !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Nur den Text von "Auto-Kasse buchen" ausblenden, Checkbox bleibt */
label:has(input#autoCash) {
    color: transparent !important;
    text-shadow: none !important;
}
label:has(input#autoCash) * {
    color: transparent !important;
    text-shadow: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Mehr Coin-Auswahl: scrollbare Chip-Leiste */
#top-coins-extended{
  display:flex;flex-wrap:wrap;gap:8px;max-height:160px;overflow:auto;padding-right:4px;
}
#top-coins-extended .chip{
  padding:8px 12px;border-radius:999px;border:1px solid var(--border,#e5e7eb);
  background:var(--panel-2,#f3f4f6);cursor:pointer;font-weight:500;
}
#top-coins-extended .chip:hover{filter:brightness(0.98)}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* ZusÃ¤tzliche Kacheln in der Marktauswahl-Modal */
.modal-markets-extra { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; margin-top:10px; }
@media (min-width: 900px){ .modal-markets-extra{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
@media (min-width: 1200px){ .modal-markets-extra{ grid-template-columns:repeat(5,minmax(0,1fr)); } }
.market-card {
  border:1px solid var(--border,#e5e7eb); background:var(--panel,#fff);
  border-radius:14px; padding:10px 12px; cursor:pointer;
}
.market-card:hover{ filter:brightness(0.98) }
.market-card .t { font-weight:700; font-size:14px; margin-bottom:4px; }
.market-card .s { font-size:12px; opacity:.75; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
[data-theme="dark"] .tab-btn {
    color: #ffffff !important;
    text-transform: uppercase;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
#pair-chips {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
#pair-chips,
label:has(+ #pair-chips),
#top-coins-extended {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
label:has(+ #f-status),
#f-status {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
#tab-trade label:has(+ #f-grid),
#tab-trade #f-grid {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
#tab-trade label:has(+ #f-closed),
#tab-trade #f-closed {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
label:has(+ #f-exit),
#f-exit {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Hide the GebÃ¼hr field in Neue Trades */
#tab-trade label:has(+ #f-fee),
#tab-trade #f-fee {
    display: none !important;
}
/* Move Notiz next to GrÃ¶Ãe */
#tab-trade #f-note {
    width: 100% !important;
}
#tab-trade label:has(+ #f-note) {
    grid-column: span 6 !important;
}
#tab-trade label:has(+ #f-size-coin) {
    grid-column: span 6 !important;
}
#tab-trade .form-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
button, .btn {
    text-transform: uppercase !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Hide status filter */
#tab-open label:has(+ #ftr-status),
#tab-open #ftr-status {
    display: none !important;
}
/* Hide status column in table head and body */
#tab-open th:nth-child(12),
#tab-open td:nth-child(12) {
    display: none !important;
}
/* Also hide the corresponding cell in tfoot */
#tab-open tfoot td:nth-child(12) {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* --- Neue Trades: GrÃ¶Ãe (Coin) 20% + Notiz 80% in einer Zeile --- */
#tab-trade .form-grid{
  display:grid;
  grid-template-columns: repeat(10, 1fr) !important; /* 10 Spalten fÃ¼r 20/80 Aufteilung */
  gap:12px !important;
}
/* GrÃ¶Ãe (Coin) = 2/10 = 20% */
#tab-trade .form-grid > div:has(#f-size-coin){
  grid-column: span 2 !important;
}
/* Notiz = 8/10 = 80% */
#tab-trade .form-grid > div:has(#f-note){
  grid-column: span 8 !important;
}
/* GebÃ¼hr im 'Neue Trades'-Form ausblenden */
#tab-trade .form-grid > div:has(#f-fee),
#tab-trade label:has(+ #f-fee),
#tab-trade #f-fee{
  display:none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Laufende Trades: Exit und Exit-Datum Spalten + Filter ausblenden */
#tab-open th:nth-child(14),
#tab-open td:nth-child(14),
#tab-open th:nth-child(15),
#tab-open td:nth-child(15) {
    display: none !important;
}
/* Filterfelder "Von/Bis (Exit-Datum)" ausblenden */
#tab-open .filters label:has(+ #ftr-from),
#tab-open #ftr-from,
#tab-open .filters label:has(+ #ftr-to),
#tab-open #ftr-to {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style><style>
/* Laufende Trades: Real PnL Spalte ausblenden */
#tab-open th:nth-child(19),
#tab-open td:nth-child(19) {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style><style>
/* Laufende Trades: Status-Spalte ausblenden */
#tab-open th:nth-child(13),
#tab-open td:nth-child(13) {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style><style>
/* Abgeschlossene Trades: Aktion-Spalte klar ausrichten und breiter machen */
#tbl-closed thead th:last-child { width: 180px; }
#tbl-closed tbody td:last-child { text-align: right; white-space: nowrap; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style><style>
#tbl-closed thead th:last-child { width: 180px; }
#tbl-closed tbody td:last-child { text-align: right; white-space: nowrap; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style><style>
#tbl-closed thead th:last-child { width: 180px; }
#tbl-closed tbody td:last-child { text-align: right; white-space: nowrap; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Laufende Trades: Unreal PnL (inkl. Grid) Spalte + Gesamtsumme (falls vorhanden) ausblenden */
#tab-open th:nth-child(17),
#tab-open td:nth-child(17),
#tab-open tfoot td:nth-child(17) {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Laufende Trades: Unreal PnL (inkl. Grid) Gesamtsumme im Footer ausblenden */
#tab-open tfoot td:nth-child(17) {
    display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Abgeschlossene Trades: Gesamtsumme (tfoot) ausblenden */
#tab-closed #tbl-closed tfoot { display: none !important; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Sichtbar: Footer der Abgeschlossenen Trades wieder einblenden */
#tab-closed #tbl-closed tfoot { display: table-footer-group !important; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Footer-Zeilen wie normale Tabellenzeilen einfÃ¤rben */
.dataTable tfoot tr {
    background-color: inherit !important;
    color: inherit !important;
}
.dataTable tfoot tr:hover {
    background-color: rgba(255,255,255,0.03) !important; /* Hover-Effekt wie Datenzeilen */
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Alle Kalender-Icons im Dark Mode weiÃ darstellen (Custom SVG, auch bei 'Neuen Trade hinzufÃ¼gen') */
[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
    background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>');
    background-repeat: no-repeat;
    background-position: center;
    background-size: 18px;
    color-scheme: dark;
    filter: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Dark Mode: weiÃe Kalender-Icons fÃ¼r date & datetime-local */
[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator,
[data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>');
    background-repeat: no-repeat;
    background-position: center;
    background-size: 18px;
    color-scheme: dark;
    filter: none !important;
    opacity: 1 !important;
}
/* Optional: Uhr-Icon (falls angezeigt) ebenfalls aufhellen */
[data-theme="dark"] input[type="datetime-local"]::-webkit-clear-button,
[data-theme="dark"] input[type="datetime-local"]::-webkit-inner-spin-button {
    filter: invert(1) brightness(1.2);
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Laufende Trades: Unreal PnL (USDT) Spalte wieder anzeigen, Footer-Summe bleibt versteckt */
#tab-open th:nth-child(17),
#tab-open td:nth-child(17) { display: table-cell !important; }
/* Footer der Spalte weiter ausblenden */
#tab-open tfoot td:nth-child(17) { display: none !important; }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Gesamtsumme (laufende Trades): 4 Spalten und sichtbares Feld fÃ¼r Unreal PnL (inkl. Grid) USDT */
#open-sums-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
#sum-all-unreal { display:block !important; }
#open-sums-grid div:has(#sum-all-unreal) { display:block !important; }
#sum-all-unreal.pos { color: var(--pos); }
#sum-all-unreal.neg { color: var(--neg); }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
#closed-real-card{
  background: var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow: var(--shadow);
  margin:12px;
  padding:12px 12px 6px 12px;
}
#closed-real-wrap{ height:210px; }
#closed-real-chart{ width:100%; height:100%; }
#tab-closed-analytics .legend{ display:flex; gap:12px; align-items:center }
#tab-closed-analytics .legend .chips{ gap:6px }
#closed-year-select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background: var(--panel);
  color: var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 12px;
  box-shadow: var(--shadow);
  text-transform: uppercase;
  cursor:pointer;
}
#closed-year-select:focus-visible{ outline:none; box-shadow: var(--ring); }
#closed-real-sub{ color: var(--muted); font-size:12px; margin-top:6px }

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>

/* ===== CoinGecko Panel ===== */
.cg-cards{
  display:grid; gap:10px; padding:12px;
  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
}
#cg-table thead th{ position:sticky; top:0; }
.cg-spark{ width:120px; height:32px; }


/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>

<style>
/* AutoâUpdate MenÃ¼ im CoinGecko-Panel ausblenden */
#cg-refresh {
  display: none !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>


<style>
/* AutoâUpdate Label im Header des CG-Panels ausblenden */
#cg-market .h .legend label.t { display: none !important; }
/* LIVE-Badge Styling */
#cg-updated.live {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(34,197,94,.1);
  font-weight: 600;
}
#cg-updated.live::before {
  content: "";
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--pos);
  display: inline-block;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>


<style>
/* Gewinner/Verlierer Legende komplett ausblenden */
#cg-market .legend {
  display: none !important;
}
</style>

<style>
/* "AKTUALISIEREN"-Button im CoinGecko-Panel unsichtbar */
#cg-market #cg-reload {
    display: none !important;
}
</style>
<style>
/* Alle bekannten "AKTUALISIEREN"-Buttons unsichtbar machen */
#cg-reload,
#btn-refresh-chart {
    display: none !important;
}
</style>
<style>
/* Spacing between Add-Trade area and Market Overview */

#cg-market { margin-top: 5vh !important; }
</style>
<style>
/* Visual separation between Add-Trade area and Market Overview */
#cg-market {
    margin-top: 5vh !important;
    padding-top: 2vh;
    border-top: 3px solid rgba(255, 255, 255, 0.2); /* subtle light line for dark mode */
}
</style>
<style>
/* UPPERCASE for specific headings */
#tab-trade .h > div { text-transform: uppercase; }
#cg-market .h > div { text-transform: uppercase; }
</style>

<style>
/* Alte Summenzeile im TFOOT ausblenden (falls vorhanden) */
#tbl-closed tfoot { display: none !important; }
</style>

</head>
<body>
<div class="wrap">
<!-- Header -->
<header>
<div class="header-inner">
<div class="brand">
<div class="logo" title="FTT">
<!-- simple spark icon -->
<svg class="icon" fill="currentColor" viewbox="0 0 24 24">
<path d="M13 2l-2 7h7l-9 13 2-8H6l7-12z"></path>
</svg>
</div>
<h1>CRYPTO TRADE TRACKER 
<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 496 496" width="32" height="32" style="vertical-align:middle; margin-left:6px;">
<path d="M248,0C111.033,0,0,111.033,0,248s111.033,248,248,248s248-111.033,248-248S384.967,0,248,0z M248,472
	C126.393,472,24,369.607,24,248S126.393,24,248,24s224,102.393,224,224S369.607,472,248,472z"/>
<path d="M340.967,210.998c4.547-30.38-18.576-46.725-50.207-57.602l10.26-41.16l-25.058-6.25l-9.988,40.078
	c-6.588-1.641-13.36-3.188-20.136-4.717l10.039-40.225l-25.04-6.25l-10.258,41.133c-5.446-1.234-10.803-2.451-15.992-3.73l0.029-0.12
	l-34.555-8.611l-6.668,26.707c0,0,18.576,4.258,18.172,4.516c10.129,2.529,11.957,9.227,11.656,14.543l-11.68,46.793
	c0.699,0.18,1.605,0.436,2.605,0.834c-0.834-0.207-1.73-0.498-2.652-0.754l-16.379,65.598c-1.236,3.059-4.363,7.641-11.422,5.896
	c0.25,0.363-18.203-4.539-18.203-4.539l-12.469,28.727l32.59,8.121c6.061,1.514,12.004,3.09,17.84,4.586l-10.305,41.379l25.039,6.25
	l10.258-41.133c6.828,1.852,13.465,3.555,19.977,5.145l-10.242,41.059l25.057,6.25l10.305-41.414
	c42.664,8.07,74.723,4.82,88.191-33.742c10.871-31.021-0.543-48.855-22.934-60.529C327.189,237.668,338.189,227.582,340.967,210.998z
	 M289.998,293.434c-7.871,31.539-61.098,14.48-78.324,10.203l13.984-56.07C242.883,251.863,298.197,260.785,289.998,293.434z
	 M297.869,210.479c-7.172,28.75-51.422,14.127-65.754,10.555l12.68-50.828C259.221,173.781,305.49,181.352,297.869,210.479z"/>
</svg>
</h1>
</div>
<div class="controls">
<button class="btn icon" id="btn-theme" title="Light/Dark">
<span id="theme-ico">ð</span>
</button>
<button class="btn" id="btn-backup">Backup</button>
<button class="btn" id="btn-restore">Restore</button>
<input accept="application/json" id="restore-file" style="display:none" type="file"/>
</div>
</div>
<!-- Statusbar with icons -->
<div class="statusbar" id="statusbar">
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M3 13h2a2 2 0 002-2V7a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 002 2h2v6H3v-6z"></path></svg>
          Heutiger PnL
        </div>
<div class="v" id="dash-today">+0 USDT</div>
<div class="t" id="dash-today-pct"></div>
</div>
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M3 4h18v4H3V4zm0 6h18v10H3V10z"></path></svg>
          Monats-PnL
        </div>
<div class="v" id="dash-month">+0 USDT</div>
<div class="t" id="dash-month-pct"></div>
</div>
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M4 4h6v6H4V4zm0 10h6v6H4v-6zm10-10h6v6h-6V4zm0 10h6v6h-6v-6z"></path></svg>
          Offene PnL
        </div>
<div class="v" id="dash-open">0 USDT</div>
</div>
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M12 1l3 7h7l-5.5 4.5L18 21l-6-4-6 4 1.5-8.5L2 8h7z"></path></svg>
          Positionswert
        </div>
<div class="v" id="dash-posval">0 USDT</div>
</div>
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3zm0 2.2L6 8v8l6 3.3 6-3.3V8l-6-2.8z"></path></svg>
          Freies USDT
        </div>
<div class="v" id="dash-cash">0 USDT</div>
</div>
<div class="card">
<div class="t">
<svg class="icon-24" fill="currentColor" viewbox="0 0 24 24"><path d="M5 4h14v2H5V4zm0 4h10v2H5V8zm0 4h14v2H5v-2zm0 4h10v2H5v-2z"></path></svg>
          Gesamtkapital
        </div>
<div class="v" id="dash-total">0 USDT</div>
</div>
</div>
<!-- Top navigation -->
<div class="topnav">
<button class="tab-btn active" data-tab="tab-trade">NEUEN TRADE ANLEGEN</button>
<button class="tab-btn" data-tab="tab-open">Laufende Trades</button>
<button class="tab-btn" data-tab="tab-closed">Abgeschlossene</button>
<button class="tab-btn" data-tab="tab-cash">Kasse</button>
<button class="tab-btn" data-tab="tab-chart">TradingView</button>
<label style="margin-left:auto;display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px">
<input checked="" id="auto-cash" type="checkbox"/>
        AutoâKasse buchen
      </label>
<span class="t" id="last-update" style="margin-left:8px;color:var(--muted)">â</span>
</div>
</header>
<!-- Main -->
<main>
<!-- TAB: Neue Trades -->
<section class="panel" id="tab-trade">
<div class="h">
<div>Neuen Trade hinzufÃ¼gen <span class="t">Â· PaarâPreis: <b id="pair-price">â</b></span></div>
<div class="legend"><button class="btn small" id="btn-refresh-chart">ð Aktualisieren</button>
<span class="dot" style="background:var(--brand)"></span> LiveâPreis (WS)
        </div>
</div>
<div class="b">
<input id="edit-index" type="hidden" value=""/>
<div class="form-grid">
<div class="col-2">
<label>Datum (ErÃ¶ffnung)</label>
<input id="f-date" type="datetime-local"/>
</div>
<div>
<label>BÃ¶rse</label>
<select id="f-exchange">
  <option value="">Alle</option>
  <option value="Binance">Binance</option>
  <option value="Bybit">Bybit</option>
  <option value="Bitget">Bitget</option>
  <option value="Kraken">Kraken</option>
  <option value="KuCoin">KuCoin</option>
  <option value="OKX">OKX</option>
  <option value="BingX">BingX</option>
  <option value="Levex">Levex</option>
  <option value="Pionex">Pionex</option>
  <option value="Andere">Andere</option>
</select>
</div>
<div class="col-2">
<label>ID</label>
<input id="f-id" placeholder="automatisch" readonly=""/>
</div>
<div class="col-2">
<label>Paar</label>
<div style="display:flex; gap:6px; align-items:center">
<input id="f-pair" list="pairs-list" placeholder="BTC/USDT" style="flex:1"/>
<button class="btn small" id="btn-market" title="Markt wÃ¤hlen">Markt</button>
</div>
</div>
<datalist id="pairs-list"></datalist>
<div>
<label>Richtung</label>
<select id="f-side"><option>Long</option><option>Short</option><option>Spot</option></select>
</div>
<div>
<label>Hebel</label>
<input id="f-lev" min="1" step="1" type="number" value="5"/>
</div>
<div>
<label>Einstiegspreis</label>
<input id="f-entry" step="0.00000001" type="number"/>
</div>
<div>
<label>Margin (USDT)</label>
<input id="f-size-usdt" step="0.01" type="number"/>
</div>
<div>
<label>GrÃ¶Ãe (Coin)</label>
<input id="f-size-coin" step="0.00000001" type="number"/>
</div>
<div>
<label>GebÃ¼hr (USDT)</label>
<input id="f-fee" step="0.0001" type="number" value="0"/>
</div>
<div>
<label>Gewinn / Verlust</label>
<input id="f-grid" step="0.01" type="number" value="0"/>
</div>
<div>
<label>Status</label>
<select id="f-status"><option>Offen</option><option>Geschlossen</option></select>
</div>
<div>
<label>Ausstiegspreis</label>
<input id="f-exit" step="0.00000001" type="number"/>
</div>
<div class="col-2">
<label>ExitâDatum (Pflicht bei "Geschlossen")</label>
<input id="f-closed" type="datetime-local"/>
</div>
<div class="col-3">
<label>Notiz</label>
<input id="f-note" placeholder="Optional"/>
</div>
<div class="col-6">
<label>Schnellauswahl (Top)</label>
<div class="chips" id="pair-chips"></div>
</div>
</div>
<div class="chips" style="margin-top:8px">
<button class="btn primary" id="btn-add">+ Trade hinzufÃ¼gen</button>
<button class="btn primary" id="btn-save" style="display:none">Ãnderungen speichern</button>
<button class="btn" id="btn-cancel">Abbrechen</button>
<button class="btn" id="btn-duplicate">Letzten duplizieren</button>
</div>
</div>

<!-- COINGECKO MARKTPANEL â unter "Neuen Trade anlegen" -->
<section class="panel" id="cg-market">
  <div class="h" style="display:flex;justify-content:space-between;align-items:center;">
    <div>MARKTÃBERSICHT</div>
    <div class="legend" style="display:flex;gap:8px;align-items:center;">
      <label class="t">AutoâUpdate</label>
      <select id="cg-refresh" class="btn small" style="padding:6px 10px">
        <option value="0">Aus</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="180">3min</option>
      </select>
      <button class="btn small" id="cg-reload">ð Aktualisieren</button>
      <span class="t" id="cg-updated">â</span>
    </div>
  </div>
  <div class="b" style="padding:0">
    <!-- Karten -->
    <div class="cg-cards">
      <div class="card"><div class="t">Marktkapitalisierung</div><div class="v" id="cg-mcap">â</div><div class="t" id="cg-mcap-chg"></div></div>
      <div class="card"><div class="t">Volumen (24h)</div><div class="v" id="cg-vol">â</div></div>
      <div class="card"><div class="t">BTC Dominanz</div><div class="v" id="cg-btcdom">â</div></div>
      <div class="card"><div class="t">ETH Dominanz</div><div class="v" id="cg-ethdom">â</div></div>
    </div>
    <!-- Filter/Tabelle -->
    <div class="filters" style="border-top:1px solid var(--border)">
      <div><label>Anzeige</label>
        <select id="cg-limit">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="col-2"><label>Suche</label><input id="cg-search" placeholder="BTC, Ethereum ..."/></div>
      <div><label>Sortierung</label>
        <select id="cg-sort">
          <option value="mcap_desc" selected>Marktkap. â</option>
          <option value="mcap_asc">Marktkap. â</option>
          <option value="price_desc">Preis â</option>
          <option value="price_asc">Preis â</option>
          <option value="chg24_desc">% 24h â</option>
          <option value="chg24_asc">% 24h â</option>
          <option value="vol_desc">Volumen â</option>
          <option value="vol_asc">Volumen â</option>
        </select>
      </div>
      <div class="legend" style="grid-column:1/-1">
        <span class="dot" style="background:var(--pos)"></span> Gewinner Â·
        <span class="dot" style="background:var(--neg)"></span> Verlierer Â·
        Klick auf einen Namen setzt oben das Paar & den Entry
      </div>
    </div>
    <div class="b table-wrap" style="padding:0">
      <table id="cg-table">
        <thead>
          <tr>
            <th>#</th><th>Name</th><th class="num">Preis</th><th class="num">1h %</th><th class="num">24h %</th><th class="num">7d %</th>
            <th class="num">Marktkap.</th><th class="num">Vol. (24h)</th><th class="num">Umlauf</th><th class="num">7d</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="cg-pager" class="pager" style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0"></div>
    </div>
  </div>
</section>

</section>
<!-- TAB: Laufende -->
<section class="panel" id="tab-open" style="display:none">
<div class="h">
<div>Laufende Trades</div>
<div style="display:flex;gap:8px">
<button class="btn" id="btn-export-xlsx">Export XLSX</button>
</div>
</div>
<div class="filters">
<div>
<label>BÃ¶rse</label>
<select id="ftr-exchange">
  <option value="">Alle</option>
  <option value="Binance">Binance</option>
  <option value="Bybit">Bybit</option>
  <option value="Bitget">Bitget</option>
  <option value="Kraken">Kraken</option>
  <option value="KuCoin">KuCoin</option>
  <option value="OKX">OKX</option>
  <option value="BingX">BingX</option>
  <option value="Levex">Levex</option>
  <option value="Pionex">Pionex</option>
  <option value="Andere">Andere</option>
</select>
</div>
<div>
<label>Status</label>
<select id="ftr-status"><option value="">Alle</option><option>Offen</option><option>Geschlossen</option></select>
</div>
<div>
<label>Richtung</label>
<select id="ftr-side"><option value="">Alle</option><option>Long</option><option>Short</option><option>Spot</option></select>
</div>
<div>
<label>Suche (Paar/ID)</label>
<input id="ftr-q" placeholder="BTC, ID 001..."/>
</div>
<div>
<label>Von (ExitâDatum)</label>
<input id="ftr-from" type="date"/>
</div>
<div>
<label>Bis (ExitâDatum)</label>
<input id="ftr-to" type="date"/>
</div>
<div>
<label>Anzeige</label>
<select id="open-page-len">
<option value="5">5</option>
<option value="10">10</option>
<option value="25" selected>25</option>
<option value="50">50</option>
<option value="100">100</option>
<option value="all">Alle</option>
</select>
</div>
</div>
<div class="b table-wrap" style="padding:0">
<table id="tbl">
<thead>
<tr>
<th>Datum (Open)</th><th>BÃ¶rse</th><th>ID</th><th>Paar</th><th>Side</th><th>Hebel</th>
<th class="num">Entry</th><th class="num">Aktuell</th><th class="num">Margin USDT</th><th class="num">PositionsgrÃ¶Ãe (USDT)</th><th class="num">Coin Wert</th><th class="num">GebÃ¼hr</th>
<th>Status</th><th class="num">Exit</th><th>ExitâDatum</th><th class="num">Grid Gewinne<br/>&amp; Sonstige</th><th class="num">Unreal PnL<br/>(inkl. Grid) USDT</th><th class="num">Unreal %</th><th class="num">Real PnL</th>
<th>Aktion</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="pager" id="open-pager" style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0"></div>
</div>
</section>
<!-- TAB: Abgeschlossene -->
<section class="panel" id="tab-closed" style="display:none">
<div class="h">Abgeschlossene Trades <div style="display:flex;gap:8px"><button class="btn" id="btn-export-closed-xlsx">Export XLSX</button></div></div>
<div class="filters" id="closed-filters" style="margin-bottom:8px">
<div style="grid-column:1 / -1; display:flex; gap:8px; align-items:center;">
  <button class="btn small" id="btn-reset-closed-filters" title="Alle Filter lÃ¶schen">Filter zurÃ¼cksetzen</button>
</div>
<div><label>BÃ¶rse</label><select id="fcl-exchange">
  <option value="">Alle</option>
  <option value="Binance">Binance</option>
  <option value="Bybit">Bybit</option>
  <option value="Bitget">Bitget</option>
  <option value="Kraken">Kraken</option>
  <option value="KuCoin">KuCoin</option>
  <option value="OKX">OKX</option>
  <option value="BingX">BingX</option>
  <option value="Levex">Levex</option>
  <option value="Pionex">Pionex</option>
  <option value="Andere">Andere</option>
</select></div>
<div><label>Status</label><select id="fcl-status"><option value="">Alle</option><option value="win">Gewinn</option><option value="loss">Verlust</option></select></div>
<div><label>Richtung</label><select id="fcl-side"><option value="">Alle</option><option value="LONG">Long</option><option value="SHORT">Short</option><option value="SPOT">Spot</option></select></div>
<div class="col-2"><label>Suche (Paar/ID)</label><input id="fcl-q" placeholder="BTC, ID 001..."/></div>
<div><label>Von (ExitâDatum)</label><input id="fcl-from" type="date"/></div>
<div><label>Bis (ExitâDatum)</label><input id="fcl-to" type="date"/></div>
<div>
<label>Anzeige</label>
<select id="closed-page-len">
<option value="5">5</option>
<option value="10">10</option>
<option value="25" selected>25</option>
<option value="50">50</option>
<option value="100">100</option>
<option value="all">Alle</option>
</select>
</div>
</div>
<div class="b table-wrap" style="padding:0">
<table id="tbl-closed">
<thead>
<tr><th>ExitâDatum</th><th>BÃ¶rse</th><th>ID</th><th>Paar</th><th>Side</th><th>Hebel</th><th>Entry</th><th>Exit</th><th>Margin USDT</th><th>PositionsgrÃ¶Ãe (USDT)</th><th>GebÃ¼hr</th><th>Real PnL</th><th>Real %</th><th></th></tr>
</thead>
<tfoot>
<tr>
<td class="t">Gesamtsumme</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
<td class="num bold muted" id="sum-closed-margin"></td><td class="num" id="sum-closed-size"></td><td class="num" id="sum-closed-fee"></td>
<td class="num bold muted" id="sum-closed-real"></td><td class="num" id="sum-closed-pct"></td><td></td><td></td>
</tr>
</tfoot>
<tbody></tbody>
</table>
<div class="pager" id="closed-pager" style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0"></div>
<div class="pager" id="closed-pager-2" style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0"></div>
</div>
<!-- Auswertungen â Reale PnL (geschlossene Trades) -->
<section class="panel" id="tab-closed-analytics" style="display:none">
  <div class="h">
    Auswertungen â Reale PnL (geschlossene Trades)
    <div class="legend"><button class="btn small" id="btn-refresh-chart">ð Aktualisieren</button>
      <div class="chips">
        <button class="btn small" data-crange="1">1D</button>
        <button class="btn small" data-crange="7">7D</button>
        <button class="btn small" data-crange="30">30D</button>
        <button class="btn small" data-crange="all">ALLES</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <label for="closed-year-select" class="t">Jahr</label>
        <select id="closed-year-select" class="btn small" style="padding:6px 10px">
          <option value="all">Alle Jahre</option>
        </select>
      </div>
    </div>
  </div>
  <div class="b" style="padding:0">
    <div id="closed-real-card">
      <div id="closed-real-wrap">
        <canvas id="closed-real-chart"></canvas>
      </div>
      <div class="t" id="closed-real-sub"></div>
    </div>
  </div>

<div class="panel" id="closed-summary-panel" style="margin-top:12px">
  <div class="h"><div>Gesamtsumme (abgeschlossene Trades)</div></div>
  <div class="b" style="padding:12px">
    <div id="closed-sum-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px">
      <div class="card"><div class="t">Margin</div><div class="v" id="sum-closed-margin-box">â</div></div>
      <div class="card"><div class="t">Real PnL</div><div class="v" id="sum-closed-real-box">â</div></div>
    </div>
  </div>
</div>
</section>
</section>
<!-- TAB: Kasse -->
<section class="panel" id="tab-cash" style="display:none">
<div class="h" style="display:flex;justify-content:space-between;align-items:center;"><span>USDTâKasse</span><div style="display:flex;gap:8px"><button class="btn" id="btn-cash-export-page">Export (aktuelle Anzeige)</button><button class="btn" id="btn-cash-export-all">Export (alle Daten)</button><button class="btn danger" id="btn-clear-cash">Alle KasseneintrÃ¤ge lÃ¶schen</button><button class="btn danger" id="btn-clear-trades">ALLE DATEN LÃSCHEN</button></div></div>
<div class="b">
<div class="form-grid">
<div class="col-2"><label>Datum</label><input id="c-date" type="datetime-local"/></div>
<div><label>Betrag (USDT)</label><input id="c-amount" step="0.01" type="number"/></div>
<div class="col-3"><label>Notiz</label><input id="c-note" placeholder="Optional"/></div>
</div>
<div class="chips" style="margin-top:8px">
<div class="btn-group"><button class="btn" id="btn-cash-add">+ USDT hinzufÃ¼gen</button> <button class="btn danger" id="btn-cash-withdraw">â USDT auszahlen</button></div>
</div>

<div>
<label>Suche</label>
<input id="wallet-search" placeholder="Datum, Notiz, Betragâ¦"/>
</div>
<div>
<label>Sortieren</label>
<select id="wallet-sort">
  <option value="date_desc" selected>Datum (neu â alt)</option>
  <option value="date_asc">Datum (alt â neu)</option>
  <option value="month_asc">Monat (Jan â Dez)</option>
  <option value="month_desc">Monat (Dez â Jan)</option>
</select>
</div>
<div>
<label>Anzeige</label>
<select id="cash-page-len">
  <option value="5">5</option>
  <option value="10">10</option>
  <option value="25" selected>25</option>
  <option value="50">50</option>
  <option value="100">100</option>
  <option value="all">Alle</option>
</select>
</div>
<div class="table-wrap" style="margin-top:10px">
<table class="small-table" id="tbl-cash" style="width:100%">
<thead><tr><th>Datum</th><th class="num">Betrag</th><th>Notiz</th><th>Aktion</th></tr></thead>
<tbody></tbody>
</table>
<div class="pager" id="cash-pager" style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0"></div>
</div>
</div>
</section>
<!-- TAB: Chart -->
<section class="panel" id="tab-chart" style="display:none">
<div class="h">TRADINGVIEW Chart <span class="t">Â· VollstÃ¤ndige Werkzeuge &amp; Indikatoren</span></div>
<div class="b" style="padding:0">
<div id="tv-chart" style="height:70vh;"></div>
</div>
</section>
</main>
<footer>
<span>ErgÃ¼n Ãzmen</span>
</footer>
</div>
<!-- Market Modal -->
<div aria-modal="true" class="modal" id="market-modal" role="dialog">
<div class="box">
<div class="h">
<div style="display:flex;gap:8px;align-items:center">
<strong>Marktauswahl</strong>
<input id="mkt-search" placeholder="Suche: BTC, ETH..." style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text)"/>
</div>
<div style="display:flex;gap:8px;align-items:center">
<span class="t">Quelle: Binance miniTicker</span>
<button class="btn" id="mkt-close">SchlieÃen</button>
</div>
</div>
<div class="market-grid" id="market-grid"></div>
</div>
</div>
<script>
var tvWidget = null;

function _tvReady(fn){
  if (tvWidget && typeof tvWidget.onChartReady === 'function') {
    tvWidget.onChartReady(fn);
  } else {
    const i = setInterval(()=>{
      if (tvWidget && typeof tvWidget.onChartReady === 'function') {
        clearInterval(i);
        tvWidget.onChartReady(fn);
      }
    }, 250);
  }
}


// ===== Pagination Helpers (global) =====
const pager = { cash:{len:25,page:1}, open:{len:25,page:1}, closed:{len:25,page:1} };
function parseLen(v){ return (String(v)==='all') ? Infinity : Math.max(1, parseInt(v||'25',10)||25); }
function buildPager(elId, state, total){
  const el = document.getElementById(elId); if(!el) return;
  const per = state.len;
  const pages = (per===Infinity)? 1 : Math.max(1, Math.ceil(total/per));
  state.page = Math.min(Math.max(1, state.page), pages);
  const p = state.page;
  el.innerHTML = '';
  if (pages<=1){ el.style.display='none'; return; } else { el.style.display='flex'; }
  function btn(txt, target, disabled){
    const b = document.createElement('button');
    b.className = 'btn small';
    b.disabled = !!disabled;
    b.textContent = txt;
    if(!disabled){ b.onclick = ()=>{ state.page = target; reRenderByPager(elId); }; }
    el.appendChild(b);
  }
  btn('Â«', 1, p===1);
  btn('â¹', p-1, p===1);
  const span = document.createElement('span');
  span.style.padding='6px 8px'; span.textContent = `Seite ${p} / ${pages}`;
  el.appendChild(span);
  btn('âº', p+1, p===pages);
  btn('Â»', pages, p===pages);
}
function reRenderByPager(elId){
  switch(elId){
    case 'cash-pager': renderCash(); break;
    case 'open-pager': render(); break;
    case 'closed-pager': render(); break;
  }
}

/* ======= State ======= */

// Render guard to avoid flicker during open-trades redraw
window._renderingOpen = false;
let trades = JSON.parse(localStorage.getItem('futures-tracker-trades')||'[]');
let cash   = JSON.parse(localStorage.getItem('futures-tracker-cash')||'[]');
let autoCash = (localStorage.getItem('futures-tracker-auto-cash')||'true')==='true';
// Latest prices: { BTC: {c,o,h,l,v} }
let latestPrices = {};
/* ===== Utilities ===== */
function _sideMatch(side, f){
  const a=(side||'').toString().trim().toUpperCase();
  const b=(f||'').toString().trim().toUpperCase();
  if(!b || b==='ALLE') return true;
  return a===b;
}

const $ = (q)=> document.querySelector(q);
const fmt=(n,d=8)=> (n==null||n==='')? '' : Number(n).toLocaleString('de-DE',{maximumFractionDigits:d});
const fmt2=(n)=> (n==null||n==='')? '' : Number(n).toLocaleString('de-DE',{maximumFractionDigits:2});
const baseAsset=(pair)=> (pair||'').toUpperCase().split('/')[0]?.trim();
const isLong=(t)=> (t.side||'Long')==='Long';
const nowIso = ()=> { const d=new Date(); const off=d.getTimezoneOffset(); const local = new Date(d.getTime()-off*60000); return local.toISOString().slice(0,16); };
function save(){ localStorage.setItem('futures-tracker-trades', JSON.stringify(trades)); }
function saveCash(){ localStorage.setItem('futures-tracker-cash', JSON.stringify(cash)); }
const getCurr=(sym)=> latestPrices[sym]?.c;
/* ===== Theme ===== */
const themeBtn = $('#btn-theme');
function setTheme(next){
  document.documentElement.setAttribute('data-theme', next);
  $('#theme-ico').textContent = next==='dark' ? 'ð' : 'âï¸';
}
themeBtn.onclick = ()=>{
  const next = (document.documentElement.getAttribute('data-theme')==='dark')? 'light' : 'dark';
  setTheme(next);
  try{ createTVChart(); }catch(e){}
};
setTheme(document.documentElement.getAttribute('data-theme')||'dark');
/* ===== Tabs ===== */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=> x.classList.toggle('active', x===b));
    const id = b.dataset.tab;
    document.querySelectorAll('main > section').forEach(s=> s.style.display = (s.id===id? '' : 'none'));
    if(id==='tab-chart'){ setTimeout(()=> createTVChart(), 50); }
    if(id==='tab-cash'){ try{ renderCash(); updateDashboard(); }catch(e){} }
  });
});
/* ===== Trade ID ===== */
function nextTradeId(){
  try{
    const nums = trades.map(t=>{
      const s = (t.id||'').toString().trim();
      const n = parseInt(s,10);
      return isFinite(n)? n : 0;
    });
    const max = nums.length? Math.max(...nums) : 0;
    const nxt = Math.max(1, max+1);
    return String(nxt).padStart(3,'0');
  }catch(e){ return '001'; }
}
/* ===== Ensure sizes ===== */
function ensureSizes(t){
  const entry=Number(t.entry||0);
  let sizeUSDT=t.sizeUSDT!==''&&t.sizeUSDT!=null?Number(t.sizeUSDT):'';
  let sizeCoin=t.sizeCoin!==''&&t.sizeCoin!=null?Number(t.sizeCoin):'';
  if(sizeUSDT===''&&sizeCoin!==''&&entry) sizeUSDT=sizeCoin*entry;
  if(sizeCoin===''&&sizeUSDT!==''&&entry) sizeCoin=sizeUSDT/entry;
  return {sizeUSDT,sizeCoin};
}
/* ===== PnL calc ===== */
function getEffLev(t){
  const side=(t.side||'Long');
  const levRaw=Number(t.leverage||0);
  if (side==='Spot' || levRaw<=0) return 1; // Spot rechnet ohne Hebel
  return Math.max(1, levRaw);
}

function calcUnreal(t){
  if((t.status||'')!=='Offen') return {pnl:null,pct:null,price:null};
  const entry=Number(t.entry||0);
  const {sizeUSDT,sizeCoin}=ensureSizes(t);
  const lev=getEffLev(t);
  const sym=baseAsset(t.pair);
  const curr=getCurr(sym);
  if(!entry||!sizeCoin||!curr) return {pnl:null,pct:null,price:curr||null};
  const raw=isLong(t)?(curr-entry)*sizeCoin*lev:(entry-curr)*sizeCoin*lev;
  const pct=isLong(t)?((curr/entry-1)*100*lev):((entry/curr-1)*100*lev);
  const pnl=raw-Number(t.fee||0);
  return {pnl,pct,price:curr};
}
function calcReal(t){
  if((t.status||'')!=='Geschlossen') return {pnl:null};
  if (typeof t.realFixed === 'number' && !Number.isNaN(t.realFixed)) {
    return { pnl: t.realFixed };
  }
  const entry=Number(t.entry||0), exit=Number(t.exit||0);
  const {sizeCoin}=ensureSizes(t);
  const lev=getEffLev(t);
  if(!entry||!exit||!sizeCoin) return {pnl:null};
  const raw=isLong(t)?(exit-entry)*sizeCoin*lev:(entry-exit)*sizeCoin*lev;
  return { pnl: raw - Number(t.fee||0) };
}
/* ===== Dashboard ===== */
function capAt(dateStr){
  const cashSum=cash.reduce((a,c)=>{ if(c.date && c.amount && c.date.slice(0,10)<=dateStr) return a+Number(c.amount); return a; },0);
  const rPnl=trades.reduce((a,t)=>{ if(t.status==='Geschlossen' && t.closedAt && t.closedAt.slice(0,10)<=dateStr){ const r=calcReal(t).pnl; return a+(r||0); } return a; },0);
  return cashSum + rPnl;
}
function dateAdd(d, days){ const dt=new Date(d); dt.setDate(dt.getDate()+days); return dt.toISOString().slice(0,10); }
function monthStartStr(d){ const dt=new Date(d); dt.setDate(1); return dt.toISOString().slice(0,10); }
function updateDashboard(){
  let today=0, month=0, open=0, posVal=0, posBase=0;
  const now=new Date(); const todayIso=now.toISOString().slice(0,10); const mstr=now.toISOString().slice(0,7);
  const monthStart=monthStartStr(now); const prevDay=dateAdd(todayIso,-1); const prevMonthEnd=dateAdd(monthStart,-1);
  trades.forEach(t=>{
    const real=calcReal(t).pnl; const unreal=calcUnreal(t).pnl;
    if(t.status==='Geschlossen' && real!=null){
      const exitDay=(t.closedAt||'').slice(0,10);
      if(exitDay===todayIso) today+=real;
      if((t.closedAt||'').slice(0,7)===mstr) month+=real;
    }
    if(t.status==='Offen'){
      // Offene PnL separat fÃ¼r Anzeige (Offene PnL & Positionswert), aber NICHT fÃ¼rs Gesamtkapital addieren
      if(unreal!=null) open += (unreal||0) + Number(t.gridPnl||0);

      const {sizeUSDT,sizeCoin}=ensureSizes(t);
      const sym=baseAsset(t.pair);
      const curr=getCurr(sym);

      // Positionswert (Anzeige) bleibt wie gehabt: Margin + Unreal + Grid ODER sizeCoin*curr
      if(sizeUSDT!=='' && sizeUSDT!=null){
        const u = Number(unreal||0);
        const grid = Number(t.gridPnl||0);
        posVal += Number(sizeUSDT) + u + grid;
      } else if(sizeCoin && curr){
        posVal += sizeCoin*curr;
      }

      // NEU: Basiswert der offenen Positionen OHNE offenen PnL (nur eingesetzte Margin).
      // Wenn Margin fehlt, approximieren wir mit sizeCoin*entry (konservativ, ohne PnL).
      const entry=Number(t.entry||0);
      if(sizeUSDT!=='' && sizeUSDT!=null){
        posBase += Number(sizeUSDT);
      } else if(sizeCoin && entry){
        posBase += sizeCoin*entry;
      }
    }
  });
  const cashSum = cash.reduce((a,c)=> a + Number(c.amount||0), 0);
  const total = posBase + cashSum;
  const baseToday = capAt(prevDay) || 0; const baseMonth = capAt(prevMonthEnd) || 0;
  const pctToday = baseToday? (today/baseToday*100): null; const pctMonth = baseMonth? (month/baseMonth*100): null;
  $('#dash-today').textContent=(today>=0?'+':'')+fmt2(today)+' USDT';
  $('#dash-month').textContent=(month>=0?'+':'')+fmt2(month)+' USDT';
  $('#dash-open').textContent=(open>=0?'+':'')+fmt2(open)+' USDT';
  $('#dash-posval').textContent=fmt2(posVal)+' USDT';
  $('#dash-cash').textContent=fmt2(cashSum)+' USDT';
  $('#dash-total').textContent=fmt2(total)+' USDT';
  $('#dash-today-pct').textContent = pctToday==null? '' : ((pctToday>=0?'+':'')+fmt2(pctToday)+'% ggÃ¼. Vortag');
  $('#dash-month-pct').textContent = pctMonth==null? '' : ((pctMonth>=0?'+':'')+fmt2(pctMonth)+'% ggÃ¼. Vormonatsende');
}
/* ===== WebSocket: Binance miniTicker ===== */
let ws=null, wsSymbols=new Set(), wsReconnectAttempts=0, wsReconnectTimer=null, wsHeartbeatTimer=null, wsLastMsgTs=0;
function symbolsToCombinedStream(symbols){
  const streams=symbols.map(s=> (s+'USDT').toLowerCase()+"@miniTicker").join('/');
  return streams?`wss://stream.binance.com:9443/stream?streams=${streams}`:null;
}
function closeWS(){
  try{ if(ws){ ws.onopen=ws.onclose=ws.onerror=ws.onmessage=null; ws.close(); } }catch(e){}
  ws=null;
  if(wsReconnectTimer){clearTimeout(wsReconnectTimer);wsReconnectTimer=null;}
  if(wsHeartbeatTimer){clearInterval(wsHeartbeatTimer);wsHeartbeatTimer=null;}
}
function startHeartbeat(){
  if(wsHeartbeatTimer) clearInterval(wsHeartbeatTimer);
  wsHeartbeatTimer=setInterval(()=>{ if(Date.now()-wsLastMsgTs>30000){ closeWS(); scheduleReconnect(); } },5000);
}
function scheduleReconnect(){
  if(wsReconnectTimer) return;
  const wait=Math.min(30000, 1000*Math.pow(2, wsReconnectAttempts||0));
  wsReconnectAttempts=Math.min(wsReconnectAttempts+1,10);
  wsReconnectTimer=setTimeout(()=>{ wsReconnectTimer=null; render(); openWS(); }, wait);
}
function openWS(){
  closeWS();
  const symbols=[...new Set(trades.map(t=>baseAsset(t.pair)).filter(Boolean))];
  if(symbols.length===0){ $('#last-update').textContent='WS inaktiv'; return; }
  wsSymbols=new Set(symbols);
  const url=symbolsToCombinedStream(symbols);
  if(!url){ $('#last-update').textContent='WS inaktiv'; return; }
  wsLastMsgTs=Date.now();
  ws=new WebSocket(url);
  ws.onopen=()=>{ $('#last-update').textContent='Live (Binance WS)'; wsReconnectAttempts=0; startHeartbeat(); };
  ws.onclose=()=>{ $('#last-update').textContent='WS getrennt â Reconnectâ¦'; scheduleReconnect(); };
  ws.onerror=()=>{ $('#last-update').textContent='WS-Fehler â Reconnectâ¦'; scheduleReconnect(); };
  let lastRender=0; const throttleMs=400;
  ws.onmessage=(ev)=>{
    wsLastMsgTs=Date.now();
    try{
      const msg=JSON.parse(ev.data);
      const d=msg.data||msg;
      const s=(d.s||'').toUpperCase();
      if(!s.endsWith('USDT')) return;
      const base=s.replace('USDT','');
      const obj={ c: parseFloat(d.c), o: parseFloat(d.o), h: parseFloat(d.h), l: parseFloat(d.l), v: parseFloat(d.v) };
      if(!isFinite(obj.c)) return;
      latestPrices[base]=obj;
      updatePairPriceHint();
      const now=Date.now();
      if(now-lastRender>throttleMs){ lastRender=now; render(); }
    }catch(e){}
  };
}
/* ===== Market modal with miniTicker feed ===== */
let wsMkt=null, wsMktSymbols=new Set();
const TOP_BASES=['BTC','ETH','SOL','BNB','XRP','ADA','AVAX','DOGE','TON','TRX','LINK','LTC','BCH','DOT','MATIC','HBAR','NEAR','ATOM','OP','ARB'];
function openWSMarket(symbols){
  closeWSMarket();
  const url=symbolsToCombinedStream(symbols);
  if(!url) return;
  wsMktSymbols=new Set(symbols);
  wsMkt=new WebSocket(url);
  wsMkt.onmessage=(ev)=>{
    try{
      const msg=JSON.parse(ev.data);
      const d=msg.data||msg;
      const s=(d.s||'').toUpperCase();
      if(!s.endsWith('USDT')) return;
      const base=s.replace('USDT','');
      latestPrices[base] = { c: parseFloat(d.c), o: parseFloat(d.o), h: parseFloat(d.h), l: parseFloat(d.l), v: parseFloat(d.v) };
      buildMarketGrid();
    }catch(e){}
  };
}
function closeWSMarket(){ try{ if(wsMkt){ wsMkt.onmessage=null; wsMkt.close(); } }catch(e){} wsMkt=null; wsMktSymbols.clear(); }
function updatePairPriceHint(){
  const p=$('#f-pair').value.trim().toUpperCase();
  const base=p.split('/')[0]||'';
  const price=getCurr(base);
  $('#pair-price').textContent = (price? fmt(price):'â');
  if(price && !$('#f-entry').value){ $('#f-entry').value=price; }
}
function setPairFromBase(base){
  if(!base) return;
  const field=$('#f-pair');
  if(field){
    field.value=(base.toUpperCase()+'/USDT');
    const p=getCurr(base.toUpperCase());
    if(p){ $('#f-entry').value=p; }
    updatePairPriceHint();
    updateTvLink();
  }
}
function buildPairChips(){
  const cont=document.getElementById('pair-chips');
  if(!cont) return;
  cont.innerHTML='';
  TOP_BASES.forEach(b=>{
    const s=document.createElement('span');
    s.className='chip'; s.textContent=b;
    s.onclick=()=>setPairFromBase(b);
    cont.appendChild(s);
  });
  const dl=document.getElementById('pairs-list');
  if(dl){
    dl.innerHTML='';
    TOP_BASES.forEach(b=>{ const o=document.createElement('option'); o.value=`${b}/USDT`; dl.appendChild(o); });
  }
}
buildPairChips();
function openMarketModal(){
  const m=$('#market-modal');
  m.classList.add('open');
  $('#mkt-search').value=''; $('#mkt-search').focus();
  const bases=[...new Set([...TOP_BASES])];
  openWSMarket(bases);
  buildMarketGrid();
}
function closeMarketModal(){
  $('#market-modal').classList.remove('open'); closeWSMarket();
}
function buildMarketGrid(){
  const q = ($('#mkt-search').value||'').trim().toUpperCase();
  const cont=$('#market-grid'); cont.innerHTML='';
  const list=[...TOP_BASES];
  list.filter(b=>!q || b.includes(q)).forEach(b=>{
    const p=latestPrices[b]?.c; const o=latestPrices[b]?.o;
    const chg=(p&&o)? ((p/o-1)*100) : null;
    const card=document.createElement('div');
    card.className='mkt';
    card.onclick=()=>{ setPairFromBase(b); closeMarketModal(); };
    card.innerHTML=`
      <div class="row">
        <div style="display:flex;gap:8px;align-items:center"><strong>${b}/USDT</strong> <span class="badge ${chg==null?'':(chg>=0?'pos':'neg')}">${chg==null?'â':((chg>=0?'+':'')+fmt2(chg)+'%')}</span></div>
      </div>
      <div class="row" style="margin-top:4px"><div class="t">Letzter</div><div>${p?fmt(p):'â'}</div></div>
      <div class="row" style="margin-top:4px"><a class="t" target="_blank" href="https://www.tradingview.com/chart/?symbol=BINANCE:${b}USDT">TRADINGVIEW Ã¶ffnen</a><span class="t">High/Low 24h: ${latestPrices[b]?.h?fmt(latestPrices[b].h):'â'} / ${latestPrices[b]?.l?fmt(latestPrices[b].l):'â'}</span></div>
    `;
    cont.appendChild(card);
  });
}
$('#btn-market').onclick=openMarketModal;
$('#mkt-close').onclick=closeMarketModal;
$('#mkt-search').oninput=buildMarketGrid;
$('#market-modal').addEventListener('click',(e)=>{ if(e.target.id==='market-modal') closeMarketModal(); });
/* ===== Form helpers ===== */
function readForm(){
  const gridVal = Number(($('#f-grid').value||0));
  return {
    date: $('#f-date').value,
    exchange: $('#f-exchange').value,
    id: ($('#f-id').value||'').trim(),
    pair: $('#f-pair').value.trim().toUpperCase(),
    side: $('#f-side').value,
    leverage: ($('#f-side').value==='Spot'? 0 : Number($('#f-lev').value||1)),
    entry: Number($('#f-entry').value||0),
    sizeUSDT: $('#f-size-usdt').value===''? '' : Number($('#f-size-usdt').value),
    sizeCoin: $('#f-size-coin').value===''? '' : Number($('#f-size-coin').value),
    fee: Number($('#f-fee').value||0),
    status: $('#f-status').value,
    exit: $('#f-exit').value===''? '' : Number($('#f-exit').value),
    closedAt: $('#f-closed').value || '',
    gridPnl: gridVal,
    note: $('#f-note').value.trim()
  };
}
function loadToForm(i){
  const t=trades[i];
  $('#edit-index').value=i;
  $('#btn-add').style.display='none';
  $('#btn-save').style.display='';
  $('#btn-cancel').style.display='';
  $('#f-date').value=t.date||nowIso();
  $('#f-exchange').value = t.exchange || '';
  $('#f-id').value=t.id||'';
  $('#f-pair').value=t.pair||'';
  $('#f-side').value=t.side||'Long';
  $('#f-lev').value=t.leverage||5;
  $('#f-entry').value=t.entry||'';
  $('#f-size-usdt').value=(t.sizeUSDT===''?'':t.sizeUSDT)||'';
  $('#f-size-coin').value=(t.sizeCoin===''?'':t.sizeCoin)||'';
  $('#f-fee').value=t.fee||0;
  $('#f-status').value=t.status||'Offen';
  $('#f-exit').value=(t.exit===''?'':t.exit)||'';
  $('#f-closed').value=t.closedAt||'';
  $('#f-note').value=t.note||'';
  updatePairPriceHint();
  updateTvLink();
  try{ document.getElementById('f-side').dispatchEvent(new Event('change')); }catch(e){}

}
function clearForm(){
  ['f-date','f-pair','f-entry','f-size-usdt','f-size-coin','f-fee','f-exit','f-closed','f-note','f-id'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  $('#f-lev').value=5;
  $('#f-exchange').value = '';
  $('#f-side').value='Long';
  $('#f-status').value='Offen';
  $('#edit-index').value='';
  $('#btn-add').style.display='';
  $('#btn-save').style.display='none';
  $('#btn-cancel').style.display='none';
  $('#f-date').value=nowIso();
  $('#f-id').value=nextTradeId();
  updatePairPriceHint();
  updateTvLink();
  try{ document.getElementById('f-side').dispatchEvent(new Event('change')); }catch(e){}

}
/* ===== AutoâKasse & linking by ID ===== */
function extractIdFromNote(note){




  try{
    const m = String(note||'').match(/\[ID\s*(\d+)\]/i);
    if(!m) return null;
    return String(m[1]).padStart(3,'0');
  }catch(e){ return null; }
}
function removeCashById(id){
  if(!id) return 0;
  let removed = 0;
  for(let i=cash.length-1;i>=0;i--){
    if(extractIdFromNote(cash[i]?.note) === id){
      cash.splice(i,1);
      removed++;
    }
  }
  if(removed) saveCash();
  return removed;
}

function deleteEverywhereById(id){
  if(!id) return {trades:0, cash:0};
  let tRemoved = 0, cRemoved = 0;
  try { tRemoved = removeTradesById(id) || 0; } catch(e){ console.error('removeTradesById failed', e); }
  try { cRemoved = removeCashById(id)   || 0; } catch(e){ console.error('removeCashById failed', e); }
  try { save(); } catch(e){}
  try { saveCash(); } catch(e){}
  try { render(); } catch(e){}
  try { renderCash(); } catch(e){}
  try { updateDashboard(); } catch(e){}
  try { if (typeof updateOpenMarginSum==='function') updateOpenMarginSum(); } catch(e){}
  try { if (typeof updateClosedSums==='function') updateClosedSums(); } catch(e){}
  try { if (typeof ensureWsMatchesSymbols==='function') ensureWsMatchesSymbols(); } catch(e){}
  return {trades:tRemoved, cash:cRemoved};
}
function removeTradesById(id){
  if(!id) return 0;
  let removed = 0;
  for(let i=trades.length-1;i>=0;i--){
    if(String(trades[i]?.id||'').padStart(3,'0') === id){
      trades.splice(i,1);
      removed++;
    }
  }
  if(removed) save();
  return removed;
}
function addCash(amount, note, date){
  const n = Number(amount||0);
  let noteText = (note==null ? '' : String(note).trim());
  if(!noteText){
    // Traditionell: positive BetrÃ¤ge = Einzahlung, negative = Auszahlung
    noteText = n >= 0 ? 'Einzahlung' : 'Auszahlung';
  }
  cash.push({date: date||nowIso(), amount: n, note: noteText});
  saveCash(); renderCash(); updateDashboard();
}
/* ===== Add/Save logic ===== */
function onAddOrSave(prev){
  let t=readForm();
  if(t.status==='Geschlossen'){
    if(!t.closedAt){ alert('ExitâDatum ist Pflicht.'); return null; }
    const tmp={...(prev||t), ...t, status:'Offen'};
    const u=calcUnreal(tmp);
    const grid=Number(t.gridPnl||0);
    if(u && u.pnl!=null){
      if(u.price!=null && !t.exit) t.exit=u.price;
      t.realFixed = u.pnl + grid;
    } else {
      const e=Number(t.entry||0), x=Number(t.exit||0), {sizeCoin}=ensureSizes(t), lev=Math.max(1,Number(t.leverage||1));
      if(e&&x&&sizeCoin){
        const raw=isLong(t)?(x-e)*sizeCoin*lev:(e-x)*sizeCoin*lev;
        t.realFixed = raw - Number(t.fee||0) + grid;
      }
    }
  } else {
    delete t.realFixed;
    t.closedAt='';
  }
  return t;
}
/* ===== Render tables ===== */
function render(){
  // Filters
  const q=($('#ftr-q').value||'').toLowerCase();
  const fx=$('#ftr-exchange').value||'';
  const fs=$('#ftr-status').value||'';
  const fside=$('#ftr-side').value||'';
  const dFrom=$('#ftr-from').value? new Date($('#ftr-from').value+'T00:00:00') : null;
  const dTo=$('#ftr-to').value? new Date($('#ftr-to').value+'T23:59:59') : null;
  const filterFn = (t)=> ((!fx || fx==='Alle') ? true : (t.exchange===fx)) && ((!fs || fs==='Alle') ? true : (t.status===fs)) && _sideMatch(t.side, fside) && ((!q || t.pair?.toLowerCase().includes(q) || (t.id||'').toLowerCase().includes(q))) && (dFrom? new Date((t.closedAt||t.date))>=dFrom : true) && (dTo? new Date((t.closedAt||t.date))<=dTo : true);
  let openRows = trades.filter(t=>t.status==='Offen').filter(filterFn);
  let closedRows = trades.filter(t=>t.status==='Geschlossen').filter(filterFn);
  // --- Pagination Open ---
  const perOpen = pager.open.len; const totOpen = openRows.length; buildPager('open-pager', pager.open, totOpen);
  if(perOpen!==Infinity){ const st=Math.max(0,(pager.open.page-1)*perOpen); openRows = openRows.slice(st, st+perOpen); }
  // --- Pagination Closed ---
  const perClosed = pager.closed.len; const totClosed = closedRows.length; buildPager('closed-pager', pager.closed, totClosed);
  if(perClosed!==Infinity){ const st2=Math.max(0,(pager.closed.page-1)*perClosed); closedRows = closedRows.slice(st2, st2+perClosed); }
  // Offene Tabelle
  const tb=$('#tbl tbody'); if(tb){
  window._renderingOpen = true;
  const frag=document.createDocumentFragment();
  openRows.forEach((t)=>{
const idx = trades.indexOf(t);
    const {sizeUSDT,sizeCoin}=ensureSizes(t);
    const u=calcUnreal(t); const r=calcReal(t);
    const curr=u.price;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${t.date||''}</td>
      <td>${t.exchange||''}</td>
      <td>${t.id||''}</td>
      <td>${t.pair||''}</td>
      <td>${t.side==='Long'?'<span class="pill open">â² Long</span>':(t.side==='Short'?'<span class="pill open">â¼ Short</span>':'<span class="pill open">â¢ Spot</span>')}</td>
      <td class="num">${fmt(t.leverage,2)}</td>
      <td class="num">${fmt(t.entry)}</td>
      <td class="num">${fmt(curr)}</td>
      <td class="num">${fmt2(sizeUSDT)}</td><td class="num">${fmt2(sizeUSDT * Number(t.leverage||1))}</td>
      <td class="num">${fmt(sizeCoin)}</td>
      <td class="num">${fmt2(t.fee)}</td>
      <td><span class="pill open">Offen</span></td>
      <td class="num">${fmt(t.exit)}</td>
      <td>${t.closedAt||''}</td>
      <td class="num">${fmt2(t.gridPnl||0)}</td>
      <td class="num ${( (u.pnl+(Number(t.gridPnl||0)))>=0 ? 'pos':'neg')}">${((u.pnl+(Number(t.gridPnl||0)))>=0?'+':'')+fmt2(u.pnl+(Number(t.gridPnl||0)))}</td>
      <td class="num ${u.pct==null?'':(u.pct>=0?'pos':'neg')}">${u.pct==null?'':(u.pct>=0?'+':'')+fmt2(u.pct)+'%'}</td>
      <td class="num ${r.pnl==null?'':(r.pnl>=0?'pos':'neg')}">${r.pnl==null?'':(r.pnl>=0?'+':'')+fmt2(r.pnl)}</td>
      <td>
        <button class="btn small" data-edit="${idx}">Bearbeiten</button>
        <button class="btn small danger" data-del="${idx}">LÃ¶schen</button>
      </td>
    `;
    frag.appendChild(tr);
  });
  tb.replaceChildren(frag);
  window._renderingOpen = false;
  if (typeof window.recalcDomMarginSum === 'function') { try{ window.recalcDomMarginSum(); }catch(_){}}
}

  // Geschlossene Tabelle
  const tbC=$('#tbl-closed tbody'); if(tbC){ tbC.innerHTML=''; }
  closedRows.forEach((t)=>{
    const idx=trades.indexOf(t);
    const {sizeUSDT,sizeCoin}=ensureSizes(t);
    const r=calcReal(t);
    const rPct = (sizeUSDT && r.pnl!=null) ? (r.pnl/sizeUSDT*100) : null;
    const cls = (r.pnl==null? 'row-zero' : (r.pnl>=0? 'row-pos' : 'row-neg'));
    const tr=document.createElement('tr');
    tr.className = cls;
    tr.innerHTML=`
      <td>${t.closedAt||''}</td>
      <td>${t.exchange||''}</td>
      <td>${t.id||''}</td>
      <td>${t.pair||''}</td>
      <td>${t.side==='Long'?'<span class="pill closed">â² Long</span>':(t.side==='Short'?'<span class="pill closed">â¼ Short</span>':'<span class="pill closed">â¢ Spot</span>')}</td>
      <td class="num">${fmt(t.leverage,2)}</td>
      <td class="num">${fmt(t.entry)}</td>
      <td class="num">${fmt(t.exit)}</td>
      <td class="num">${fmt2(sizeUSDT)}</td>
      <td class="num">${fmt(sizeCoin)}</td>
      <td class="num">${fmt2(t.fee)}</td>
      <td class="num ${r.pnl==null?'':(r.pnl>=0?'pos':'neg')}">${r.pnl==null?'':(r.pnl>=0?'+':'')+fmt2(r.pnl)}</td>
      <td class="num ${rPct==null?'':(rPct>=0?'pos':'neg')}">${rPct==null?'':(rPct>=0?'+':'')+fmt2(rPct)+'%'}</td>
      <td>
        <button class="btn small" data-edit="${idx}">Bearbeiten</button>
        <button class="btn small danger" data-del="${idx}">LÃ¶schen</button>
      </td>
    `;
    tbC && tbC.appendChild(tr);
  });
// --- Gesamtsummen fÃ¼r Abgeschlossene Trades ---
(function(){
  try {
    let sumMargin = 0, sumSize = 0, sumFee = 0, sumReal = 0;
    let pctVals = [];
    closedRows.forEach((t)=>{
      const sizes = ensureSizes(t);
      const sizeUSDT = sizes.sizeUSDT;
      const r = calcReal(t);
      const rPct = (sizeUSDT && r.pnl!=null) ? (r.pnl/sizeUSDT*100) : null;
      sumMargin += Number(t.margin||0);
      sumSize   += Number(sizeUSDT||0);
      sumFee    += Number(t.fee||0);
      sumReal   += Number(r.pnl||0);
      if (rPct!=null && isFinite(rPct)) pctVals.push(rPct);
    });
    const $ = (sel)=>document.querySelector(sel);
    const elM = $('#closed-sum-margin');
    const elS = $('#closed-sum-size');
    const elF = $('#closed-sum-fee');
    const elR = $('#closed-sum-real');
    const elP = $('#closed-avg-pct');
    if (elM) elM.textContent = fmt2(sumMargin) + ' USDT';
    if (elS) elS.textContent = fmt2(sumSize) + ' USDT';
    if (elF) elF.textContent = fmt2(sumFee) + ' USDT';
    if (elR) {
      elR.textContent = (sumReal>=0?'+':'') + fmt2(sumReal) + ' USDT';
      elR.classList.remove('pos','neg');
      if (sumReal>0) elR.classList.add('pos');
      if (sumReal<0) elR.classList.add('neg');
    }
    if (elP) {
      const avg = pctVals.length? (pctVals.reduce((a,b)=>a+b,0) / pctVals.length) : 0;
      elP.textContent = (avg>=0?'+':'') + fmt2(avg) + ' %';
      elP.classList.remove('pos','neg');
      if (avg>0) elP.classList.add('pos');
      if (avg<0) elP.classList.add('neg');
    }
  } catch (e) { /* no-op */ }
})();
// Delete & Edit handlers
  document.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = ()=>{
      const idx = Number(b.dataset.del);
      const t = trades[idx];
      if(!t) return;
      const id = (t.id? String(t.id).padStart(3,'0') : null);
      if(id){
        const msg = `Wirklich ALLE EintrÃ¤ge mit der ID ${id} lÃ¶schen?
`+
                    `${t?.pair||''} ${t?.side||''} @ ${t?.entry||''}
`+
                    `Hinweis: Dazu gehÃ¶ren Trade(s) (offen/geschlossen) und zugehÃ¶rige KasseâBuchungen.`;
        if(!confirm(msg)) return;
        deleteEverywhereById(id);
        return;
      }
      // Fallback: kein ID-Wert vorhanden â nur diesen Datensatz entfernen
      const confirmMsg = `Diesen Trade wirklich lÃ¶schen?
${t?.pair||''} ${t?.side||''} @ ${t?.entry||''}`;
      if(!confirm(confirmMsg)) return;
      trades.splice(idx,1);
      save(); renderCash(); updateDashboard(); render(); ensureWsMatchesSymbols();
    };
  });
  document.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> loadToForm(Number(b.dataset.edit)));
  updateDashboard();
  updateOpenMarginSum();
  updateClosedSums();
}
/* ===== Exports ===== */
function toCSV(rows){
  if(!rows || !rows.length) return '';
  const keys = Object.keys(rows[0]);
  const esc = v => {
    if (v==null) return '';
    const s = String(v);
    if (/[",;\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  const head = keys.join(';');
  const body = rows.map(r => keys.map(k => esc(r[k])).join(';')).join('\\n');
  return head + '\\n' + body;
}
function downloadBlob(filename, mime, data){
  const blob = new Blob([data], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function exportXLSXOrCSV(rows, sheetName, baseName){
  if(!rows || !rows.length){ alert('Nichts zu exportieren.'); return; }
  const d = new Date().toISOString().slice(0,10);
  const xlsxName = baseName.replace(/\\.xlsx$/i,'') + '_' + d + '.xlsx';
  const csvName  = baseName.replace(/\\.xlsx$/i,'') + '_' + d + '.csv';
  if(window.XLSX){
    try{
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, sheetName || 'Daten');
      XLSX.writeFile(wb, xlsxName);
      return;
    }catch(e){ /* fallback to CSV */ }
  }
  const csv = toCSV(rows);
  downloadBlob(csvName, 'text/csv;charset=utf-8', csv);
}
function tradesToExportRows(){
  return trades.map(t=>{
    const {sizeUSDT,sizeCoin}=ensureSizes(t);
    const u=calcUnreal(t); const r=calcReal(t);
    const rPct = (sizeUSDT && r.pnl!=null) ? (r.pnl/sizeUSDT*100) : '';
    return {
      Datum_Open:t.date, Datum_Exit:t.closedAt||'', Boerse:t.exchange, ID:t.id, Paar:t.pair, Richtung:t.side, Hebel:t.leverage,
      Einstiegspreis:t.entry, Aktuell:(u.price!=null?u.price:''), Margin_USDT: sizeUSDT===''? '' : Number(sizeUSDT),
      Groesse_Coin: sizeCoin===''? '' : Number(sizeCoin), Gebuehr_USDT:Number(t.fee||0), Grid_PnL_USDT:Number(t.gridPnl||0),
      Status:t.status, Ausstiegspreis: t.exit===''? '' : Number(t.exit), Unreal_PnL_USDT: u.pnl==null? '' : Number(u.pnl),
      Unreal_PnL_Inkl_Grid_USDT: u.pnl==null? '' : Number(u.pnl + Number(t.gridPnl||0)),
      Unreal_PnL_Prozent: u.pct==null? '' : Number(u.pct), Real_PnL_USDT: r.pnl==null? '' : Number(r.pnl),
      Real_PnL_Prozent: rPct===''? '' : Number(rPct), Notiz:t.note
    };
  });
}
function closedTradesToExportRows(){
  return trades
    .filter(t => t.status === 'Geschlossen')
    .map(t => {
      const { sizeUSDT, sizeCoin } = ensureSizes(t);
      const r = calcReal(t);
      const rPct = (sizeUSDT && r.pnl != null) ? (r.pnl / sizeUSDT * 100) : null;
      return {
        Exit_Datum: t.closedAt || '', Boerse: t.exchange || '', ID: t.id || '', Paar: t.pair || '', Richtung: t.side || '',
        Hebel: Number(t.leverage || 0), Entry: t.entry===''?'':Number(t.entry||0), Exit: t.exit===''?'':Number(t.exit||0),
        Margin_USDT: (sizeUSDT===''?'':Number(sizeUSDT)), Coin: (sizeCoin===''?'':Number(sizeCoin)), Gebuehr_USDT: Number(t.fee || 0),
        Real_PnL_USDT: (r.pnl==null?'':Number(r.pnl)), Real_PnL_Prozent: (rPct==null?'':Number(rPct)), Notiz: t.note || ''
      };
    });
}
$('#btn-export-xlsx').onclick = ()=>{
  try{ const rows=tradesToExportRows(); exportXLSXOrCSV(rows,'Trades','trades.xlsx'); }
  catch(e){ alert('Export fehlgeschlagen: '+e.message); }
};
$('#btn-export-closed-xlsx').onclick = ()=>{
  try{ const rows=closedTradesToExportRows(); exportXLSXOrCSV(rows,'Abgeschlossene','closed_trades.xlsx'); }
  catch(e){ alert('Export fehlgeschlagen: '+e.message); }
};
/* ===== Backup/Restore/Clear ===== */
function doBackup(){
  const payload={ trades, cash, autoCash };
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='futures_tracker_backup_'+new Date().toISOString().slice(0,10)+'.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function doRestore(file){
  const reader=new FileReader();
  reader.onload=(e)=>{
    try{
      const obj=JSON.parse(e.target.result||'{}');
      if(Array.isArray(obj.trades)) trades=obj.trades;
      if(Array.isArray(obj.cash)) cash=obj.cash;
      if(typeof obj.autoCash!=='undefined') autoCash=!!obj.autoCash;
      localStorage.setItem('futures-tracker-trades', JSON.stringify(trades));
      localStorage.setItem('futures-tracker-cash', JSON.stringify(cash));
      localStorage.setItem('futures-tracker-auto-cash', String(autoCash));
      $('#auto-cash').checked=autoCash;
      render(); renderCash(); ensureWsMatchesSymbols(); alert('Wiederherstellung abgeschlossen.');
    }catch(err){ alert('Fehler beim Import: '+err.message); }
  };
  reader.readAsText(file);
}
$('#btn-backup').onclick=doBackup;
$('#btn-restore').onclick=()=> $('#restore-file').click();
$('#restore-file').addEventListener('change', (e)=>{ const f=e.target.files&&e.target.files[0]; if(f) doRestore(f); e.target.value=''; });
/* ===== Open/Save/Add/Duplicate ===== */
$('#btn-add').onclick=()=>{
  const t=onAddOrSave(null); if(!t) return;
  if(!t.id){ t.id = nextTradeId(); }
  trades.push(t); save();
  if(autoCash){
    const {sizeUSDT}=ensureSizes(t);
    const idTxt = t.id? (' [ID '+t.id+']') : '';
    if(t.status==='Offen' && sizeUSDT!==''){
      addCash(-Number(sizeUSDT),'Auto: Trade geÃ¶ffnet'+idTxt+' ('+(t.pair||'')+')', t.date||nowIso());
    }
    if(t.status==='Geschlossen'){
      const r=calcReal(t).pnl||0;
      addCash(Number(sizeUSDT||0)+Number(r||0),'Auto: Trade geschlossen'+idTxt+' ('+(t.pair||'')+')', t.closedAt||nowIso());
    }
  }
  clearForm(); render(); ensureWsMatchesSymbols(); /* filters preserved */
};
$('#btn-save').onclick=()=>{
  const i=Number($('#edit-index').value);
  if(Number.isNaN(i)||i===''||!trades[i]) return;
  const prev=trades[i];
  const t=onAddOrSave(prev); if(!t) return;
  if(!t.id){ t.id = prev.id || nextTradeId(); }
  trades[i]=t; save();
  if(autoCash && prev.status!==t.status){
    if(prev.status==='Offen' && t.status==='Geschlossen'){
      const {sizeUSDT}=ensureSizes(t);
      const r=calcReal(t).pnl||0;
      const idTxt = t.id? (' [ID '+t.id+']') : '';
      addCash(Number(sizeUSDT||0)+Number(r||0),'Auto: Trade geschlossen'+idTxt+' ('+(t.pair||'')+')', t.closedAt||nowIso());
    } else if(prev.status==='Geschlossen' && t.status==='Offen'){
      const {sizeUSDT}=ensureSizes(t);
      const idTxt = t.id? (' [ID '+t.id+']') : '';
      if(sizeUSDT!==''){
        addCash(-Number(sizeUSDT),'Auto: Trade wieder geÃ¶ffnet'+idTxt+' ('+(t.pair||'')+')', t.date||nowIso());
      }
    }
  }
  clearForm(); render(); ensureWsMatchesSymbols(); /* filters preserved */
};
$('#btn-cancel').onclick=clearForm;
$('#btn-duplicate').onclick=()=>{
  if(!trades.length){ alert('Keine Trades vorhanden.'); return; }
  const t=trades[trades.length-1];
  const copy={...t, id:'', date: nowIso(), status:'Offen', exit:'', closedAt:'', realFixed:undefined, note:t.note? (t.note+' (dup)') : '' };
  $('#edit-index').value='';
  $('#btn-add').style.display='';
  $('#btn-save').style.display='none';
  $('#btn-cancel').style.display='none';
  $('#f-date').value=copy.date;
  $('#f-exchange').value=copy.exchange || '';
  $('#f-id').value=nextTradeId();
  $('#f-pair').value=copy.pair||'';
  $('#f-side').value=copy.side||'Long';
  $('#f-lev').value=copy.leverage||5;
  $('#f-entry').value=getCurr(baseAsset(copy.pair))||copy.entry||'';
  $('#f-size-usdt').value=(copy.sizeUSDT===''?'':copy.sizeUSDT)||'';
  $('#f-size-coin').value=(copy.sizeCoin===''?'':copy.sizeCoin)||'';
  $('#f-fee').value=copy.fee||0;
  $('#f-status').value='Offen';
  $('#f-exit').value='';
  $('#f-closed').value='';
  $('#f-note').value=copy.note||'';
  updatePairPriceHint(); updateTvLink();
};
/* ===== Filters events ===== */
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
;['ftr-exchange','ftr-status','ftr-side','ftr-q','ftr-from','ftr-to'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.oninput=debounce(()=>{ render(); },120);
});
/* ===== Clear All ===== */
$('#btn-clear-all').onclick=()=>{
  if(!confirm('Wirklich alle lokalen Daten (Trades, Kasse) lÃ¶schen?')) return;
  trades=[]; cash=[];
  localStorage.removeItem('futures-tracker-trades');
  localStorage.removeItem('futures-tracker-cash');
  render(); renderCash(); ensureWsMatchesSymbols();
};
/* ===== Cash table ===== */
function parseDate(text){
  const s = String(text||'').trim().replace(/\./g,'-').replace(' ', 'T');
  const d = new Date(s);
  if(!isNaN(d)) return d;
  const m = s.match(/(\\d{4})[.\\-\\/](\\d{2})[.\\-\\/](\\d{2}).*?(\\d{2}):(\\d{2})/);
  if(m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]));
  const m2 = s.match(/(\\d{4})[.\\-\\/](\\d{2})[.\\-\\/](\\d{2})/);
  if(m2) return new Date(Number(m2[1]), Number(m2[2])-1, Number(m2[3]));
  return new Date(NaN);
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// === Helpers for Kasse Notes (global) ===
function findTradeById(idStr){
  if(!idStr) return null;
  const want = String(idStr).padStart(3,'0');
  for(let i=0;i<trades.length;i++){
    const t = trades[i];
    const tid = String(t?.id||'').padStart(3,'0');
    if(tid === want) return t;
  }
  return null;
}
function compactNum(n, d=2){
  if(n==null || n==='') return '';
  const x = Number(n);
  if(!isFinite(x)) return '';
  return x.toLocaleString('de-DE', { maximumFractionDigits: d });
}
function formatCashNote(c){
  const raw = String((c && c.note) || '').trim();
  const id = extractIdFromNote(raw);
  if(!id){
    return raw || '';
  }
  const t = findTradeById(id);
  if(!t){
    return raw;
  }
  const status = (t.status==='Geschlossen') ? 'Trade geschlossen' : 'Trade geÃ¶ffnet';
  const pair = t.pair || '';
  const lev  = t.leverage || '';
  const side = t.side || '';
  const entry = (t.entry!=='' && t.entry!=null) ? compactNum(t.entry, 6) : '';
  const exit  = (t.exit!==''  && t.exit!=null)  ? compactNum(t.exit, 6)  : '';
  const sizeU = (t.sizeUSDT!=='' && t.sizeUSDT!=null) ? compactNum(t.sizeUSDT, 2) : '';
  let parts_ = [];
  parts_.push(`Auto: ${status} [ID ${String(id).padStart(3,'0')}]`);
  if(pair) parts_.push(`(${pair})`);
  let meta = [];
  if(side) meta.push(side);
  if(lev)  meta.push('x'+lev);
  if(meta.length) parts_.push('â¢ ' + meta.join(' '));
  if(sizeU) parts_.push('â¢ Margin ' + sizeU);
  if(entry) parts_.push('â¢ Entry ' + entry);
  if(t.status==='Geschlossen' && exit) parts_.push('â Exit ' + exit);
  return parts_.join(' ');
}
function renderCash(){
  const tbody = document.querySelector('#tbl-cash tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  // --- Filter (Suche) ---
  const qEl = document.getElementById('wallet-search');
  const q = (qEl && qEl.value ? qEl.value : '').toLowerCase().trim();

  // --- Sortierung ---
  const sortEl = document.getElementById('wallet-sort');
  const sortKey = sortEl ? sortEl.value : 'date_desc';

  function ym(str){ return String(str||'').slice(0,7); }

  // Indexliste
  const idxs = cash.map((_,i)=>i).filter(i=>{
    const c = cash[i] || {};
    const d = String(c.date||'');
    const n = String(formatCashNote(c) || c.note || '').toLowerCase(); // Suche in formatiertem oder rohem Text
    const a = isFinite(Number(c.amount)) ? String(Number(c.amount)) : String(c.amount||'');
    if(!q) return true;
    return d.toLowerCase().includes(q) || n.includes(q) || a.includes(q);
  });

  idxs.sort((ia, ib)=>{
    const A = cash[ia]||{}, B = cash[ib]||{};
    const da = String(A.date||''), db = String(B.date||'');
    switch(sortKey){
      case 'date_asc':  return da.localeCompare(db);
      case 'date_desc': return db.localeCompare(da);
      case 'month_asc': return ym(da).localeCompare(ym(db));
      case 'month_desc':return ym(db).localeCompare(ym(da));
      default:          return db.localeCompare(da);
    }
  });
  // --- Pagination ---
  const per = pager.cash.len; const total = idxs.length;
  const pages = (per===Infinity)?1:Math.max(1, Math.ceil(total/per));
  pager.cash.page = Math.min(Math.max(1, pager.cash.page), pages);
  const start = (per===Infinity)?0: (pager.cash.page-1)*per;
  const end = (per===Infinity)? idxs.length : start+per;
  const pageIdxs = (per===Infinity)? idxs : idxs.slice(start, end);
  buildPager('cash-pager', pager.cash, total);

  // --- Rendern ---
  pageIdxs.forEach(i=>{
    const c = cash[i] || {};
    const amt = Number(c.amount || 0);
    const noteText = (function(){
      const f = formatCashNote(c);
      if (f && String(f).trim().length) return f;
      const raw = (c.note || '').trim();
      if (raw) return raw;
      const n = Number(c.amount||0);
      return n >= 0 ? 'Einzahlung' : 'Auszahlung';
    })();

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.date || ''}</td>
      <td class="num">${isFinite(amt) ? amt.toLocaleString('de-DE',{maximumFractionDigits:2}) : ''}</td>
      <td>${escapeHtml(noteText)}</td>
      <td>
        <div class="btn-group">
          <button class="btn small" data-cedit="${i}">BEARBEITEN</button>
          <button class="btn small danger" data-cdel="${i}">LÃSCHEN</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // edit handlers
  document.querySelectorAll('[data-cedit]').forEach(b=>{
    b.onclick = ()=>{
      const i = Number(b.dataset.cedit);
      const c = cash[i]; if(!c) return;
      const newDate = prompt('Datum (YYYY-MM-DDTHH:mm):', (c.date || '').slice(0,16)) || c.date;
      const amtStr  = prompt('Betrag (USDT):', String(c.amount || 0)) || String(c.amount || 0);
      const noteStr = prompt('Notiz:', c.note || '') ?? (c.note || '');
      const amt = parseFloat(String(amtStr).replace(/\s+/g,'').replace(',', '.'));
      if (!isFinite(amt)){ alert('UngÃ¼ltiger Betrag. Abgebrochen.'); return; }
      c.date  = newDate && newDate.length ? newDate : c.date;
      c.amount = amt;
      c.note  = noteStr;
      saveCash();
      renderCash(); render(); updateDashboard();
    };
  });

  // delete handlers
  document.querySelectorAll('[data-cdel]').forEach(b=>{
    b.onclick = ()=>{
      const i = Number(b.dataset.cdel);
      const c = cash[i];
      const id = extractIdFromNote(c?.note);
      const warn = `Diesen KasseâEintrag lÃ¶schen?` + (id ? `\nDer zugehÃ¶rige Trade (ID ${id}) wird ebenfalls gelÃ¶scht.` : '');
      if(!confirm(warn)) return;
      cash.splice(i, 1); saveCash();
      if(id){ removeTradesById(id); save(); }
      renderCash(); render(); updateDashboard();
    };
  });
}
$('#btn-cash-add').onclick=()=>{
  const amt=Number($('#c-amount').value||0);
  const dt=$('#c-date').value||nowIso();
  const note=$('#c-note').value.trim();
  if(!amt){ alert('Bitte Betrag angeben'); return; }
  cash.push({date:dt, amount:amt, note}); saveCash();
  $('#c-amount').value=''; $('#c-note').value=''; renderCash(); updateDashboard();
};
$('#wallet-search').addEventListener('input', ()=> walletApply());
$('#wallet-sort').addEventListener('change', ()=> walletApply());
function walletApply(){
  const q = ($('#wallet-search')?.value || '').toLowerCase();
  const sort = ($('#wallet-sort')?.value || 'date_desc');
  const tbody = document.querySelector('#tbl-cash tbody'); if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach(tr=>{
    const txt = tr.textContent.toLowerCase();
    tr.style.display = (q === '' || txt.indexOf(q) !== -1) ? '' : 'none';
  });
  const visible = rows.filter(tr=> tr.style.display !== 'none');
  visible.sort((a,b)=>{
    const ta = a.cells[0]?.textContent || '';
    const tb = b.cells[0]?.textContent || '';
    const da = parseDate(ta); const db = parseDate(tb);
    if(sort === 'date_desc') return (+db) - (+da);
    if(sort === 'date_asc')  return (+da) - (+db);
    if(sort.startsWith('month_')){
      const ma = (da instanceof Date && !isNaN(da)) ? da.getMonth() : -1;
      const mb = (db instanceof Date && !isNaN(db)) ? db.getMonth() : -1;
      if(ma !== mb) return (sort==='month_asc' ? (ma-mb) : (mb-ma));
      return (+db) - (+da);
    }
    return 0;
  });
  visible.forEach(tr=> tbody.appendChild(tr));
}
/* ===== Footer sums helpers ===== */
function parseNumDE(s){
  if(s==null) return 0;
  const t = String(s).replace(/[^\\d,\\.\\-]/g,'').replace(/\\./g,'').replace(',', '.');
  const n = Number(t);
  return isNaN(n) ? 0 : n;
}
function headerIndexMap(table){
  const m = {}; if(!table || !table.tHead) return m;
  const ths = Array.from(table.tHead.querySelectorAll('th'));
  ths.forEach((th,i)=> m[th.textContent.trim()] = i);
  return m;
}
function updateOpenMarginSum(){
  try{
    const table = document.getElementById('tbl');
    const out   = document.getElementById('sum-open-margin');
    if(!table || !out) return;
    const map = headerIndexMap(table);
    let idx = map['Margin USDT'];
    if(idx==null) idx = map['Margin'] != null ? map['Margin'] : null;
    if(idx==null) return;
    const rows = Array.from(table.tBodies[0]?.rows || []);
    const visible = rows.filter(r => r.style.display !== 'none');
    let sum = 0;
    visible.forEach(r=>{
      const cell = r.cells[idx];
      const val  = cell ? parseNumDE(cell.textContent) : 0;
      sum += val;
    });
    out.textContent = new Intl.NumberFormat('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}).format(sum) + ' USDT';
  }catch(e){}
}
function updateClosedRealSum(){
  try{
    const table = document.getElementById('tbl-closed');
    const out   = document.getElementById('sum-closed-real');
    if(!table || !out) return;
    const map = headerIndexMap(table);
    let idx = map['Real PnL'];
    if(idx==null) idx = map['Realisiert']!=null ? map['Realisiert'] : null;
    if(idx==null) idx = map['Realized PnL']!=null ? map['Realized PnL'] : null;
    if(idx==null) return;
    const rows = Array.from(table.tBodies[0]?.rows || []);
    const visible = rows.filter(r => r.style.display !== 'none');
    let sum = 0;
    visible.forEach(r=>{
      const cell = r.cells[idx];
      const val  = cell ? parseNumDE(cell.textContent) : 0;
      sum += val;
    });
    out.textContent = new Intl.NumberFormat('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}).format(sum) + ' USDT';
  }catch(e){}
}
function updateClosedMarginSum(){
  try{
    const table = document.getElementById('tbl-closed');
    const out   = document.getElementById('sum-closed-margin');
    if(!table || !out) return;
    const map = headerIndexMap(table);
    let idx = map['Margin USDT'];
    if(idx==null){
      for(const k of Object.keys(map)){
        const kl=k.toLowerCase();
        if(kl.includes('margin') && kl.includes('usdt')){ idx=map[k]; break; }
      }
    }
    if(idx==null && map['Margin']!=null) idx = map['Margin'];
    if(idx==null) return;
    const rows = Array.from(table.tBodies[0]?.rows || []).filter(r=> r.style.display !== 'none');
    let sum = 0;
    rows.forEach(r=> sum += parseNumDE(r.cells[idx]?.textContent));
    out.textContent = new Intl.NumberFormat('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2}).format(sum) + ' USDT';
  }catch(e){}
}
function updateClosedSums(){ updateClosedRealSum(); updateClosedMarginSum(); }
/* ===== TRADINGVIEW ===== */
function tvSymbolFromPair(pair){
  try {
    const p = (pair || 'BTC/USDT').toUpperCase().replace('/','');
    return 'BINANCE:' + p;
  } catch(e){ return 'BINANCE:BTCUSDT'; }
}
var tvWidget = null;

function _tvReady(fn){
  if (tvWidget && typeof tvWidget.onChartReady === 'function') {
    tvWidget.onChartReady(fn);
  } else {
    const i = setInterval(()=>{
      if (tvWidget && typeof tvWidget.onChartReady === 'function') {
        clearInterval(i);
        tvWidget.onChartReady(fn);
      }
    }, 250);
  }
}

function createTVChart(pair){
  const containerId = 'tv-chart';
  const el = document.getElementById(containerId);
  if(!el || typeof TradingView === 'undefined'){ return; }
  el.innerHTML = '';
  const theme = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'dark' : 'light';
  const symbol = tvSymbolFromPair(pair || ($('#f-pair') && $('#f-pair').value) || ((window.trades && window.trades[0] && window.trades[0].pair) || 'BTC/USDT'));
  tvWidget = new TradingView.widget({
    container_id: containerId,
    autosize: true,
    symbol: symbol,
    interval: "60",
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Etc/UTC",
    theme: theme,
    style: "1",
    locale: "de_DE",
    enable_publishing: false,
    allow_symbol_change: true,
    withdateranges: true,
    details: true,
    hotlist: true,
    calendar: true,
    studies: ["Volume@tv-basicstudies","RSI@tv-basicstudies","MACD@tv-basicstudies"],
    hide_side_toolbar: false,
    hide_top_toolbar: false,
    toolbar_bg: "transparent"
  });
}
function updateTvLink(){
  const p=$('#f-pair').value.trim().toUpperCase();
  const base=p.replace('/USDT','');
  // nothing else required, link in modal
}
/* ===== WS symbols sync ===== */
function ensureWsMatchesSymbols(){
  const syms1=new Set(trades.map(t=>baseAsset(t.pair)).filter(Boolean));
  const a=[...syms1].sort().join(','), b=[...wsSymbols].sort().join(',');
  if(a!==b){ openWS(); }
}
/* ===== Init ===== */
document.getElementById('f-date').value=nowIso();
document.getElementById('f-id').value=nextTradeId();
document.getElementById('f-pair').addEventListener('input', ()=>{ updatePairPriceHint(); updateTvLink(); });
document.getElementById('auto-cash').checked=autoCash;
document.getElementById('auto-cash').addEventListener('change', ()=>{
  autoCash=$('#auto-cash').checked;
  localStorage.setItem('futures-tracker-auto-cash', String(autoCash));
});
render(); renderCash(); openWS(); updateTvLink();
window.addEventListener('resize', ()=>{});
</script>
<!-- Edit Modal (injected) -->
<style>
  /* minimal modal styles, neutral to existing design variables */
  #edit-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  #edit-modal.open{display:flex}
  #edit-modal .box{background:var(--panel,#111827);color:var(--text,#e5e7eb);border:1px solid var(--border,#1f2937);border-radius:16px;max-width:980px;width:96%;box-shadow:0 10px 30px rgba(0,0,0,.35);}
  #edit-modal .h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border,#1f2937)}
  #edit-modal .b{padding:16px}
  #edit-modal .form-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
  #edit-modal .col-2{grid-column:span 2}
  #edit-modal .col-3{grid-column:span 6}
  #edit-modal label{font-size:12px;opacity:.8;display:block;margin-bottom:4px}
  #edit-modal input,#edit-modal select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border,#1f2937);background:var(--input,#0b1326);color:var(--text,#e5e7eb)}
  #edit-modal .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border,#1f2937);background:var(--panel-2,#0f172a);color:var(--text,#e5e7eb);cursor:pointer}
  #edit-modal .btn.primary{border-color:var(--brand,#60a5fa)}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<div aria-label="Trade bearbeiten" aria-modal="true" class="modal" id="edit-modal" role="dialog">
<div class="box">
<div class="h">
<strong>Trade bearbeiten</strong>
<div style="display:flex;gap:8px">
<button class="btn" id="edit-cancel">Abbrechen</button>
<button class="btn primary" id="edit-save">Ãnderungen speichern</button>
</div>
</div>
<div class="b">
<input id="e-index" type="hidden" value=""/>
<div class="form-grid">
<div class="col-2"><label>Datum (ErÃ¶ffnung)</label><input id="e-date" type="datetime-local"/></div>
<div><label>BÃ¶rse</label><select id="e-exchange">
  <option value="">Alle</option>
  <option value="Binance">Binance</option>
  <option value="Bybit">Bybit</option>
  <option value="Bitget">Bitget</option>
  <option value="Kraken">Kraken</option>
  <option value="KuCoin">KuCoin</option>
  <option value="OKX">OKX</option>
  <option value="BingX">BingX</option>
  <option value="Levex">Levex</option>
  <option value="Pionex">Pionex</option>
  <option value="Andere">Andere</option>
</select></div>
<div class="col-2"><label>ID</label><input id="e-id" readonly=""/></div>
<div class="col-2"><label>Paar</label><input id="e-pair" placeholder="BTC/USDT"/></div>
<div><label>Richtung</label><select id="e-side"><option>Long</option><option>Short</option>
  <option>Spot</option>
</select></div>
<div><label>Hebel</label><input id="e-lev" min="1" step="1" type="number"/></div>
<div><label>Einstiegspreis</label><input id="e-entry" step="0.00000001" type="number"/></div>
<div><label>Margin (USDT)</label><input id="e-size-usdt" step="0.01" type="number"/></div>
<div><label>GrÃ¶Ãe (Coin)</label><input id="e-size-coin" step="0.00000001" type="number"/></div>
<div><label>GebÃ¼hr (USDT)</label><input id="e-fee" step="0.0001" type="number"/></div>
<div><label>Gewinn / Verlust</label><input id="e-grid" step="0.01" type="number"/></div>
<div><label>Status</label><select id="e-status"><option>Offen</option><option>Geschlossen</option></select></div>
<div><label>Ausstiegspreis</label><input id="e-exit" step="0.00000001" type="number"/></div>
<div class="col-2"><label>Exit-Datum</label><input id="e-closed" type="datetime-local"/></div>
<div class="col-3"><label>Notiz</label><input id="e-note" placeholder="Optional"/></div>
</div>
</div>
</div>
</div>
<script>
(function(){
  // Safe helper if $ is not already defined
  if (typeof window.$ !== 'function') {
    window.$ = (sel)=>document.querySelector(sel);
  }
  const editModal = document.getElementById('edit-modal');
  if(!editModal){ return; }
  function openEditModal(){ editModal.classList.add('open'); }
  function closeEditModal(){ editModal.classList.remove('open'); }
  function getValNum(el){
    const v = el && el.value;
    if(v==='' || v==null) return '';
    const n = Number(v);
    return Number.isFinite(n) ? n : '';
  }
  function loadToEditForm(idx){
    const t = (window.trades||[])[idx];
    if(!t) return;
    $('#e-index').value = idx;
    $('#e-date').value = t.date || '';
    $('#f-exchange').value = t.exchange || '';
    $('#e-id').value = t.id || '';
    $('#e-pair').value = t.pair || '';
    $('#e-side').value = t.side || 'Long';
    $('#e-lev').value = t.leverage || 5;
    $('#e-entry').value = (t.entry===''? '': t.entry) ?? '';
    $('#e-size-usdt').value = (t.sizeUSDT===''?'':t.sizeUSDT) ?? '';
    $('#e-size-coin').value = (t.sizeCoin===''?'':t.sizeCoin) ?? '';
    $('#e-fee').value = t.fee ?? 0;
    $('#e-grid').value = t.gridPnl ?? 0;
    $('#e-status').value = t.status || 'Offen';
    $('#e-exit').value = (t.exit===''?'':t.exit) ?? '';
    $('#e-closed').value = t.closedAt || '';
    $('#e-note').value = t.note || '';
  }
  function readEditForm(){
    return {
      date: $('#e-date').value,
      exchange: $('#e-exchange').value,
      id: ($('#e-id').value||'').trim(),
      pair: $('#e-pair').value.trim().toUpperCase(),
      side: $('#e-side').value,
      leverage: Number($('#e-lev').value||1),
      entry: getValNum($('#e-entry')),
      sizeUSDT: getValNum($('#e-size-usdt')),
      sizeCoin: getValNum($('#e-size-coin')),
      fee: Number($('#e-fee').value||0),
      status: $('#e-status').value,
      exit: (function(){ const raw=$('#e-exit').value; if(raw===''||raw==null) return ''; const n=Number(raw); return Number.isFinite(n)?n:''; })(),
      closedAt: $('#e-closed').value || '',
      gridPnl: Number($('#e-grid').value||0),
      note: $('#e-note').value.trim()
    };
  }
  function onEditSave(){
    const idx = Number($('#e-index').value);
    const trades = window.trades || [];
    if(Number.isNaN(idx) || !trades[idx]){ closeEditModal(); return; }
    const prev = trades[idx];
    let t = readEditForm();
    // Status-Logik
    if(t.status==='Geschlossen'){
      if(!t.closedAt){ alert('Exit-Datum ist Pflicht.'); return; }
      const tmp={...(prev||t), ...t, status:'Offen'};
      try {
        const u=(typeof calcUnreal==='function')? calcUnreal(tmp): null;
        const grid=Number(t.gridPnl||0);
        if(u && u.pnl!=null){
          if(u.price!=null && !t.exit) t.exit=u.price;
          t.realFixed = u.pnl + grid;
        } else {
          const e=Number(t.entry||0), x=Number(t.exit||0);
          const es=(typeof ensureSizes==='function')? ensureSizes(t): {sizeCoin:t.sizeCoin||''};
          const sizeCoin = es.sizeCoin;
          const lev=getEffLev(t);
          if(e&&x&&sizeCoin){
            const raw=(typeof isLong==='function' && isLong(t))? (x-e)*sizeCoin*lev : (e-x)*sizeCoin*lev;
            t.realFixed = raw - Number(t.fee||0) + grid;
          }
        }
      } catch(e){ /* fallback silent */ }
    } else {
      delete t.realFixed;
      t.closedAt='';
    }
    if(!t.id) t.id = prev.id || (typeof nextTradeId==='function'? nextTradeId(): String(Date.now()));
    window.trades[idx] = t;
    if(typeof save==='function') save();
    // Auto-Kasse bei Statuswechsel
    try {
      if(window.autoCash && prev.status !== t.status){
        const es=(typeof ensureSizes==='function')? ensureSizes(t): {sizeUSDT:t.sizeUSDT||''};
        const idTxt = t.id? (' [ID '+t.id+']') : '';
        if(prev.status==='Offen' && t.status==='Geschlossen'){
          const r=(typeof calcReal==='function')? (calcReal(t).pnl||0) : 0;
          if(typeof addCash==='function'){
            addCash(Number(es.sizeUSDT||0)+Number(r||0),'Auto: Trade geschlossen'+idTxt+' ('+(t.pair||'')+')', t.closedAt || (typeof nowIso==='function'? nowIso(): new Date().toISOString()));
          }
        } else if(prev.status==='Geschlossen' && t.status==='Offen'){
          if(es.sizeUSDT!==''){
            if(typeof addCash==='function'){
              addCash(-Number(es.sizeUSDT),'Auto: Trade wieder geÃ¶ffnet'+idTxt+' ('+(t.pair||'')+')', t.date || (typeof nowIso==='function'? nowIso(): new Date().toISOString()));
            }
          }
        }
      }
    } catch(e){ /* silent */ }
    if(typeof render==='function') render();
    if(typeof ensureWsMatchesSymbols==='function') ensureWsMatchesSymbols();
    closeEditModal();
  }
  function attachEditHandlersToPopup(){
    document.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        const index = Number(b.dataset.edit);
        loadToEditForm(index);
        openEditModal();
      };
    });
  }
  const saveBtn = document.getElementById('edit-save');
  const cancelBtn = document.getElementById('edit-cancel');
  if(saveBtn) saveBtn.addEventListener('click', onEditSave);
  if(cancelBtn) cancelBtn.addEventListener('click', closeEditModal);
  editModal.addEventListener('click', (e)=>{ if(e.target && e.target.id==='edit-modal') closeEditModal(); });
  // Wrap existing render to re-bind handlers after every render
  if(typeof window.render === 'function'){
    const _render = window.render;
    window.render = function(){
      _render();
      attachEditHandlersToPopup();
    };
  } else {
    // If render not defined yet, attach once on DOM ready
    document.addEventListener('DOMContentLoaded', attachEditHandlersToPopup);
  }
})();
</script>
<script>
(function(){
  function $(sel){ return document.querySelector(sel); }
  function findTradeIndexFromButton(btn){
    const trades = window.trades || [];
    const d = btn.dataset || {};
    const isInt = (v)=> typeof v === 'string' && /^\d+$/.test(v);
    if (isInt(d.editIndex)) return Number(d.editIndex);
    if (isInt(d.index)) return Number(d.index);
    if (isInt(d.edit)) return Number(d.edit);
    const tryIds = [d.edit, d.id, d.tradeId, d.editId];
    for (const val of tryIds){
      if (val!=null && val!==''){
        const idx = trades.findIndex(t => String(t?.id) === String(val));
        if (idx >= 0) return idx;
      }
    }
    const row = btn.closest('[data-index],[data-id],[data-trade-id],tr');
    if (row){
      if (isInt(row.dataset?.index)) return Number(row.dataset.index);
      const tryRowIds = [row.dataset?.id, row.dataset?.tradeId];
      for (const rid of tryRowIds){
        if (rid!=null && rid!==''){
          const idx = trades.findIndex(t => String(t?.id) === String(rid));
          if (idx >= 0) return idx;
        }
      }
      const idCell = row.querySelector('.cell-id, [data-cell="id"]');
      if (idCell){
        const text = (idCell.textContent||'').trim();
        if (text){
          const idx = trades.findIndex(t => String(t?.id) === text);
          if (idx >= 0) return idx;
        }
      }
    }
    return -1;
  }
  function openEditByButton(btn){
    const idx = findTradeIndexFromButton(btn);
    if (idx < 0) {
      console.warn('Bearbeiten-Index konnte nicht ermittelt werden.');
      return;
    }
    if (typeof window.loadToEditForm === 'function') window.loadToEditForm(idx);
    const modal = document.getElementById('edit-modal');
    if (modal) modal.classList.add('open');
  }
  function bindRobustEditHandlers(){
    document.querySelectorAll('[data-edit], .btn-edit, .edit-btn').forEach(b=>{
      b.onclick = ()=> openEditByButton(b);
    });
  }
  if (typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){
      _r();
      bindRobustEditHandlers();
    };
  }
  document.addEventListener('DOMContentLoaded', bindRobustEditHandlers);
  bindRobustEditHandlers();
})();
</script>
<script>
(function(){
  function $(sel){ return document.querySelector(sel); }
  function setVal(id, v){ const el=$(id); if(el) el.value = v ?? ''; }
  function getVal(id){ const el=$(id); return el ? el.value : ''; }
  function copyFtoE(){
    setVal('#e-date',     getVal('#f-date'));
    setVal('#e-exchange', getVal('#f-exchange'));
    setVal('#e-id',       getVal('#f-id'));
    setVal('#e-pair',     getVal('#f-pair'));
    setVal('#e-side',     getVal('#f-side'));
    setVal('#e-lev',      getVal('#f-lev'));
    setVal('#e-entry',    getVal('#f-entry'));
    setVal('#e-size-usdt',getVal('#f-size-usdt'));
    setVal('#e-size-coin',getVal('#f-size-coin'));
    setVal('#e-fee',      getVal('#f-fee'));
    setVal('#e-status',   getVal('#f-status'));
    setVal('#e-exit',     getVal('#f-exit'));
    setVal('#e-closed',   getVal('#f-closed'));
    setVal('#e-grid',     getVal('#f-grid'));
    setVal('#e-note',     getVal('#f-note'));
  }
  function copyEtoF(){
    setVal('#f-date',     getVal('#e-date'));
    setVal('#f-exchange', getVal('#e-exchange'));
    setVal('#f-id',       getVal('#e-id'));
    setVal('#f-pair',     getVal('#e-pair'));
    setVal('#f-side',     getVal('#e-side'));
    setVal('#f-lev',      getVal('#e-lev'));
    setVal('#f-entry',    getVal('#e-entry'));
    setVal('#f-size-usdt',getVal('#e-size-usdt'));
    setVal('#f-size-coin',getVal('#e-size-coin'));
    setVal('#f-fee',      getVal('#e-fee'));
    setVal('#f-status',   getVal('#e-status'));
    setVal('#f-exit',     getVal('#e-exit'));
    setVal('#f-closed',   getVal('#e-closed'));
    setVal('#f-grid',     getVal('#e-grid'));
    setVal('#f-note',     getVal('#e-note'));
  }
  // Open edit from index: use original loader, then mirror to popup and open it
  window.openEditFromIndex = function(i){
    if (typeof window.loadToForm === 'function') {
      window.loadToForm(i); // populates #f-*
    }
    copyFtoE();
    const modal = document.getElementById('edit-modal');
    if (modal) modal.classList.add('open');
  };
  function bindEditButtons(){
    document.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        const idx = Number(b.dataset.edit);
        if (!Number.isFinite(idx)) return;
        openEditFromIndex(idx);
      };
    });
  }
  // Replace popup buttons to use existing save logic
  const saveBtn = document.getElementById('edit-save');
  const cancelBtn = document.getElementById('edit-cancel');
  if (saveBtn){
    saveBtn.onclick = ()=>{
      // mirror values back to inline form, use existing #btn-save logic
      copyEtoF();
      const btnSave = document.getElementById('btn-save');
      if (btnSave && typeof btnSave.onclick === 'function') {
        btnSave.onclick(); // triggers onAddOrSave(prev) etc.
      }
      const modal = document.getElementById('edit-modal');
      if (modal) modal.classList.remove('open');
    };
  }
  if (cancelBtn){
    cancelBtn.onclick = ()=>{
      const modal = document.getElementById('edit-modal');
      if (modal) modal.classList.remove('open');
    };
  }
  // Hook into render to re-bind after table refresh
  if (typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){
      _r();
      bindEditButtons();
    };
  }
  // bind on first paint
  document.addEventListener('DOMContentLoaded', bindEditButtons);
  bindEditButtons();
})();
</script>
<script>
(function(){
  // Hilfsfunktion
  function isInsideNewTab(el){
    if(!el) return false;
    return !!(el.closest('#tab-new') || el.closest('[data-tab="new"]') || el.closest('.tab-new'));
  }
  // Bestehende Binder erweitern/Ã¼berschreiben
  function bindNoEditInNewTab(){
    document.querySelectorAll('[data-edit]').forEach(b=>{
      if(isInsideNewTab(b)){
        // Entferne ggf. bestehende Handler
        b.onclick = null;
        b.setAttribute('disabled','disabled');
      }
    });
  }
  // Beim Rendern und initial
  if (typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){
      _r();
      bindNoEditInNewTab();
    };
  }
  document.addEventListener('DOMContentLoaded', bindNoEditInNewTab);
  bindNoEditInNewTab();
})();
</script>
<script>
(function(){
  const EXTRA_SYMS = ["BTC", "ETH", "SOL", "BNB", "XRP", "ADA", "AVAX", "DOGE", "TON", "TRX", "LINK", "LTC", "BCH", "DOT", "MATIC", "HBAR", "NEAR", "ATOM", "OP", "ARB", "XLM", "ETC", "FIL", "VET", "GRT", "APT", "AAVE", "SAND", "MANA", "FTM", "ALGO", "ICP", "RNDR", "SUI", "SEI", "PEPE", "SHIB", "TAO", "JUP", "WIF", "STRK", "ENA", "INJ", "RUNE", "ROSE", "TIA", "PYTH", "AR", "BLUR", "ORDI", "W", "JTO", "ALT", "BONK", "JASMY", "CAKE", "CFX", "ETHFI", "MEW", "UNI", "GMX", "DYDX", "KAS", "KAVA", "SFP", "KSM", "FLOW", "SKL", "GLMR", "ONE", "XTZ", "MINA", "CHZ", "IMX", "EGLD", "NEO", "ONT", "TRB", "COMP", "ZRX", "CELO", "BAT", "YFI", "1INCH", "SUSHI", "ENS", "MASK", "MAGIC", "BAND", "API3", "LDO", "STX", "CTSI"];
  function $(sel){ return document.querySelector(sel); }
  function ce(tag,cls,txt){ const el=document.createElement(tag); if(cls) el.className=cls; if(txt) el.textContent=txt; return el; }
  function setPair(sym){
    const pair = sym.toUpperCase()+"/USDT";
    const fPair = document.getElementById('f-pair') || document.querySelector('input[name="pair"], #pair');
    if(fPair){ fPair.value = pair; fPair.dispatchEvent(new Event('input')); }
    if(typeof window.onPairChanged === 'function') window.onPairChanged(pair);
    if(typeof window.requestLivePrice === 'function') window.requestLivePrice(pair);
    if(typeof window.ensureWsMatchesSymbols === 'function') window.ensureWsMatchesSymbols();
  }
  function renderExtendedChips(){
    // try to find existing quick selection container; otherwise create one under the "Schnellauswahl" section
    let host = document.getElementById('top-coins-extended');
    if(!host){
      // try to insert after a known quick-select container (chips buttons)
      const after = document.querySelector('.quick-select, .quick, .top-coins, .chips-row') || document.querySelector('button[role="add-trade"]')?.parentElement;
      host = ce('div','',null); host.id='top-coins-extended';
      const title = ce('div','', '');
      title.style.fontSize='12px'; title.style.opacity='0.8'; title.style.margin='8px 0 -4px 0';
      const target = after && after.parentElement ? after.parentElement : document.querySelector('form') || document.body;
      target.appendChild(title);
      target.appendChild(host);
    }
    host.innerHTML='';
    EXTRA_SYMS.forEach(sym=>{
      const chip=ce('div','chip',sym);
      chip.onclick=()=>setPair(sym);
      host.appendChild(chip);
    });
  }
  document.addEventListener('DOMContentLoaded', renderExtendedChips);
  // also re-render after each render() in case the tab content rerenders
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); renderExtendedChips(); };
  }
})();
</script>
<script>
(function(){
  const EXTRA = ["BTC", "ETH", "BNB", "SOL", "XRP", "ADA", "DOGE", "TRX", "TON", "DOT", "MATIC", "AVAX", "LINK", "LTC", "BCH", "ATOM", "HBAR", "NEAR", "APT", "OP", "ARB", "ETC", "FIL", "XLM", "ICP", "ALGO", "SUI", "SEI", "INJ", "RNDR", "TIA", "PYTH", "STX", "JUP", "PEPE", "SHIB", "WIF", "ENA", "STRK", "TAO", "KAS", "RUNE", "ROSE", "AR", "AAVE", "GMX", "DYDX", "UNI", "LDO", "IMX", "SAND", "MANA", "FTM", "VET", "GRT", "KAVA", "CELO", "COMP", "ZRX", "1INCH", "SUSHI", "MASK", "MAGIC", "ENS", "API3", "BAND", "TRB", "CTSI", "FLOW", "XTZ", "MINA", "CHZ", "NEO", "ONT", "EGLD", "GLMR", "SKL", "ONE", "LQTY", "YFI", "BAT", "ORDI", "W", "JTO", "ALT", "JASMY", "CAKE", "CFX", "ETHFI", "MEW", "SFP", "KSM", "BLUR", "AERO", "RENDER"];
  function $(sel){ return document.querySelector(sel); }
  function setPairAndClose(pair){
    const input = document.getElementById('f-pair') || document.querySelector('input[name="pair"], #pair');
    if(input){ input.value = pair; input.dispatchEvent(new Event('input')); }
    if(typeof window.onPairChanged === 'function') window.onPairChanged(pair);
    if(typeof window.requestLivePrice === 'function') window.requestLivePrice(pair);
    if(typeof window.ensureWsMatchesSymbols === 'function') window.ensureWsMatchesSymbols();
    // SchlieÃe die Marktauswahl, falls es eine Close-SchaltflÃ¤che gibt
    const closeBtn = Array.from(document.querySelectorAll('button, .btn'))
      .find(b => /schlie(?:Ã|ss)en/i.test(b.textContent||''));
    if(closeBtn) closeBtn.click();
  }
  function ensureExtraInModal(){
    // Versuche das Overlay anhand des Titels zu erkennen
    const modal = Array.from(document.querySelectorAll('div,section,article'))
      .find(el => /marktauswahl/i.test(el.textContent||'') && el.querySelector('input,button'));
    if(!modal) return;
    // Host einmalig anlegen
    if(modal.querySelector('.modal-markets-extra')) return;
    const host = document.createElement('div');
    host.className = 'modal-markets-extra';
    // Ãberschrift ââ einfÃ¼gen
    const title = document.createElement('div');
    title.textContent = '';
    title.style.fontSize='12px'; title.style.opacity='0.8'; title.style.margin='8px 2px';
    // Karten bauen
    EXTRA.forEach(sym=>{
      const card = document.createElement('div');
      card.className = 'market-card';
      const t = document.createElement('div'); t.className='t'; t.textContent = sym + '/USDT';
      const s = document.createElement('div'); s.className='s'; s.textContent = 'Klick: Ã¼bernehmen';
      card.appendChild(t); card.appendChild(s);
      card.onclick = () => setPairAndClose(sym + '/USDT');
      host.appendChild(card);
    });
    // EinfÃ¼gen: ans Ende der Modal-Inhalte
    const content = modal.querySelector('*:scope > div, section, article') || modal;
    content.appendChild(title);
    content.appendChild(host);
  }
  // Beim Ãffnen der Modal erneut versuchen
  const obs = new MutationObserver(()=> ensureExtraInModal());
  obs.observe(document.documentElement, { childList:true, subtree:true });
  document.addEventListener('DOMContentLoaded', ensureExtraInModal);
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); ensureExtraInModal(); };
  }
})();
</script>
<script>
// Tabs umbenennen, ohne Funktion zu Ã¤ndern
(function(){
  const mapping = new Map([
    ['Neuer Trade','Neuer Trade'],
    ['Laufender Trade','Laufende Trades'],
    ['Abgeschlossene','Abgeschlossene Trades'],
    ['Kasse','Kasse'],
    ['Chart','Tradeview']
  ]);
  function rename(el){
    const t = (el.textContent||'').trim();
    if(mapping.has(t)){
      el.textContent = mapping.get(t);
      // optional aria-label angleichen
      el.setAttribute('aria-label', mapping.get(t));
      // falls data-title o.Ã¤.
      if(el.dataset) el.dataset.title = mapping.get(t);
    }
  }
  function run(){
    // typische Tab-Selektoren
    const tabs = document.querySelectorAll('[role="tab"], .tab, .tabs button, .tabs a, .nav-tabs *');
    if(tabs.length){
      tabs.forEach(rename);
    } else {
      // Fallback: alle Buttons/Links der Leiste durchsuchen
      document.querySelectorAll('button,a').forEach(rename);
    }
  }
  document.addEventListener('DOMContentLoaded', run);
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); run(); };
  }
  // einmal sofort fÃ¼r bereits geladene DOMs
  run();
})();
</script>
<script>
(function(){
  const mapping = new Map([
    ['Neuer Trade','Neuer Trade'],
    ['Laufender Trade','Laufende Trades'],
    ['Abgeschlossene Trades','Abgeschlossene Trades'],
    ['Kasse','Kasse'],
    ['Tradeview','Tradeview']
  ]);
  function rename(el){
    const t = (el.textContent||'').trim();
    if(mapping.has(t)){
      el.textContent = mapping.get(t);
      el.setAttribute('aria-label', mapping.get(t));
      if(el.dataset) el.dataset.title = mapping.get(t);
    }
  }
  function run(){
    const tabs = document.querySelectorAll('[role="tab"], .tab, .tabs button, .tabs a, .nav-tabs *');
    if(tabs.length){
      tabs.forEach(rename);
    } else {
      document.querySelectorAll('button,a').forEach(rename);
    }
  }
  document.addEventListener('DOMContentLoaded', run);
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); run(); };
  }
  run();
})();
</script>
<style>
/* Dark Mode: Tab-Text weiÃ */
[data-theme="dark"] [role="tab"],
[data-theme="dark"] .tab,
[data-theme="dark"] .tabs button,
[data-theme="dark"] .tabs a,
[data-theme="dark"] .nav-tabs * {
    color: #ffffff !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<style>
/* Nur den Text "Auto-Kasse buchen" unsichtbar machen â Checkbox sichtbar lassen */
.hide-auto-cash-text{ color:transparent !important; text-shadow:none !important; }
.hide-auto-cash-text *{ color:transparent !important; text-shadow:none !important; }
.hide-auto-cash-text input, .hide-auto-cash-text .switch{
  opacity:1 !important; filter:none !important; color:inherit !important;
}

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<script>
(function(){
  function markAutoCashLabels(){
    document.querySelectorAll('label').forEach(l=>{
      const t=(l.textContent||'').replace(/\s+/g,' ').trim();
      if(/auto[-\s]?kasse\s*buchen/i.test(t)){
        l.classList.add('hide-auto-cash-text');
      }
    });
  }
  document.addEventListener('DOMContentLoaded', markAutoCashLabels);
  // Falls re-render:
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); markAutoCashLabels(); };
  }
  markAutoCashLabels();
})();
</script>
<script>
(function(){
  // Ziel-Liste der BÃ¶rsen
  const TARGET_EXCHANGES = ["Binance","Bybit","Bitget","Kraken","KuCoin","OKX","BingX","Levex"];
  function ensureExchangeOptions(){
    // MÃ¶gliche Selektoren im Formular
    const selects = Array.from(document.querySelectorAll(
      '#f-exchange, select[name="boerse"], select[name="exchange"], select[id*="exchange"], select[data-field="exchange"]'
    ));
    if(!selects.length) return;
    selects.forEach(sel => {
      const have = new Set(Array.from(sel.options).map(o => (o.value||o.text||"").trim().toLowerCase()));
      let prev = sel.value;
      TARGET_EXCHANGES.forEach(name => {
        const key = name.trim().toLowerCase();
        if(!have.has(key)){
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }
      });
      // Falls vorher leer: NICHT automatisch setzen â 'Alle' (leer) bleibt bestehen
      /* no-op to preserve empty (Alle) */
    });
  }
  // Beim Laden & nach jedem render()
  document.addEventListener('DOMContentLoaded', ensureExchangeOptions);
  if(typeof window.render === 'function'){
    const _r = window.render;
    window.render = function(){ _r(); ensureExchangeOptions(); };
  }
  // Falls das Dropdown spÃ¤ter dynamisch eingefÃ¼gt wird
  const mo = new MutationObserver(()=>ensureExchangeOptions());
  mo.observe(document.documentElement, {childList:true, subtree:true});
  // Erste AusfÃ¼hrung
  ensureExchangeOptions();
})();
</script>
<style>
/* Komplett unsichtbar: Bereich 'Auto-Kasse buchen' inkl. Checkbox */

/* Slow mode Badge (Backoff) */
  background: rgba(234,179,8,.15); /* amber-500 tone */
  border-color: rgba(234,179,8,.35);
}
  background: #fbbf24; /* amber-400 */
}

</style>
<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('label').forEach(l=>{
    const t = (l.textContent||'').trim().toLowerCase();
    if(t.includes('auto-kasse buchen') || t.includes('autoâkasse buchen')){
      l.style.display = 'none';
    }
  });
});
</script>
<script>
// ===== DOM-basierte Gesamtsumme (berÃ¼hrt keine App-Logik) =====
(function(){
  function parseDeNum(s){
    if(!s) return NaN;
    s = String(s).replace(/\s+/g,'').replace(/\./g,'').replace(',', '.');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }
  function recalcDomMarginSum(){
    if (window._renderingOpen) return;
    try{
      var rows = document.querySelectorAll('#tab-open #tbl tbody tr');
      var sum = 0;
      rows.forEach(function(tr){
        // Spaltenindex gemÃ¤Ã Tabellenkopf:
        // 1 Datum, 2 BÃ¶rse, 3 ID, 4 Paar, 5 Side, 6 Hebel, 7 Entry,
        // 8 Aktuell, 9 Margin USDT, 10 Coin, ...
        var cell = tr.querySelector('td:nth-child(9)');
        if(cell){
          var num = parseDeNum(cell.textContent);
          if(!isNaN(num)) sum += num;
        }
      });
      var el = document.getElementById('sum-open-margin');
      if(el){
        el.textContent = (sum).toLocaleString('de-DE', { maximumFractionDigits: 2 });
      }
    }catch(e){ /* nie UI blockieren */ }
  }
  // Nach jedem render() neu berechnen â ohne bestehende Logik zu Ã¤ndern
  if (typeof window.render === 'function'){
    var _render = window.render;
    window.render = function(){
      try{ _render.apply(this, arguments); }catch(e){}
      try{ recalcDomMarginSum(); }catch(e){};
    };
  }
  // Einmalig bei DOM-Ready und bei Tab-Klicks
  document.addEventListener('DOMContentLoaded', function(){ try{ recalcDomMarginSum(); }catch(e){} });
  document.addEventListener('click', function(ev){
    // Wenn Tabs gewechselt werden, neu rechnen (defensiv)
    if(ev.target && ev.target.classList && ev.target.classList.contains('tab-btn')){
      setTimeout(function(){ try{ recalcDomMarginSum(); }catch(e){} }, 0);
    }
  }, { passive: true });
  // ZusÃ¤tzlich beobachten wir Ãnderungen am TabellenkÃ¶rper
  var tbody = document.querySelector('#tab-open #tbl tbody');
  if (tbody && window.MutationObserver){
    var mo = new MutationObserver(function(){ if(window._renderingOpen) return; try{ recalcDomMarginSum(); }catch(e){} });
    mo.observe(tbody, { childList:true, subtree:true, characterData:true });
  }
})();
</script>
<script>
// ===== Enhancements (robust, non-blocking) =====
(function(){
  // -------------- Helpers --------------
  function parseNumDE(s){
    if (s==null) return NaN;
    s = String(s).replace(/\s+/g,'').replace(/\./g,'').replace(',', '.');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }
  function fmtDE(n, d2){
    try{
      return new Intl.NumberFormat('de-DE', { minimumFractionDigits: d2?2:0, maximumFractionDigits: 2 }).format(Number(n)||0);
    }catch(_){ return String(n); }
  }
  function headerIndexMap(table){
    var map = {};
    try{
      var ths = table.querySelectorAll('thead th');
      for (var i=0;i<ths.length;i++){
        var t = (ths[i].textContent||'').trim();
        if (!t) continue;
        map[t] = i; // 0-based
      }
    }catch(_){}
    return map;
  }
  // -------------- Error toast (only on first error) --------------
  (function setupErrorToast(){
    var shown = false;
    window.addEventListener('error', function(ev){
      if(shown) return; shown = true;
      try{
        var box=document.createElement('div');
        box.style.position='fixed'; box.style.bottom='12px'; box.style.right='12px';
        box.style.background='rgba(239,68,68,.95)'; box.style.color='#fff';
        box.style.padding='10px 12px'; box.style.borderRadius='10px'; box.style.zIndex='99999';
        box.style.font='12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial';
        box.textContent = 'JS-Fehler: '+(ev.message||'')+' @'+(ev.filename||'')+':'+(ev.lineno||'');
        document.body.appendChild(box);
        setTimeout(function(){ if(box.parentNode) box.parentNode.removeChild(box); }, 10000);
      }catch(_){}
    }, { once:true });
  })();
  // -------------- Enhanced Gesamtsumme (Margin + Positionssumme) --------------
  (function patchUpdateOpenMarginSum(){
    if (typeof window.updateOpenMarginSum !== 'function') return;
    var _orig = window.updateOpenMarginSum;
    window.updateOpenMarginSum = function(){
      try{
        _orig(); // keep original behavior for margin
      }catch(_){}
      try{
        var table = document.getElementById('tbl');
        var outMargin = document.getElementById('sum-open-margin');
        var outPos = document.getElementById('sum-open-pos');
        if(!table || !table.tBodies || !table.tBodies[0]) return;
        var map = headerIndexMap(table);
        var idxMargin = (map['Margin USDT']!=null? map['Margin USDT'] : (map['Margin']!=null? map['Margin'] : null));
        var idxLev = map['Hebel'];
        var idxPos = (map['PositionsgrÃ¶Ãe (USDT)']!=null? map['PositionsgrÃ¶Ãe (USDT)'] : (map['PositionsgrÃ¶Ãe']!=null? map['PositionsgrÃ¶Ãe'] : null));
        var rows = Array.from(table.tBodies[0].rows||[]).filter(function(r){ return r.style.display !== 'none'; });
        var sumMargin = 0, sumPos = 0;
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var m = (idxMargin!=null && r.cells[idxMargin]) ? parseNumDE(r.cells[idxMargin].textContent) : NaN;
          if(!isNaN(m)) sumMargin += m;
          var p = NaN;
          if (idxPos!=null && r.cells[idxPos]){
            p = parseNumDE(r.cells[idxPos].textContent);
          }
          if (isNaN(p) && idxLev!=null && r.cells[idxLev]){
            var l = parseNumDE(r.cells[idxLev].textContent);
            if(!isNaN(m) && !isNaN(l)) p = m*l;
          }
          if(!isNaN(p)) sumPos += p;
        }
        if (outMargin) outMargin.textContent = fmtDE(sumMargin, true);
        if (outPos) outPos.textContent = fmtDE(sumPos, true);
      }catch(_){ /* never block */ }
    };
  })();
  // -------------- Debounced filters --------------
  (function setupDebounceFilters(){
    function debounce(fn, ms){ var t; return function(){ var a=arguments, self=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(self,a); }, ms); }; }
    var fire = debounce(function(){
      try{ if (typeof window.render === 'function') window.render(); }catch(_){}
    }, 200);
    ['ftr-q','ftr-from','ftr-to'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.addEventListener('input', fire, { passive:true });
      if (el) el.addEventListener('change', fire);
    });
  })();
  // -------------- CSV Export (Closed) if present --------------
  (function setupClosedCsv(){
    var btn = document.getElementById('btn-export-closed-csv');
    var table = document.querySelector('#tab-closed table, #tbl-closed');
    if (!btn || !table) return;
    btn.addEventListener('click', function(){
      try{
        var rows = [];
        var trs = table.querySelectorAll('tr');
        trs.forEach(function(tr){
          var cells = tr.querySelectorAll('th,td');
          var row = [];
          cells.forEach(function(c){
            var t = (c.textContent||'').trim().replace(/"/g,'""');
            row.push('"'+t+'"');
          });
          rows.push(row.join(','));
        });
        var csv = rows.join('\r\n');
        var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = 'abgeschlossene_trades.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
      }catch(_){}
    });
  })();
  // -------------- Backup/Restore (optional, minimal) --------------
  (function setupBackupRestore(){
    try{
      // Try to find a toolbox container; otherwise, create a minimal floating pill
      var host = document.getElementById('toolbox');
      if (!host){
        host = document.createElement('div');
        host.style.position='fixed'; host.style.bottom='16px'; host.style.left='16px';
        host.style.background='var(--panel,rgba(17,24,39,.9))'; host.style.color='var(--text,#e5e7eb)';
        host.style.border='1px solid var(--border,#1f2937)'; host.style.padding='6px 8px';
        host.style.borderRadius='999px'; host.style.font='12px/1 system-ui';
        host.style.zIndex='9999'; host.style.opacity='0.9';
        document.body.appendChild(host);
      }
      var btnB = document.createElement('button');
      btnB.textContent = 'Backup';
      btnB.style.marginRight='6px';
      var btnR = document.createElement('button');
      btnR.textContent = 'Restore';
      [btnB,btnR].forEach(function(b){
        b.style.background='transparent'; b.style.color='inherit'; b.style.border='1px solid var(--border,#374151)';
        b.style.padding='4px 10px'; b.style.borderRadius='999px'; b.style.cursor='pointer';
      });
      host.appendChild(btnB); host.appendChild(btnR);
      btnB.addEventListener('click', function(){
        try{
          var data = window.trades ? JSON.stringify(window.trades, null, 2) : JSON.stringify({ htmlTableDump: document.querySelector('#tab-open #tbl')?.outerHTML||'' }, null, 2);
          var blob = new Blob([data], {type:'application/json'});
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href=url; a.download='backup_trades.json';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
        }catch(_){}
      });
      btnR.addEventListener('click', function(){
        try{
          var inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
          inp.onchange = function(){
            var f = inp.files && inp.files[0]; if(!f) return;
            var rd = new FileReader();
            rd.onload = function(){
              try{
                var obj = JSON.parse(String(rd.result||'{}'));
                // If it looks like a trades array and an importer exists
                if (Array.isArray(obj) && window.loadDataFromJson){
                  window.loadDataFromJson(obj); // hypothetical hook in your app
                  if (typeof window.render === 'function') window.render();
                } else {
                  alert('Die geladene Datei konnte nicht automatisch eingespielt werden.\nBackup wurde nur lokal gesichert.');
                }
              }catch(e){
                alert('UngÃ¼ltige JSONâDatei.');
              }
            };
            rd.readAsText(f);
          };
          inp.click();
        }catch(_){}
      });
    }catch(_){}
  })();
  // -------------- Optional Gesamtsumme-Block unter der Tabelle --------------
  (function setupGesamtsummeBlock(){
    try{
      var host = document.querySelector('#tab-open .table-wrap');
      if(!host) return;
      if (document.getElementById('open-sums-box')) return;
      var box = document.createElement('div');
      box.id = 'open-sums-box';
      box.style.marginTop = '12px';
      box.style.border = '1px solid var(--border,#1f2937)';
      box.style.borderRadius = '10px';
      box.style.padding = '8px 12px';
      box.style.background = 'var(--panel-2,rgba(31,41,55,.35))';
      box.innerHTML = '<div style="font-weight:600;margin-bottom:6px">Gesamtsumme (laufende Trades)</div>\
      <div id="open-sums-grid" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px">\
        <div><div style="opacity:.7">Margin</div><div id="sum-all-margin" style="font-weight:600"></div></div>\
        <div><div style="opacity:.7">PositionsgrÃ¶Ãe</div><div id="sum-all-pos" style="font-weight:600"></div></div>\
        <div><div style="opacity:.7">Unreal PnL (inkl. Grid)</div><div id="sum-all-unreal" style="font-weight:600"></div></div>\
        <div><div style="opacity:.7">Unreal % (gewichtet)</div><div id="sum-all-upctw" style="font-weight:600"></div></div>\
      </div>';
      host.parentNode.insertBefore(box, host.nextSibling);
      function recalc(){
        var table = document.getElementById('tbl');
        if(!table) return;
        var map = headerIndexMap(table);
        var idxMargin = map['Margin USDT']!=null? map['Margin USDT'] : (map['Margin']!=null? map['Margin'] : null);
        var idxLev    = map['Hebel'];
var idxUnreal = (map['Unreal PnL (inkl. Grid)']!=null ? map['Unreal PnL (inkl. Grid)']
               : (map['Unreal PnL(inkl. Grid) USDT']!=null ? map['Unreal PnL(inkl. Grid) USDT']
               : (map['Unreal PnL (inkl. Grid) USDT']!=null ? map['Unreal PnL (inkl. Grid) USDT']
               : (map['Unreal (USDT)']!=null ? map['Unreal (USDT)'] : null))));
        var idxGrid   = map['Grid PnL (BOT)']!=null? map['Grid PnL (BOT)'] : (map['Grid PnL']!=null? map['Grid PnL'] : null);
        var idxPct    = map['Unreal %']!=null? map['Unreal %'] : null;
        var rows = Array.from(table.tBodies[0]?.rows||[]).filter(function(r){ return r.style.display !== 'none'; });
        var sumM=0, sumP=0, sumU=0, wPct=0, w=0;
        rows.forEach(function(r){
          var m = (idxMargin!=null && r.cells[idxMargin])? parseNumDE(r.cells[idxMargin].textContent) : NaN;
          if(!isNaN(m)) sumM += m;
          var l = (idxLev!=null && r.cells[idxLev])? parseNumDE(r.cells[idxLev].textContent) : NaN;
          var p = (!isNaN(m)&&!isNaN(l)) ? (m*l) : NaN;
          if(!isNaN(p)) sumP += p;
          var u = (idxUnreal!=null && r.cells[idxUnreal])? parseNumDE(r.cells[idxUnreal].textContent) : 0;
          var g = (idxGrid!=null && r.cells[idxGrid])? parseNumDE(r.cells[idxGrid].textContent) : 0;
          sumU += (isNaN(u)?0:u) + (isNaN(g)?0:g);
          var pct = (idxPct!=null && r.cells[idxPct])? parseNumDE(r.cells[idxPct].textContent) : NaN;
          if(!isNaN(pct) && !isNaN(m)){ wPct += pct*m; w += m; }
        });
        var fmt = new Intl.NumberFormat('de-DE', { maximumFractionDigits:2 });
        var elM = document.getElementById('sum-all-margin');
        var elP = document.getElementById('sum-all-pos');
        var elU = document.getElementById('sum-all-unreal');
        var elW = document.getElementById('sum-all-upctw');
        if(elM) elM.textContent = fmt.format(sumM) + ' USDT';
        if(elP) elP.textContent = fmt.format(sumP) + ' USDT';
        if(elU) elU.textContent = (sumU>=0?'+':'') + fmt.format(sumU) + ' USDT';
        if(elW) elW.textContent = fmt.format(w? (wPct/w) : 0) + ' %';
      }
      // recalc initially and when the main render runs
      document.addEventListener('DOMContentLoaded', function(){ try{ recalc(); }catch(_){}});
      var tbody = document.querySelector('#tab-open #tbl tbody');
      if (tbody && window.MutationObserver){
        var mo = new MutationObserver(function(){ try{ recalc(); }catch(_){}});
        mo.observe(tbody, { childList:true, subtree:true, characterData:true });
      }
    }catch(_){}
  })();
})(); // end IIFE
// --- Gesamtsummen fÃ¼r Abgeschlossene Trades ---
function updateClosedPageSums(){
  try {
    let sumMargin = 0, sumSize = 0, sumFee = 0, sumReal = 0;
    let pctVals = [];
    closedRows.forEach((t)=>{
      const sizes = ensureSizes(t);
      const sizeUSDT = sizes.sizeUSDT;
      const r = calcReal(t);
      const rPct = (sizeUSDT && r.pnl!=null) ? (r.pnl/sizeUSDT*100) : null;
      sumMargin += Number(t.margin||0);
      sumSize   += Number(sizeUSDT||0);
      sumFee    += Number(t.fee||0);
      sumReal   += Number(r.pnl||0);
      if (rPct!=null && isFinite(rPct)) pctVals.push(rPct);
    });
    const set = (id, text) => { const el=document.getElementById(id); if(el) el.textContent=text; };
    set('sum-closed-margin', fmt2(sumMargin) + ' USDT');
    set('sum-closed-size',   fmt2(sumSize)   + ' USDT');
    set('sum-closed-fee',    fmt2(sumFee)    + ' USDT');
    (function(){
      const el = document.getElementById('sum-closed-real');
      if (!el) return;
      el.textContent = (sumReal>=0?'+':'') + fmt2(sumReal) + ' USDT';
      el.classList.remove('pos','neg');
      if (sumReal>0) el.classList.add('pos');
      if (sumReal<0) el.classList.add('neg');
    })();
    (function(){
      const el = document.getElementById('sum-closed-pct');
      if (!el) return;
      const avg = pctVals.length? (pctVals.reduce((a,b)=>a+b,0) / pctVals.length) : 0;
      el.textContent = (avg>=0?'+':'') + fmt2(avg) + ' %';
      el.classList.remove('pos','neg');
      if (avg>0) el.classList.add('pos');
      if (avg<0) el.classList.add('neg');
    })();
  } catch(e) {}
}
</script>
<script>
(function(){
  function parseDE(nStr){
    if(!nStr) return 0;
    const s = String(nStr).replace(/\u00A0/g,' ').trim(); // nbsp
    // remove currency and %
    const s2 = s.replace(/USDT|\%|\+|/g,'').replace(/\s/g,'');
    // handle de-DE numbers like -1.234,56
    const noDots = s2.replace(/\./g,'');
    const normalized = noDots.replace(/,/g,'.');
    const v = parseFloat(normalized);
    return isFinite(v)? v : 0;
  }
  function fmtDE(n, frac=2){
    try{
      return (Number(n)||0).toLocaleString('de-DE',{maximumFractionDigits:frac, minimumFractionDigits:2});
    }catch(e){ return String(n); }
  }
  function updateClosedFooterSums(){
    const tbody = document.querySelector('#tbl-closed tbody');
    const realCell = document.querySelector('#sum-closed-real');
    const pctCell  = document.querySelector('#sum-closed-pct');
    if(!tbody || !realCell || !pctCell) return;
    let sumReal = 0, sumPct = 0;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if(tds.length >= 13){
        const realTxt = tds[11].textContent; // Real PnL (12th col -> index 11)
        const pctTxt  = tds[12].textContent; // Real %  (13th col -> index 12)
        sumReal += parseDE(realTxt);
        sumPct  += parseDE(pctTxt);
      }
    });
    // write values
    if(realCell){
      realCell.textContent = (sumReal>=0?'+':'') + fmtDE(sumReal) + ' USDT';
      realCell.classList.remove('pos','neg');
      if(sumReal>0) realCell.classList.add('pos');
      if(sumReal<0) realCell.classList.add('neg');
    }
    if(pctCell){
      pctCell.textContent = (sumPct>=0?'+':'') + fmtDE(sumPct) + ' %';
      pctCell.classList.remove('pos','neg');
      if(sumPct>0) pctCell.classList.add('pos');
      if(sumPct<0) pctCell.classList.add('neg');
    }
  }
  // Observe body for changes to closed rows
  const target = document.querySelector('#tbl-closed tbody');
  if(target){
    const obs = new MutationObserver(()=>{ updateClosedFooterSums(); });
    obs.observe(target, {childList:true, subtree:true, characterData:true});
  }
  document.addEventListener('DOMContentLoaded', updateClosedFooterSums);
  window.addEventListener('load', updateClosedFooterSums);
  // also try interval once after 250ms to catch initial render
  setTimeout(updateClosedFooterSums, 300);
  // expose globally if needed
  window.updateClosedFooterSums = updateClosedFooterSums;
})();
</script>
<script>
/* ===== Verbesserte Filter-Logik fÃ¼r "Abgeschlossene Trades" ===== */
(function(){
  function q(sel){ return document.querySelector(sel); }
  function qa(sel, root){ return (root||document).querySelectorAll(sel); }
  function parseDENum(txt){
    if(!txt) return 0;
    const s = String(txt).replace(/\u00A0/g,' ').replace(/[^\d,.\-]/g,''); // remove labels
    const noDots = s.replace(/\./g,'');
    const normalized = noDots.replace(/,/g,'.');
    const v = parseFloat(normalized);
    return isFinite(v)? v : 0;
  }
  function rowVisible(tr){
    return !(tr.style.display==='none' || tr.hidden);
  }
  function inferStatusByReal(realVal){
    if(realVal > 0) return 'win';
    if(realVal < 0) return 'loss';
    return 'zero';
  }
  function inDateRange(dateStr, fromStr, toStr){
    if(!dateStr) return false;
    try{
      const d = new Date(dateStr);
      if(String(d) === 'Invalid Date') return false;
      if(fromStr){
        const f = new Date(fromStr + 'T00:00:00');
        if(d < f) return false;
      }
      if(toStr){
        const t = new Date(toStr + 'T23:59:59');
        if(d > t) return false;
      }
      return true;
    }catch(e){ return false; }
  }
  function applyClosedFilters(){
    const exSel = q('#fcl-exchange')?.value || '';
    const stSel = q('#fcl-status')?.value || ''; // win/loss/zero
    const sdSel = q('#fcl-side')?.value || '';   // LONG/Short mapping expected
    const qTxt  = (q('#fcl-q')?.value || '').trim().toLowerCase();
    const from  = q('#fcl-from')?.value || '';
    const to    = q('#fcl-to')?.value || '';
    const tbody = q('#tbl-closed tbody');
    if(!tbody) return;
    qa('tr', tbody).forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if(tds.length < 13){ tr.style.display=''; return; }
      const exitDate = tds[0].textContent.trim();
      const exchange = tds[1].textContent.trim();
      const idTxt    = tds[2].textContent.trim().toLowerCase();
      const pairTxt  = tds[3].textContent.trim().toLowerCase();
      const sideTxt  = tds[4].textContent.toLowerCase().includes('short') ? 'SHORT' : 'LONG';
      const realVal  = parseDENum(tds[11].textContent);
      const statusByReal = inferStatusByReal(realVal);
      let ok = true;
      if(exSel && exSel!=='Alle' && exchange !== exSel) ok = false;
      if(stSel && statusByReal !== stSel) ok = false;
      if(sdSel && sdSel.toUpperCase() !== sideTxt) ok = false;
      if(qTxt && !(pairTxt.includes(qTxt) || idTxt.includes(qTxt))) ok = false;
      if((from || to) && !inDateRange(exitDate, from, to)) ok = false;
      tr.style.display = ok ? '' : 'none';
    });
    // Nach dem Filtern: Summen nur der sichtbaren Zeilen neu berechnen
    try{ updateClosedFooterSums(true); }catch(e){}
  }
  // Ãberschreibe updateClosedFooterSums so, dass nur sichtbare Zeilen gezÃ¤hlt werden
  window.updateClosedFooterSums = function(onlyVisible){
    const tbody = document.querySelector('#tbl-closed tbody');
    const realCell = document.querySelector('#sum-closed-real');
    const pctCell  = document.querySelector('#sum-closed-pct');
    if(!tbody || !realCell || !pctCell) return;
    let sumReal = 0, sumPct = 0;
    tbody.querySelectorAll('tr').forEach(tr=>{
      if(onlyVisible && (tr.style.display==='none' || tr.hidden)) return;
      const tds = tr.querySelectorAll('td');
      if(tds.length >= 13){
        const realTxt = tds[11].textContent;
        const pctTxt  = tds[12].textContent;
        sumReal += parseDENum(realTxt);
        sumPct  += parseDENum(pctTxt);
      }
    });
    function fmtDE(n){ return (Number(n)||0).toLocaleString('de-DE',{maximumFractionDigits:2, minimumFractionDigits:2}); }
    realCell.textContent = (sumReal>=0?'+':'') + fmtDE(sumReal) + ' USDT';
    realCell.classList.remove('pos','neg');
    if(sumReal>0) realCell.classList.add('pos');
    if(sumReal<0) realCell.classList.add('neg');
    pctCell.textContent = (sumPct>=0?'+':'') + fmtDE(sumPct) + ' %';
    pctCell.classList.remove('pos','neg');
    if(sumPct>0) pctCell.classList.add('pos');
    if(sumPct<0) pctCell.classList.add('neg');
  };
  // Events binden
  ['#fcl-exchange','#fcl-status','#fcl-side','#fcl-q','#fcl-from','#fcl-to'].forEach(sel=>{
    const el = q(sel);
    if(el){ el.addEventListener('input', applyClosedFilters); el.addEventListener('change', applyClosedFilters); }
  });
  // Reagieren auf dynamisches Rendering
  const closedTbody = q('#tbl-closed tbody');
  if(closedTbody){
    const obs = new MutationObserver(()=>{ applyClosedFilters(); });
    obs.observe(closedTbody, {childList:true, subtree:true});
  }
  // Erste Initialisierung
  window.addEventListener('load', applyClosedFilters);
  document.addEventListener('DOMContentLoaded', applyClosedFilters);
  setTimeout(applyClosedFilters, 400);
})();
</script>
<script>
/* Export âLaufende Tradesâ: nur Zeilen mit Status=Offen aus #tab-open #tbl */
(function(){
  function exportOpenTradesOnly(){
    const table = document.querySelector('#tab-open #tbl');
    if(!table){ console.warn('Open table (#tab-open #tbl) not found'); return; }
    const ths = Array.from(table.querySelectorAll('thead th'));
    const headers = ths.map(th => th.textContent.trim());
    const statusIdx = ths.findIndex(th => th.textContent.trim().toLowerCase() === 'status');
    const rows = [headers];
    const trs = table.querySelectorAll('tbody tr');
    trs.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if(!tds.length) return;
      let isOpen = true;
      if(statusIdx >= 0){
        const statusTxt = (tds[statusIdx]?.textContent || '').trim().toLowerCase();
        isOpen = (statusTxt === 'offen' || statusTxt === 'open');
      }
      // If there's any explicit 'geschlossen' class/flag, treat as closed
      if(tr.classList.contains('closed') || tr.dataset.closed === 'true') isOpen = false;
      if(isOpen){
        rows.push(Array.from(tds, td => td.innerText.trim()));
      }
    });
    if(rows.length <= 1){
      alert('Keine offenen Positionen zum Exportieren gefunden.');
      return;
    }
    try{
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Laufende Trades');
      XLSX.writeFile(wb, 'laufende_trades_nur_offen.xlsx');
    }catch(e){
      console.error('Export fehlgeschlagen:', e);
      alert('Export fehlgeschlagen: ' + (e && e.message ? e.message : e));
    }
  }
  function bind(){
    const btn = document.querySelector('#tab-open #btn-export-xlsx') || document.querySelector('#btn-export-xlsx');
    if(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        exportOpenTradesOnly();
      });
    }
  }
  window.addEventListener('load', bind);
  document.addEventListener('DOMContentLoaded', bind);
  setTimeout(bind, 300);
})();
</script>
<script>
/* Closed Trades Footer: Margin USDT = 0 ausblenden (Text leeren, Platz bleibt) */
(function(){
  function parseDE(nStr){
    if(!nStr) return 0;
    const s = String(nStr).replace(/\u00A0/g,' ').replace(/[^\d,\.\-]/g,'');
    const noDots = s.replace(/\./g,'');
    const normalized = noDots.replace(/,/g,'.');
    const v = parseFloat(normalized);
    return isFinite(v)? v : 0;
  }
  function hideZeroClosedMargin(){
    const table = document.querySelector('#tbl-closed') || document.querySelector('#tab-closed #tbl-closed');
    if(!table) return;
    const ths = Array.from(table.querySelectorAll('thead th'));
    const idx = ths.findIndex(th => th.textContent.trim().toLowerCase().includes('margin'));
    if(idx < 0) return;
    const tf = table.querySelector('tfoot');
    if(!tf) return;
    const tds = tf.querySelectorAll('td');
    const cell = tds[idx];
    if(!cell) return;
    const val = parseDE(cell.textContent);
    if(val === 0){
      cell.textContent = '';
      cell.classList.add('muted');
      // optional: ensure height stays consistent
      cell.style.minHeight = '1.25rem';
    }
  }
  // Run at key lifecycle points
  document.addEventListener('DOMContentLoaded', hideZeroClosedMargin);
  window.addEventListener('load', hideZeroClosedMargin);
  setTimeout(hideZeroClosedMargin, 300);
  // If other code updates footer sums, expose and call
  window.hideZeroClosedMargin = hideZeroClosedMargin;
  // Observe tfoot changes to re-apply
  const tf = document.querySelector('#tbl-closed tfoot');
  if(tf){
    const obs = new MutationObserver(hideZeroClosedMargin);
    obs.observe(tf, {childList:true, subtree:true, characterData:true});
  }
})();
</script>
<script>
// ====== Reale PnL Chart (Geschlossene) â kompakt & robust ======
let closedRealChart = null;
let closedChartRange = '30';     // 1,7,30,all
let closedChartYear  = String(new Date().getFullYear()); // default: aktuelles Jahr
function fmtDateLabelISO(iso){
  const dt = new Date(iso);
  return dt.toLocaleDateString('de-DE');
}
function startOfDayISO(d){
  const dt = new Date(d); dt.setHours(0,0,0,0);
  return dt.toISOString().slice(0,10);
}
function groupClosedRealDaily(){
  // Map by ISO day -> sum(real)
  const map = new Map();
  trades.forEach(t=>{
    if(t.status!=='Geschlossen' || !t.closedAt) return;
    const r = calcReal(t).pnl;
    if(r==null) return;
    const iso = startOfDayISO(t.closedAt);
    map.set(iso, (map.get(iso)||0) + Number(r));
  });
  return [...map.entries()].sort((a,b)=> new Date(a[0]) - new Date(b[0]));
}
function getAvailableYears(){
  const years = new Set();
  const nowY = new Date().getFullYear();
  groupClosedRealDaily().forEach(([iso])=> years.add(new Date(iso).getFullYear()));
  for(let y=nowY-2; y<=nowY+4; y++) years.add(y);
  return [...years].sort((a,b)=> a-b);
}
function populateClosedYearDropdown(){
  const sel = document.getElementById('closed-year-select');
  if(!sel) return;
  const current = closedChartYear || String(new Date().getFullYear());
  sel.innerHTML = '<option value="all">Alle Jahre</option>';
  getAvailableYears().forEach(y=>{
    const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
    sel.appendChild(opt);
  });
  sel.value = current;
}
function buildSeries(rangeOpt){
  // build daily cumulative series, filtered by year (if not 'all') and by range
  const all = groupClosedRealDaily();
  let arr = all;
  if(closedChartYear !== 'all'){
    arr = arr.filter(([iso])=> String(new Date(iso).getFullYear()) === String(closedChartYear));
  }
  let cutoff = null;
  if(rangeOpt !== 'all'){
    const days = Number(rangeOpt||30);
    cutoff = new Date(); cutoff.setHours(0,0,0,0); cutoff.setDate(cutoff.getDate()-days);
  }
  if(cutoff){
    arr = arr.filter(([iso])=> new Date(iso) >= cutoff);
  }
  let cum = 0;
  const labels = [], data = [];
  arr.forEach(([iso,val])=>{ cum += val; labels.push(fmtDateLabelISO(iso)); data.push(Number(cum.toFixed(2))); });
  const change = data.length>=2 ? (data[data.length-1]-data[0]) : (data[0]||0)||0;
  return {labels, data, change};
}
function getBrand(){
  const v = getComputedStyle(document.documentElement).getPropertyValue('--brand');
  return (v && v.trim()) || '#60a5fa';
}
function renderClosedRealChart(rangeOpt){
  closedChartRange = rangeOpt || closedChartRange;
  const canvas = document.getElementById('closed-real-chart');
  if(!canvas){ return; }
  const ctx = canvas.getContext('2d');
  if(!ctx){ return; }
  const series = buildSeries(closedChartRange);
  // Destroy previous chart safely
  if(closedRealChart && typeof closedRealChart.destroy === 'function'){ try{ closedRealChart.destroy(); }catch(e){} }
  // Gradient creation guarded by chartArea availability
  const brand = getBrand();
  const gradBuilder = (context)=>{
    const chart = context.chart;
    const area = chart.chartArea;
    try{
      if(!area){ return brand; }
      const g = chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
      // fallback alpha handling
      const rgb = brand.startsWith('rgb') ? brand.replace('rgb','rgba').replace(')',',') : 'rgba(96,165,250,';
      g.addColorStop(0, rgb + '0.25)');
      g.addColorStop(1, 'rgba(0,0,0,0)');
      return g;
    }catch(e){ return brand; }
  };
  closedRealChart = new Chart(ctx, {
    type: 'line',
    data: { labels: series.labels, datasets: [{
      label: 'Kumulierte Reale PnL',
      data: series.data,
      borderWidth: 2,
      tension: 0.25,
      pointRadius: 0,
      pointHoverRadius: 3,
      fill: true,
      borderColor: brand,
      backgroundColor: gradBuilder
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip: { callbacks: {
        label: (c)=> (c.parsed.y>=0?'+':'')+fmt2(c.parsed.y)+' USDT'
      }}},
      layout: { padding: { left:6, right:6, top:4, bottom:0 } },
      scales: {
        x: { grid: { display:false }, ticks: { autoSkip:true, maxTicksLimit:8 } },
        y: { grid: { color:'rgba(255,255,255,0.06)' }, ticks: { callback: (v)=> fmt2(v) } }
      },
      interaction: { intersect:false, mode:'index' }
    }
  });
  const sub = document.getElementById('closed-real-sub');
  const chg = (series.change>=0?'+':'') + fmt2(series.change);
  sub.textContent = series.labels.length ? `${series.labels[0]} â ${series.labels[series.labels.length-1]} Â· VerÃ¤nderung: ${chg} USDT` : 'Keine Daten';
}
// Controls
document.addEventListener('click', (e)=>{
  const r = e.target.getAttribute && e.target.getAttribute('data-crange');
  if(r){ renderClosedRealChart(r); }
});
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id==='closed-year-select'){
    closedChartYear = e.target.value || 'all';
    renderClosedRealChart(closedChartRange);
  }
});
// Show panel only on Closed tab
(function(){
  const analytics = document.getElementById('tab-closed-analytics');
  const hook = ()=>{
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.tab;
        if(id==='tab-closed'){
          analytics.style.display='';
          populateClosedYearDropdown();
          setTimeout(()=> renderClosedRealChart(closedChartRange), 50);
        }else{
          analytics.style.display='none';
        }
      });
    });
  };
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hook);
  }else{
    hook();
  }
})();
</script>
<script>
// ===== Manual Refresh Button for Reale PnL Chart =====
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('btn-refresh-chart');
  if(btn){
    btn.addEventListener('click', ()=>{
      populateClosedYearDropdown();
      renderClosedRealChart(closedChartRange);
    });
  }
});
</script>
<script>
// ===== Delete Only Cash =====
(function(){
  function clearCash(){
    if(!confirm('Wirklich ALLE KasseneintrÃ¤ge lÃ¶schen?')) return;
    try{
      localStorage.removeItem('futures-tracker-cash');
      cash = [];
      saveCash && saveCash();
      renderCash && renderCash();
      alert('Alle KasseneintrÃ¤ge wurden gelÃ¶scht.');
    }catch(e){
      alert('Fehler beim LÃ¶schen der Kasse: ' + e.message);
    }
  }
  function clearTrades(){
    if(!confirm('Wirklich ALLE laufenden Trades lÃ¶schen?')) return;
    try{
      localStorage.removeItem('futures-tracker-trades');
      trades = [];
      save && save();
      render && render();
      updateDashboard && updateDashboard();
      alert('Alle laufenden Trades wurden gelÃ¶scht.');
    }catch(e){
      alert('Fehler beim LÃ¶schen der Trades: ' + e.message);
    }
  }
  const hook = ()=>{
    const btnCash = document.getElementById('btn-clear-cash');
    const btnTrades = document.getElementById('btn-clear-trades');
    if(btnCash) btnCash.addEventListener('click', clearCash);
    if(btnTrades) btnTrades.addEventListener('click', clearTrades);
  };
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hook);
  } else {
    hook();
  }
})();
</script>
<script>
// ===== SAFE delete handlers: only on explicit clicks, with double-confirm =====
(function(){
  function doubleConfirm(msg1, msg2){
    if(!confirm(msg1)) return false;
    return confirm(msg2);
  }
  function clearCashSafe(){
    if(!doubleConfirm('Wirklich ALLE KasseneintrÃ¤ge lÃ¶schen?', 'Letzte Warnung: Dieser Vorgang kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) return;
    try{
      localStorage.removeItem('futures-tracker-cash');
      if(window.cash) cash = [];
      if(typeof saveCash==='function') saveCash();
      if(typeof renderCash==='function') renderCash();
      if(typeof updateDashboard==='function') updateDashboard();
      alert('Alle KasseneintrÃ¤ge wurden gelÃ¶scht.');
    }catch(e){
      alert('Fehler beim LÃ¶schen der Kasse: ' + e.message);
    }
  }
  function clearTradesSafe(){
    if(!doubleConfirm('Wirklich ALLE laufenden Trades lÃ¶schen?', 'Letzte Warnung: Dieser Vorgang kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) return;
    try{
      // Nur offene/laufende Trades lÃ¶schen, geschlossene behalten
      if(Array.isArray(window.trades)){
        window.trades = window.trades.filter(t => t && t.status === 'Geschlossen');
        localStorage.setItem('futures-tracker-trades', JSON.stringify(window.trades));
      } else {
        // Fallback: laden, filtern, speichern
        try{
          const arr = JSON.parse(localStorage.getItem('futures-tracker-trades')||'[]');
          const kept = arr.filter(t => t && t.status === 'Geschlossen');
          localStorage.setItem('futures-tracker-trades', JSON.stringify(kept));
          window.trades = kept;
        }catch(e){}
      }
      if(typeof save==='function') save();
      if(typeof render==='function') render();
      if(typeof updateDashboard==='function') updateDashboard();
      alert('Alle laufenden Trades wurden gelÃ¶scht (geschlossene bleiben erhalten).');
    }catch(e){
      alert('Fehler beim LÃ¶schen der Trades: ' + e.message);
    }
  }
  function hook(){
    const btnCash = document.getElementById('btn-clear-cash');
    const btnTrades = document.getElementById('btn-clear-trades');
    if(btnCash) btnCash.addEventListener('click', clearCashSafe);
    if(btnTrades) btnTrades.addEventListener('click', clearTradesSafe);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hook);
  } else {
    hook();
  }
})();
</script>
<script>
// ===== Standard: BÃ¶rsen-Filter immer "Alle" nach Reload (alle Tabs) =====
document.addEventListener('DOMContentLoaded', function(){
  try{
    const ids = ['ftr-exchange','fcl-exchange'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        // Set to "Alle" (value = '')
        el.value = '';
      }
    });
    if(typeof render==='function'){ render(); }
  }catch(e){ /* no-op */ }
});
</script>
<script>
// ===== Robust 'Alle' default and no auto-revert =====
(function(){
  // Track desired values per select (default: '')
  const desired = {
    'ftr-exchange': '',
    'fcl-exchange': ''
  };
  function applyDesired(){
    Object.keys(desired).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      // Only set if value differs from desired
      if(el.value !== desired[id]){
        el.value = desired[id];
      }
    });
  }
  function wireChangeHandlers(){
    ['ftr-exchange','fcl-exchange'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('change', ()=>{
        // Store user choice; default is '' (Alle)
        desired[id] = el.value || '';
      });
    });
  }
  // Wrap global render to re-apply after any programmatic changes
  const wrapRender = ()=>{
    if(typeof window.render === 'function'){
      const orig = window.render;
      window.render = function(){
        const r = orig.apply(this, arguments);
        // After table rebuilds, enforce user's desired selection
        /* keep current filter; no forced applyDesired() here */
  document.getElementById('fcl-exchange')?.value==='Alle' && (document.getElementById('fcl-exchange').value='');
  document.getElementById('ftr-exchange')?.value==='Alle' && (document.getElementById('ftr-exchange').value='');
        return r;
      };
    }
  };
  function init(){
    wireChangeHandlers();
    wrapRender();
    // Initial enforce on load
    /* keep current filter; no forced applyDesired() here */
  document.getElementById('fcl-exchange')?.value==='Alle' && (document.getElementById('fcl-exchange').value='');
  document.getElementById('ftr-exchange')?.value==='Alle' && (document.getElementById('ftr-exchange').value='');
    // Small guard if some code reverts shortly after
    /* applyDesired disabled */
    /* applyDesired disabled */
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<script>
// --- Kompakte Filterlogik (stabil & leicht erweiterbar) ---
// "Alle" (leerer Wert) zeigt alles. Keine Auto-Defaults.
(function(){
  function idxByHeader(table, names){
    names = names.map(n=>n.toLowerCase());
    const ths = Array.from(table.querySelectorAll('thead th'));
    for(let i=0;i<ths.length;i++){
      const t = (ths[i].textContent||'').trim().toLowerCase();
      if(names.includes(t)) return i;
    }
    return -1;
  }
  function parseDate(s){
    if(!s) return null;
    const d = new Date(s);
    if(!isNaN(d)) return d;
    const m = (s+'').match(/(\d{2})\.(\d{2})\.(\d{4})/);
    return m ? new Date(+m[3], +m[2]-1, +m[1]) : null;
  }
  function testExact(sel, cell){
    return (!sel || sel==='Alle') ? true : (String(cell||'').trim()===sel);
  }
  function testSide(sel, cell){
    if(!sel || sel==='Alle') return true;
    return String(cell||'').toUpperCase().includes(sel.toUpperCase());
  }
  function testStatus(sel, realCell){
    if(!sel || sel==='Alle') return true;
    const num = parseFloat(String(realCell||'').replace(',', '.'));
    if(isNaN(num)) return false;
    if(sel==='win')  return num>0;
    if(sel==='loss') return num<0;
    if(sel==='zero') return num===0;
    return true;
  }
  function testQuery(q, pair, id){
    if(!q) return true;
    q = q.toLowerCase();
    return (String(pair||'').toLowerCase().includes(q) || String(id||'').toLowerCase().includes(q));
  }
  function within(df, dt, cell){
    const d = parseDate(cell);
    if(!d) return true;
    if(df && d<df) return false;
    if(dt && d>dt) return false;
    return true;
  }
  function applyTableFilter(tableSel, conf){
    const table = document.querySelector(tableSel);
    if(!table) return;
    const exIdx = idxByHeader(table, ['bÃ¶rse','borse']);
    const idIdx = idxByHeader(table, ['id']);
    const pairIdx = idxByHeader(table, ['coin','coin wert','paar','pair']);
    const sideIdx = idxByHeader(table, ['richtung','side']);
    const realIdx = idxByHeader(table, ['real pnl (usdt)','real pnl','real %','real']);
    const dateIdx = idxByHeader(table, conf.dateHeader || ['datum','exit-datum','exit datum','date']);
    const v = id => (document.getElementById(id)?.value)||'';
    let exSel = conf.exchangeSel? v(conf.exchangeSel) : '';
    if(exSel==='Alle') exSel='';
    const sdSel= conf.sideSel? v(conf.sideSel) : '';
    const stSel= conf.statusSel? v(conf.statusSel) : '';
    const qTxt = (conf.querySel? v(conf.querySel):'').trim().toLowerCase();
    const dFrom= conf.fromSel? parseDate(v(conf.fromSel)) : null;
    const dTo  = conf.toSel?   parseDate(v(conf.toSel))   : null;

    const tbody = table.querySelector('tbody');
    if(!tbody) return;
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if(!tds.length){ tr.style.display=''; return; }
      const ex   = exIdx>=0? tds[exIdx].textContent.trim() : '';
      const idv  = idIdx>=0? tds[idIdx].textContent.trim() : '';
      const pair = pairIdx>=0? tds[pairIdx].textContent.trim() : '';
      const side = sideIdx>=0? tds[sideIdx].textContent.trim() : '';
      const real = realIdx>=0? tds[realIdx].textContent.trim() : '';
      const dcel = dateIdx>=0? tds[dateIdx].textContent.trim() : '';
      let ok = true;
      if(!testExact(exSel, ex)) ok=false;
      if(!testSide(sdSel, side)) ok=false;
      if(!testStatus(stSel, real)) ok=false;
      if(!testQuery(qTxt, pair, idv)) ok=false;
      if(!within(dFrom, dTo, dcel)) ok=false;
      tr.style.display = ok? '' : 'none';
    });
  }
  function applyOpenFilters(){
    applyTableFilter('#tbl', {
      exchangeSel:'ftr-exchange', statusSel:'ftr-status', sideSel:'ftr-side',
      querySel:'ftr-q', fromSel:'ftr-from', toSel:'ftr-to',
      dateHeader:['datum','date']
    });
  }
  function applyClosedFilters(){
    applyTableFilter('#tbl-closed', {
      exchangeSel:'fcl-exchange', statusSel:'fcl-status', sideSel:'fcl-side',
      querySel:'fcl-q', fromSel:'fcl-from', toSel:'fcl-to',
      dateHeader:['exit-datum','exit datum']
    });
  }
  function wireFilterEvents(){
    const ids=['ftr-exchange','ftr-status','ftr-side','ftr-q','ftr-from','ftr-to',
               'fcl-exchange','fcl-status','fcl-side','fcl-q','fcl-from','fcl-to'];
    ids.forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('input', ()=>{ applyOpenFilters(); applyClosedFilters(); });
      el.addEventListener('change', ()=>{ applyOpenFilters(); applyClosedFilters(); });
    });
  }
  // Hook nach jedem render()
  const oldRender = window.render;
  if(typeof oldRender==='function'){
    window.render = function(){ oldRender(); applyOpenFilters(); applyClosedFilters(); };
  } else {
    document.addEventListener('DOMContentLoaded', ()=>{ applyOpenFilters(); applyClosedFilters(); });
    window.addEventListener('load', ()=>{ applyOpenFilters(); applyClosedFilters(); });
  }
  // Standard âAlleâ bewahren, nie Ã¼berschreiben
  function keepAlle(id){
    const el=document.getElementById(id);
    if(!el) return;
    if(el.value==='Alle') el.value=''; // interner Leerwert
  }
  function init(){
    keepAlle('ftr-exchange'); keepAlle('fcl-exchange');
    wireFilterEvents();
    applyOpenFilters(); applyClosedFilters();
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>


<script>
// --- LiveâRefresh Heartbeat (sicher & leichtgewichtig) ---
(function(){
  function safe(fn){ try{ fn && fn(); }catch(e){} }
  function tick(){
    // 1) Live-Preise / Streams sicher anstoÃen
    safe(window.ensureWsMatchesSymbols);
    // 2) Sichten ggf. neu anwenden (falls gefiltert wurde)
    safe(window.applyOpenFilters);
    safe(window.applyClosedFilters);
    // 3) Summen/Dashboard nachziehen
    safe(window.updateOpenMarginSum);
    safe(window.updateClosedSums);
    safe(window.updateDashboard);
  }

  // Herzschlag alle 2 Sekunden, pausiert im Hintergrund
  var iv = null;
  function start(){
    if(iv) return;
    tick();
    iv = setInterval(function(){
      if(document.hidden) return; // im Hintergrund pausieren
      tick();
    }, 2000);
  }
  function stop(){ if(iv){ clearInterval(iv); iv=null; } }

  // Aufrufen nach jedem render()
  if(typeof window.render==='function'){
    var orig = window.render;
    window.render = function(){
      var r = orig.apply(this, arguments);
      tick(); // direkt nach Render
      return r;
    };
  }

  // Bei FilterÃ¤nderungen ebenfalls ticken
  ['ftr-exchange','ftr-status','ftr-side','ftr-q','ftr-from','ftr-to',
   'fcl-exchange','fcl-status','fcl-side','fcl-q','fcl-from','fcl-to']
  .forEach(function(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', tick);
    el.addEventListener('change', tick);
  });

  // Sichtbarkeitswechsel (Tabwechsel)
  document.addEventListener('visibilitychange', function(){
    if(document.hidden){ stop(); } else { start(); }
  });

  // Start nach DOM ready
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();

/* ==== KASSE: "USDT hinzufÃ¼gen" â klassisches Event-Binding & Validierung ==== */
(function(){
  function parseAmountInput(v){
    if (v == null) return NaN;
    var s = String(v).replace(/\s+/g, '').replace(',', '.');
    var n = parseFloat(s);
    return (isFinite(n) ? n : NaN);
  }

  
function onCashWithdrawClick(ev){
  ev.preventDefault && ev.preventDefault();
  var dateEl = document.getElementById('c-date');
  var amountEl = document.getElementById('c-amount');
  var noteEl  = document.getElementById('c-note');

  var raw = amountEl && amountEl.value;
  var s = String(raw||'').replace(/\s+/g,'').replace(',', '.');
  var n = parseFloat(s);
  if (!isFinite(n) || n <= 0){
    alert('Bitte einen gÃ¼ltigen Betrag (> 0) eingeben.');
    if (amountEl) amountEl.focus();
    return;
  }
  var dateVal = (dateEl && dateEl.value) ? dateEl.value : (typeof nowIso==='function' ? nowIso() : new Date().toISOString().slice(0,16));
  var noteVal = (noteEl && noteEl.value ? noteEl.value.trim() : '') || 'Auszahlung';

  try { addCash(-Math.abs(n), noteVal, dateVal); }
  catch(e){ console.error('addCash() Fehler (withdraw):', e); alert('Kassenbuchung (Auszahlung) fehlgeschlagen.'); return; }

  if (amountEl) amountEl.value = '';
  if (noteEl)   noteEl.value  = '';
  if (dateEl)   dateEl.value  = dateVal;
  if (amountEl) amountEl.focus();
}
(function bindWithdraw(){
  function bind(){
    var bw = document.getElementById('btn-cash-withdraw');
    if (bw && !bw.__boundCashWithdraw){
      bw.addEventListener('click', onCashWithdrawClick);
      bw.__boundCashWithdraw = true;
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();

function onCashAddClick(ev){
    ev.preventDefault && ev.preventDefault();
    var dateEl = document.getElementById('c-date');
    var amountEl = document.getElementById('c-amount');
    var noteEl = document.getElementById('c-note');

    var amount = parseAmountInput(amountEl && amountEl.value);
    if (!isFinite(amount) || amount <= 0){
      alert('Bitte einen gÃ¼ltigen Betrag (> 0) eingeben.');
      if (amountEl) amountEl.focus();
      return;
    }
    var dateVal = (dateEl && dateEl.value) ? dateEl.value : (typeof nowIso==='function' ? nowIso() : new Date().toISOString().slice(0,16));
    var noteVal = (noteEl && noteEl.value) ? noteEl.value.trim() : '';

    // tatsÃ¤chliche Buchung
    try { addCash(amount, noteVal, dateVal); }
    catch(e){ console.error('addCash() Fehler:', e); alert('Kassenbuchung fehlgeschlagen.'); return; }

    // Formular leeren + Fokus zurÃ¼ck
    if (amountEl) amountEl.value = '';
    if (noteEl)   noteEl.value = '';
    if (dateEl)   dateEl.value = dateVal;
    if (amountEl) amountEl.focus();
  }

  function bindCashControls(){
    var btn = document.getElementById('btn-cash-add');
    if (btn && !btn.__boundCashAdd){
      btn.addEventListener('click', onCashAddClick);
      btn.__boundCashAdd = true;
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindCashControls);
  } else {
    bindCashControls();
  }
})();

// === Bootstrap: Kasse initial anzeigen, wenn EintrÃ¤ge existieren ===
document.addEventListener('DOMContentLoaded', function(){
  try{ renderCash(); }catch(e){}
});

// === Kasse: Suche & Sortierung binden ===
document.addEventListener('DOMContentLoaded', function(){
  const s = document.getElementById('wallet-search');
  const o = document.getElementById('wallet-sort');
  if(s){ s.addEventListener('input', ()=>{ try{ renderCash(); }catch(e){} }); }
  if(o){ o.addEventListener('change', ()=>{ try{ renderCash(); }catch(e){} }); }
});

// === Kasse: Leere Notizen klassisch auffÃ¼llen (Einzahlung/Auszahlung) ===
document.addEventListener('DOMContentLoaded', function(){
  let changed = false;
  for (let i=0;i<cash.length;i++){
    const c = cash[i] || {};
    const hasNote = c.note != null && String(c.note).trim().length > 0;
    if (!hasNote && typeof c.amount !== 'undefined'){
      const n = Number(c.amount||0);
      c.note = n >= 0 ? 'Einzahlung' : 'Auszahlung';
      changed = true;
    }
  }
  if (changed){ saveCash(); }
});

// === Page length bindings ===
document.addEventListener('DOMContentLoaded', function(){
  const cashSel = document.getElementById('cash-page-len');
  if(cashSel){
    cashSel.value = (pager.cash.len===Infinity)? 'all' : String(pager.cash.len);
    cashSel.addEventListener('change', ()=>{ pager.cash.len = parseLen(cashSel.value); pager.cash.page=1; renderCash(); });
  }
  const openSel = document.getElementById('open-page-len');
  if(openSel){
    openSel.value = (pager.open.len===Infinity)? 'all' : String(pager.open.len);
    openSel.addEventListener('change', ()=>{ pager.open.len = parseLen(openSel.value); pager.open.page=1; render(); });
  }
  const closedSel = document.getElementById('closed-page-len');
  if(closedSel){
    closedSel.value = (pager.closed.len===Infinity)? 'all' : String(pager.closed.len);
    closedSel.addEventListener('change', ()=>{ pager.closed.len = parseLen(closedSel.value); pager.closed.page=1; render(); });
  }
});
</script>

<script>

// === Spot-Logik: Hebel bei Spot immer 0 und Feld gesperrt ===
(function(){
  const sideSel = document.getElementById('f-side');
  const levInput = document.getElementById('f-lev');
  function applySpotLock(){
    const isSpot = (sideSel && sideSel.value === 'Spot');
    if (!levInput) return;
    if (isSpot){
      levInput.value = 0;
      levInput.setAttribute('disabled','disabled');
    } else {
      // Falls Feld zuvor gesperrt war: wieder freigeben
      levInput.removeAttribute('disabled');
      if (!levInput.value || Number(levInput.value) <= 0) levInput.value = 5;
    }
  }
  if (sideSel){ sideSel.addEventListener('change', applySpotLock); setTimeout(applySpotLock, 0); }
})();

</script>
<script>
// === Kasse Export nach Excel (nur aktuell sichtbare Zeilen) ===
(function(){
  const btn = document.getElementById('btn-cash-export');
  if (!btn) return;
  btn.addEventListener('click', function(){
    const table = document.getElementById('cash-table');
    if (!table) return alert('Keine Kassentabelle gefunden');
    // Clone only visible rows (skip those hidden by filtering/pagination)
    const clonedTable = table.cloneNode(true);
    // Remove hidden rows
    [...clonedTable.querySelectorAll('tbody tr')].forEach(tr=>{
      if (tr.style.display==='none') tr.remove();
    });
    // Convert table to sheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(clonedTable);
    XLSX.utils.book_append_sheet(wb, ws, 'Kasse');
    const fn = 'Kasse_' + new Date().toISOString().slice(0,10) + '.xlsx';
    XLSX.writeFile(wb, fn);
  });
})();
</script>
<script>
// === Kasse: Export Excel (Seite / alle gefiltert) ===
(function(){
  function getCashFilteredIdxs(){
    // Rebuild same filter/sort as renderCash()
    const qEl = document.getElementById('wallet-search');
    const q = (qEl && qEl.value ? qEl.value : '').toLowerCase().trim();
    const sortEl = document.getElementById('wallet-sort');
    const sortKey = sortEl ? sortEl.value : 'date_desc';
    function ym(str){ return String(str||'').slice(0,7); }

    const idxs = cash.map((_,i)=>i).filter(i=>{
      const c = cash[i] || {};
      const d = String(c.date||'');
      const n = String((typeof formatCashNote==='function'? formatCashNote(c) : (c.note||'')) || '').toLowerCase();
      const a = isFinite(Number(c.amount)) ? String(Number(c.amount)) : String(c.amount||'');
      const hay = (d + ' ' + n + ' ' + a).toLowerCase();
      return q ? hay.includes(q) : true;
    });

    idxs.sort((i,j)=>{
      const A = cash[i]||{}, B = cash[j]||{};
      const da = String(A.date||''), db = String(B.date||'');
      if (sortKey==='date_desc') return (db>da)?1:((db<da)?-1:0);
      if (sortKey==='date_asc')  return (da>db)?1:((da<db)?-1:0);
      if (sortKey==='month_asc') return ym(da)>ym(db)?1:(ym(da)<ym(db)?-1:0);
      if (sortKey==='month_desc')return ym(db)>ym(da)?1:(ym(db)<ym(da)?-1:0);
      return 0;
    });
    return idxs;
  }

  function exportCash(mode){
    const idxs = getCashFilteredIdxs();
    let useIdxs = idxs;
    if (mode==='page'){
      const per = pager?.cash?.len ?? 25;
      const page = pager?.cash?.page ?? 1;
      if (isFinite(per)){
        const st = Math.max(0,(page-1)*per);
        useIdxs = idxs.slice(st, st+per);
      }
    }
    const rows = [['Datum','Betrag (USDT)','Notiz']];
    useIdxs.forEach(i=>{
      const c = cash[i] || {};
      const date = c.date || '';
      const amount = (isFinite(Number(c.amount))? Number(c.amount) : '');
      const note = (typeof formatCashNote==='function' ? formatCashNote(c) : (c.note||'')) || '';
      rows.push([date, amount, note]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Kasse');
    const suffix = (mode==='page'?'Seite':'Gefiltert');
    const fn = `Kasse_${suffix}_` + new Date().toISOString().slice(0,10) + '.xlsx';
    XLSX.writeFile(wb, fn);
  }

  const btnPage = document.getElementById('btn-cash-export-page');
  const btnAll  = document.getElementById('btn-cash-export-all');
  if (btnPage) btnPage.addEventListener('click', ()=>exportCash('page'));
  if (btnAll)  btnAll.addEventListener('click', ()=>exportCash('all'));
})();

</script>

<script>
// ===== CoinGecko helpers =====
const CG_BASE = 'https://api.coingecko.com/api/v3';
async function cg(path){
  const r = await fetch(CG_BASE + path, { headers:{ 'accept':'application/json' } });
  if(!r.ok) throw new Error('CoinGecko ' + r.status);
  return await r.json();
}
async function cgGlobal(){ return await cg('/global'); }
async function cgMarkets(per=50){
  const qs = new URLSearchParams({
    vs_currency: 'usd',
    order: 'market_cap_desc',
    per_page: String(per),
    page: '1',
    sparkline: 'true',
    price_change_percentage: '1h,24h,7d'
  });
  return await cg('/coins/markets?' + qs.toString());
}
// ===== Render utils =====
function fmtCG(n, d=2){ try{ return Number(n).toLocaleString('de-DE',{maximumFractionDigits:d}); }catch(e){ return n; } }
function pctClsCG(x){ return x==null? '' : (x>=0? 'pos':'neg'); }
function pctStrCG(x){ return x==null? 'â' : ((x>=0?'+':'') + fmtCG(x,2) + '%'); }

let cgAll=[], cgSort='mcap_desc', cgQuery='', cgLimit=50, cgPage=1;
let cgTimer=null;

function sortData(arr){
  const A=[...arr]; const asc = cgSort.endsWith('_asc')?1:-1;
  if(cgSort.startsWith('mcap')) return A.sort((a,b)=>(a.market_cap-b.market_cap)*asc);
  if(cgSort.startsWith('price')) return A.sort((a,b)=>(a.current_price-b.current_price)*asc);
  if(cgSort.startsWith('chg24')) return A.sort((a,b)=>((a.price_change_percentage_24h||0)-(b.price_change_percentage_24h||0))*asc);
  if(cgSort.startsWith('vol')) return A.sort((a,b)=>(a.total_volume-b.total_volume)*asc);
  return A;
}
function filterData(arr){
  if(!cgQuery) return arr;
  const q=cgQuery.toLowerCase();
  return arr.filter(x=> (x.name||'').toLowerCase().includes(q) || (x.symbol||'').toLowerCase().includes(q));
}
function buildPager(total){
  const el = document.getElementById('cg-pager');
  const perRaw = Number(cgLimit);
  const per = (Number.isFinite(perRaw) && perRaw > 0) ? perRaw : 50;
  const tot = Number.isFinite(Number(total)) ? Number(total) : 0;

  let pages = Math.max(1, Math.ceil(tot / per));
  if (!Number.isFinite(pages)) pages = 1;

  if (!Number.isFinite(cgPage) || cgPage < 1) cgPage = 1;
  if (cgPage > pages) cgPage = pages;

  el.innerHTML = '';
  if (pages <= 1) { el.style.display = 'none'; return; }
  el.style.display = 'flex';

  function btn(t, tgt, dis){
    const b = document.createElement('button');
    b.className = 'btn small';
    b.disabled = !!dis;
    b.textContent = t;
    if (!dis) b.onclick = () => { cgPage = tgt; renderCG(); };
    el.appendChild(b);
  }
  btn('Â«', 1, cgPage === 1);
  btn('â¹', cgPage - 1, cgPage === 1);

  const sp = document.createElement('span');
  sp.style.padding = '6px 8px';
  sp.textContent = `Seite ${cgPage} / ${pages}`;
  el.appendChild(sp);

  btn('âº', cgPage + 1, cgPage === pages);
  btn('Â»', pages, cgPage === pages);
}

function drawSpark(canvas, prices){
  try{
    const arr = Array.isArray(prices)? prices.slice(-80) : [];
    if(!arr.length) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = 120, h = canvas.height = 32;
    const mn=Math.min(...arr), mx=Math.max(...arr), rng=(mx-mn)||1;
    ctx.lineWidth=1.5; ctx.beginPath();
    arr.forEach((v,i)=>{ const x=i/(arr.length-1)*w; const y=h - ((v-mn)/rng)*h; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke(); // Standardfarbe passend zum Theme
  }catch(e){}
}
function renderCG(){
  const tb=document.querySelector('#cg-table tbody'); if(!tb) return;
  tb.innerHTML='';
  const list = filterData(sortData(cgAll));
  const total = Array.isArray(list) ? list.length : 0; buildPager(total);
const per = (Number.isFinite(Number(cgLimit)) && Number(cgLimit) > 0) ? Number(cgLimit) : 50;
const safePage = (Number.isFinite(Number(cgPage)) && cgPage >= 1) ? Number(cgPage) : 1;
const start = (safePage - 1) * per;
const rows = (Array.isArray(list) ? list : []).slice(start, start + per);
rows.forEach((c, i)=>{
    const tr=document.createElement('tr');
    const rank=start+i+1;
    const ch1=c.price_change_percentage_1h_in_currency, ch24=c.price_change_percentage_24h_in_currency, ch7=c.price_change_percentage_7d_in_currency;
    const cv=document.createElement('canvas'); cv.className='cg-spark';
    tr.innerHTML=`
      <td>${rank}</td>
      <td><a href="#" data-pair="${(c.symbol||'').toUpperCase()}/USDT">${(c.symbol||'').toUpperCase()}</a> ${c.name||''}</td>
      <td class="num">${fmt(c.current_price,8)} USDT</td>
      <td class="num ${pctClsCG(ch1)}">${pctStrCG(ch1)}</td>
      <td class="num ${pctClsCG(ch24)}">${pctStrCG(ch24)}</td>
      <td class="num ${pctClsCG(ch7)}">${pctStrCG(ch7)}</td>
      <td class="num">${fmt(c.market_cap)}</td>
      <td class="num">${fmt(c.total_volume)}</td>
      <td class="num">${fmt(c.circulating_supply)}</td>
      <td class="num"></td>
    `;
    tr.querySelector('td:last-child').appendChild(cv);
    tb.appendChild(tr);
    drawSpark(cv, c.sparkline_in_7d?.price);

    // Click-to-fill: Paar & Entry oben setzen
    const a = tr.querySelector('a[data-pair]');
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const pairField = document.querySelector('#f-pair');
      const entryField = document.querySelector('#f-entry');
      if(pairField){ pairField.value = (c.symbol||'').toUpperCase() + '/USDT'; }
      if(entryField && c.current_price){ entryField.value = c.current_price; }
      try{ if(typeof updatePairPriceHint==='function') updatePairPriceHint(); }catch(e){}
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
}
async function refreshCG(){
  try{
    document.getElementById('cg-updated').textContent='lÃ¤dtâ¦';
    const [glob, mkts] = await Promise.all([cgGlobal(), cgMarkets(250)]);
    const g=glob.data||{};
    document.getElementById('cg-mcap').textContent = g.total_market_cap?.usd==null? 'â' : fmtCG(g.total_market_cap.usd);
    document.getElementById('cg-vol').textContent = g.total_volume?.usd==null? 'â' : fmtCG(g.total_volume.usd);
    document.getElementById('cg-btcdom').textContent = g.market_cap_percentage?.btc==null? 'â' : fmtCG(g.market_cap_percentage.btc,2)+'%';
    document.getElementById('cg-ethdom').textContent = g.market_cap_percentage?.eth==null? 'â' : fmtCG(g.market_cap_percentage.eth,2)+'%';
    const ch = g.market_cap_change_percentage_24h_usd;
    const chEl = document.getElementById('cg-mcap-chg');
    chEl.textContent = ch==null? '' : ((ch>=0?'+':'')+fmt(ch,2)+'% ggÃ¼. 24h');
    chEl.className = 't ' + (ch==null? '' : (ch>=0? 'pos':'neg'));

    cgAll = mkts;
    cgPage=1; renderCG();
    document.getElementById('cg-updated').textContent = new Date().toLocaleString('de-DE');
  }catch(e){
    document.getElementById('cg-updated').textContent='Fehler beim Laden';
    console.error(e);
  }
}
function scheduleAuto(){
  const sel=document.getElementById('cg-refresh');
  if(cgTimer){ clearInterval(cgTimer); cgTimer=null; }
  const s=parseInt(sel.value||'0',10)||0;
  if(s>0){ cgTimer=setInterval(()=>{ refreshCG(); }, s*1000); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  const selL=document.getElementById('cg-limit');
  const selS=document.getElementById('cg-sort');
  const inpQ=document.getElementById('cg-search');
  document.getElementById('cg-reload').onclick = refreshCG;
  selL.onchange=()=>{ cgLimit=parseInt(selL.value||'50',10)||50; cgPage=1; renderCG(); };
  selS.onchange=()=>{ cgSort=selS.value; renderCG(); };
  inpQ.oninput=()=>{ cgQuery=inpQ.value||''; cgPage=1; renderCG(); };
  document.getElementById('cg-refresh').onchange=scheduleAuto;
  refreshCG(); scheduleAuto();
});
</script>


<script>
// === Sparkline Trendfarbe: nicht-invasives Override ==========================
// Setzt die Linienfarbe vor dem Zeichnen, ohne die Originalfunktion zu verÃ¤ndern.
(function(){
  try {
    var _origDrawSpark = window.drawSpark;
    window.drawSpark = function(canvas, prices){
      try {
        if (canvas && prices && prices.length >= 2) {
          var styles = getComputedStyle(document.documentElement);
          var upColor = (styles.getPropertyValue('--pos') || '#22c55e').trim();
          var dnColor = (styles.getPropertyValue('--neg') || '#ef4444').trim();
          var trendUp = prices[prices.length - 1] >= prices[0];
          var ctx = canvas.getContext && canvas.getContext('2d');
          if (ctx) { ctx.strokeStyle = trendUp ? upColor : dnColor; }
        }
      } catch(e){}
      if (typeof _origDrawSpark === 'function') {
        return _origDrawSpark(canvas, prices);
      }
    };
  } catch(e){}
})();
// ============================================================================
</script>




<script>
// === Live-Update CoinGecko-Panel mit Backoff ===
document.addEventListener("DOMContentLoaded", function(){
  var interval = 15000; // Start mit 15s
  var timer = null;
  var slowMode = false;
  var upEl = document.getElementById('cg-updated');
  if (upEl) { upEl.textContent = 'LIVE'; upEl.classList.add('live'); }

  function setSlowMode(on) {
    slowMode = on;
    if (!upEl) return;
    if (on) {
      upEl.classList.remove('live');
      upEl.classList.add('slow');
      upEl.textContent = 'LIVE - BACKOFF';
    } else {
      upEl.classList.remove('slow');
      upEl.classList.add('live');
      upEl.textContent = 'LIVE';
    }
  }

  function tick(){
    try {
      var p = refreshCG();
      if (p && typeof p.then === 'function') {
        p.then(()=>{ // success
          if (slowMode) {
            interval = 15000;
            setSlowMode(false);
            restart();
          }
        }).catch(()=>{ // fail
          if (!slowMode) {
            interval = 60000;
            setSlowMode(true);
            restart();
          }
        });
      } else {
        // refreshCG nicht async -> kein Backoff mÃ¶glich, nur ausfÃ¼hren
        refreshCG();
      }
    } catch(e) {
      if (!slowMode) {
        interval = 60000;
        setSlowMode(true);
        restart();
      }
    }
  }

  function restart(){
    if (timer) clearInterval(timer);
    timer = setInterval(tick, interval);
  }

  tick(); // sofort laden
  restart();
});
</script>


<script>
// --- Robust init for CoinGecko section ---
(function(){
  function needsRefresh(){
    try{
      var m=document.getElementById('cg-mcap');
      return !m || !m.textContent || m.textContent.trim()==='â' || m.textContent.trim()==='-';
    }catch(e){ return true; }
  }
  function kick(){
    try{ if (typeof refreshCG === 'function') refreshCG(); }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    // extra kick shortly after DOM ready
    setTimeout(function(){ if(needsRefresh()) kick(); }, 200);
    setTimeout(function(){ if(needsRefresh()) kick(); }, 1200);
  });
  window.addEventListener('load', function(){
    setTimeout(function(){ if(needsRefresh()) kick(); }, 100);
  });
})();
</script>


<script>
// ===== Schneller Start fÃ¼r MARKTÃBERSICHT (per Cache + kleines erstes Ladekontingent) =====
(function(){
  const CACHE_KEY = 'cg_snapshot_v1';
  const CACHE_TTL_MS = 10 * 60 * 1000; // 10 Minuten
  let firstPaintDone = false;

  function applyCacheIfFresh(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || !obj.html) return false;
      if(Date.now() - obj.t > CACHE_TTL_MS) return false;
      const el = document.getElementById('cg-market');
      if(el && !firstPaintDone){
        el.innerHTML = obj.html;
        firstPaintDone = true;
        // Kennzeichnung, dass dies aus dem Cache ist (dezent)
        const up = document.getElementById('cg-updated');
        if(up){ up.textContent = 'CACHE â¢ wird aktualisiertâ¦'; }
        return true;
      }
    }catch(e){ /* ignore */ }
    return false;
  }

  function saveCache(){
    try{
      const el = document.getElementById('cg-market');
      if(!el) return;
      const html = el.innerHTML;
      const obj = { t: Date.now(), html };
      localStorage.setItem(CACHE_KEY, JSON.stringify(obj));
    }catch(e){ /* ignore */ }
  }

  // Monkey-Patching von renderCG, um nach erfolgreichem Rendern den Cache zu speichern
  function patchRender(){
    try{
      if (typeof window.renderCG === 'function' && !window._origRenderCG){
        window._origRenderCG = window.renderCG;
        window.renderCG = function(){
          try{ return window._origRenderCG.apply(this, arguments); }
          finally{ saveCache(); }
        };
      }
    }catch(e){ /* ignore */ }
  }

  // Monkey-Patching von refreshCG, um beim ersten Mal mit kleinem Limit (schnell) zu laden
  function patchRefreshFastFirst(){
    try{
      if (typeof window.refreshCG === 'function' && !window._origRefreshCG){
        window._origRefreshCG = window.refreshCG;
        window._cgFastFirst = true;
        window.refreshCG = function(){
          if (window._cgFastFirst){
            try{
              // kleines Initial-Limit (10), danach gewÃ¼nschtes Limit erneut laden
              const prev = window.cgLimit;
              if (typeof window.cgLimit === 'undefined') window.cgLimit = 10; else window.cgLimit = 10;
              window._origRefreshCG();
              window._cgFastFirst = false;
              // kurzes Delay, dann mit echtem Limit nachladen
              setTimeout(function(){
                try{
                  if (typeof prev !== 'undefined') window.cgLimit = prev;
                  window._origRefreshCG();
                }catch(e){}
              }, 500);
            }catch(e){
              // Fallback: normal
              window._origRefreshCG();
            }
          } else {
            return window._origRefreshCG.apply(this, arguments);
          }
        };
      }
    }catch(e){ /* ignore */ }
  }

  // Beim DOM fertig: Cache sofort zeigen (wenn vorhanden), dann schnell patchen und laden
  document.addEventListener('DOMContentLoaded', function(){
    applyCacheIfFresh();
    patchRender();
    patchRefreshFastFirst();
  });

  // Auf Window-Load sicherstellen, dass ein Update ausgelÃ¶st wird
  window.addEventListener('load', function(){
    try{
      if (typeof window.refreshCG === 'function'){
        // Wenn noch kein Inhalt gemalt wurde, forcieren
        if (!firstPaintDone) { applyCacheIfFresh(); }
        window.refreshCG();
      }
    }catch(e){ /* ignore */ }
  });
})();
</script>


<script>
// === Closed Summary Panel: mirror footer totals into separate panel ===
(function(){
  function norm(s){ return (s||'').toString().replace(/\s/g,' ').replace(/\s+USDT/i,' USDT').trim(); }
  function fillFromFooter(){
    try{
      var tbl = document.getElementById('tbl-closed');
      if(!tbl) return;
      var tfoot = tbl.querySelector('tfoot');
      var last = tfoot ? (tfoot.querySelector('tr:last-child') || tfoot.querySelector('tr')) : null;
      if(!last) return;
      var tds = last.querySelectorAll('td, th');
      if(!tds || tds.length < 12) return;
      var marginTxt = (tds[8].textContent||'').trim();   // Margin USDT
      var realTxt   = (tds[11].textContent||'').trim();  // Real PnL

      var mBox = document.getElementById('sum-closed-margin-box');
      var rBox = document.getElementById('sum-closed-real-box');
      if(mBox) mBox.textContent = norm(marginTxt);
      if(rBox){
        rBox.textContent = norm(realTxt);
        // colorize positive/negative
        var v = (realTxt||'').replace(/USDT/i,'').replace(/[^0-9\-\.,]/g,'').replace(/\./g,'').replace(',', '.');
        var num = parseFloat(v);
        rBox.classList.remove('pos','neg');
        if(!isNaN(num)){
          if(num > 0) rBox.classList.add('pos');
          if(num < 0) rBox.classList.add('neg');
        }
      }
    }catch(e){ console.error('closed summary panel error', e); }
  }

  // Debounce to avoid thrashing on rapid changes
  var _t = null;
  function trigger(){ clearTimeout(_t); _t = setTimeout(fillFromFooter, 120); }

  document.addEventListener('DOMContentLoaded', function(){
    trigger();
    // Observe tfoot & tbody for changes (filters/paging/render)
    var tbl = document.getElementById('tbl-closed');
    if(tbl && window.MutationObserver){
      var obs = new MutationObserver(trigger);
      var tfoot = tbl.querySelector('tfoot');
      var tbody = tbl.querySelector('tbody');
      if(tfoot) obs.observe(tfoot, {subtree:true, childList:true, characterData:true});
      if(tbody) obs.observe(tbody, {subtree:true, childList:true, characterData:true});
    }
    // Recompute on interactions inside the closed tab (filters, buttons, pager)
    var closedTab = document.getElementById('tab-closed');
    if(closedTab){
      closedTab.addEventListener('input', trigger, true);
      closedTab.addEventListener('change', trigger, true);
      closedTab.addEventListener('click', function(ev){
        if(ev.target && (ev.target.closest('.pager') || ev.target.tagName==='BUTTON' || ev.target.tagName==='A')) trigger();
      }, true);
    }
  });
  window.addEventListener('load', trigger);
  // Expose manual update function
  window.updateClosedSummaryPanel = fillFromFooter;
})();
</script>

<script>
(function(){
  function hideOldClosedSumRow(){
    try{
      var tbl = document.getElementById('tbl-closed');
      if(!tbl) return;
      // Hide tfoot entirely (CSS already does, but ensure in case inline styles override)
      var tf = tbl.querySelector('tfoot');
      if(tf){ tf.style.display = 'none'; }
      // Also scan tbody rows for a textual "Gesamtsumme" row and hide it
      var rows = tbl.querySelectorAll('tbody tr');
      rows.forEach(function(tr){
        var txt = (tr.textContent||'').trim().toLowerCase();
        // catch variants like "Gesamtsumme", "Gesamt summe", leading/trailing icons etc.
        if (txt.startsWith('gesamtsumme') || txt.includes('gesamtsumme')) {
          tr.style.display = 'none';
        }
      });
    }catch(e){ console.error('hideOldClosedSumRow error', e); }
  }
  // Initial on DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    hideOldClosedSumRow();
    // Observe for re-renders (filters, paging, etc.)
    var tbl = document.getElementById('tbl-closed');
    if(tbl && window.MutationObserver){
      var obs = new MutationObserver(function(){ hideOldClosedSumRow(); });
      obs.observe(tbl, { subtree:true, childList:true, characterData:true });
    }
  });
  // Fallback after full load
  window.addEventListener('load', hideOldClosedSumRow);
  // expose manual hook
  window.hideOldClosedSumRow = hideOldClosedSumRow;
})();
</script>

<script>
// Persistentes Ausblenden: fÃ¤rbt die RealâPnLâGesamtsumme wie den TabellenâHintergrund
(function(){
  function colorToBg(el){
    if(!el) return;
    // Nimm den effektiven Hintergrund der Zelle oder der Zeile/Tabelle
    var bg = getComputedStyle(el).backgroundColor;
    if(!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent'){
      var row = el.closest('tr');
      if(row){
        var rowBg = getComputedStyle(row).backgroundColor;
        if(rowBg && rowBg !== 'rgba(0, 0, 0, 0)' && rowBg !== 'transparent') bg = rowBg;
      }
    }
    if(!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent'){
      var table = el.closest('table');
      if(table){
        var tBg = getComputedStyle(table).backgroundColor;
        if(tBg && tBg !== 'rgba(0, 0, 0, 0)' && tBg !== 'transparent') bg = tBg;
      }
    }
    if(bg){
      el.style.color = bg;
      // auch Kinder (z. B. <span>) einfÃ¤rben
      el.querySelectorAll('*').forEach(function(n){ n.style.color = bg; });
    }else{
      // Fallback: unsichtbar machen, falls Theme-Farbe nicht ermittelbar
      el.style.opacity = '0';
    }
  }

  function applyHide(){
    try{
      var tbl = document.getElementById('tbl-closed');
      if(!tbl) return;
      // Versuch 1: tfoot letzte Zeile, Real PnL Spalte (Index 11)
      var tfoot = tbl.querySelector('tfoot');
      if(tfoot){
        var last = tfoot.querySelector('tr:last-child') || tfoot.querySelector('tr');
        if(last){
          var tds = last.querySelectorAll('td,th');
          if(tds && tds.length > 11){
            colorToBg(tds[11]);
          }
        }
      }
      // Versuch 2: eine "Gesamtsumme"-Zeile im tbody suchen und dort Real PnL (Index 11) einfÃ¤rben
      var rows = tbl.querySelectorAll('tbody tr');
      rows.forEach(function(tr){
        var txt = (tr.textContent||'').toLowerCase();
        if(txt.includes('gesamtsumme')){
          var tds = tr.querySelectorAll('td,th');
          if(tds && tds.length > 11){
            colorToBg(tds[11]);
          }
        }
      });
    }catch(e){ console.error('applyHide error', e); }
  }

  // Initial und bei Theme-Wechseln/Mutationen erneut anwenden
  document.addEventListener('DOMContentLoaded', function(){
    applyHide();
    var tbl = document.getElementById('tbl-closed');
    if(tbl && window.MutationObserver){
      var obs = new MutationObserver(function(){ applyHide(); });
      obs.observe(tbl, {subtree:true, childList:true, characterData:true, attributes:true});
    }
  });
  window.addEventListener('load', applyHide);
  window.applyHideRealPnlTotal = applyHide;
})();
</script>

<script>
(function(){
  function removeOldSumRow(){
    try{
      var tbl = document.getElementById('tbl-closed');
      if(!tbl) return;
      // Entferne tfoot, falls vorhanden
      var tf = tbl.querySelector('tfoot');
      if(tf) tf.remove();
      // Suche und entferne alle Zeilen, die "Gesamtsumme" enthalten
      var rows = tbl.querySelectorAll('tbody tr');
      rows.forEach(function(tr){
        var txt = (tr.textContent||'').toLowerCase();
        if(txt.includes('gesamtsumme')){
          tr.remove();
        }
      });
    }catch(e){ console.error('removeOldSumRow error', e); }
  }
  document.addEventListener('DOMContentLoaded', removeOldSumRow);
  window.addEventListener('load', removeOldSumRow);
  if(window.MutationObserver){
    var tbl = document.getElementById('tbl-closed');
    if(tbl){
      var obs = new MutationObserver(removeOldSumRow);
      obs.observe(tbl, {subtree:true, childList:true, characterData:true});
    }
  }
  window.removeOldSumRow = removeOldSumRow;
})();
</script>

<script>
// === Compute closed-trades sums from visible rows (no footer needed) ===
(function(){
  function parseNumberDE(s){
    if(!s) return 0;
    s = (''+s).replace(/USDT/i,'').replace(/\s/g,'');
    // keep minus, digits, separators
    s = s.replace(/[^0-9,.-]/g,'');
    // 1.234.567,89 -> 1234567.89
    s = s.replace(/\./g,'').replace(',', '.');
    var v = parseFloat(s);
    return isNaN(v) ? 0 : v;
  }
  function fmtDE(v, frac=2){
    try{
      return new Intl.NumberFormat('de-DE', {minimumFractionDigits: frac, maximumFractionDigits: frac}).format(v);
    }catch(e){
      return (Math.round(v*100)/100).toString();
    }
  }
  function updateClosedPanelFromRows(){
    try{
      var tbl = document.getElementById('tbl-closed');
      if(!tbl) return;
      var rows = tbl.querySelectorAll('tbody tr');
      var marginSum = 0, realSum = 0;
      rows.forEach(function(tr){
        // skip hidden rows or "Gesamtsumme"-like rows
        if (tr.offsetParent === null) return;
        var txt = (tr.textContent||'').toLowerCase();
        if (txt.includes('gesamtsumme')) return;
        var tds = tr.querySelectorAll('td');
        if (!tds || tds.length < 12) return;
        var marginCell = tds[8];   // "Margin USDT"
        var realCell   = tds[11];  // "Real PnL"
        marginSum += parseNumberDE(marginCell ? marginCell.textContent : '');
        realSum   += parseNumberDE(realCell ? realCell.textContent : '');
      });
      var mBox = document.getElementById('sum-closed-margin-box');
      var rBox = document.getElementById('sum-closed-real-box');
      if (mBox) mBox.textContent = fmtDE(marginSum, 0) + ' USDT';
      if (rBox){
        rBox.textContent = (realSum>=0? '+':'') + fmtDE(realSum, 2) + ' USDT';
        rBox.style.color = realSum > 0 ? 'var(--pos)' : (realSum < 0 ? 'var(--neg)' : 'var(--fg)');
      }
    }catch(e){ console.error('updateClosedPanelFromRows error', e); }
  }
  // Wire events
  document.addEventListener('DOMContentLoaded', function(){
    updateClosedPanelFromRows();
    var tab = document.getElementById('tab-closed');
    if (tab){
      tab.addEventListener('input', updateClosedPanelFromRows, true);
      tab.addEventListener('change', updateClosedPanelFromRows, true);
      tab.addEventListener('click', function(ev){
        if(ev.target && (ev.target.closest('.pager') || ev.target.tagName==='BUTTON' || ev.target.tagName==='A')){
          setTimeout(updateClosedPanelFromRows, 50);
        }
      }, true);
    }
    var tbl = document.getElementById('tbl-closed');
    if (tbl && window.MutationObserver){
      var obs = new MutationObserver(function(){ setTimeout(updateClosedPanelFromRows, 20); });
      obs.observe(tbl, {subtree:true, childList:true, characterData:true});
    }
  });
  window.addEventListener('load', updateClosedPanelFromRows);
  // Expose manual trigger
  window.updateClosedPanelFromRows = updateClosedPanelFromRows;
})();
</script>

<!-- === BEGIN: Restore MarktÃ¼bersicht â Einstiegspreis/Paar Autofill (2025-08-17) === -->
<script>
(function(){
  function toNum(text){
    if(text==null) return NaN;
    let v = (''+text).trim();
    v = v.replace(/[^\d\,\.\-]/g,'');
    if(v.indexOf(',')>-1 && v.indexOf('.')>-1){
      if(v.lastIndexOf(',') > v.lastIndexOf('.')){
        v = v.replace(/\./g,'').replace(',', '.');
      } else {
        v = v.replace(/\,/g,'');
      }
    } else {
      v = v.replace(',', '.');
    }
    let n = parseFloat(v);
    return isFinite(n)? n : NaN;
  }
  function findEntryInputs(){
    const selectors = [
      '#entryPrice', '#entry', '#new-entry', '#f-entry', 'input[name="entry"]', 'input[name="entryPrice"]',
      '#einstieg', 'input[name="einstieg"]'
    ];
    const found = [];
    for(const sel of selectors){
      document.querySelectorAll(sel).forEach(el => { if(found.indexOf(el)<0) found.push(el); });
    }
    if(found.length===0){
      const forms = Array.from(document.querySelectorAll('#tab-new, #new-trade, form')).slice(0,3);
      forms.forEach(f => {
        f && f.querySelectorAll('input[type="number"]').forEach(el => {
          if(found.indexOf(el)<0) found.push(el);
        });
      });
    }
    return found;
  }
  function setEntryValue(val){
    const els = findEntryInputs();
    if(!els.length) return false;
    els.forEach(el => { el.value = (typeof val==='number' && isFinite(val)) ? String(val) : (val||''); el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); });
    return true;
  }
  function findPairInputs(){
    const sels = ['#pair', '#symbol', 'input[name="pair"]', 'input[name="symbol"]', '#f-pair', '#new-pair'];
    const out = [];
    sels.forEach(sel => document.querySelectorAll(sel).forEach(el => { if(out.indexOf(el)<0) out.push(el); }));
    return out;
  }
  function setPairValue(symbol){
    const els = findPairInputs();
    if(!els.length) return false;
    els.forEach(el => { el.value = symbol || el.value; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); });
    return true;
  }
  function getPriceFromNode(node){
    if(!node) return NaN;
    const attrs = ['data-price','data-last','data-last-price','data-current','data-usd'];
    for(const a of attrs){
      if(node.hasAttribute && node.hasAttribute(a)){
        const n = toNum(node.getAttribute(a));
        if(isFinite(n)) return n;
      }
    }
    const txt = (node.innerText||node.textContent||'').trim();
    let n = toNum(txt);
    if(isFinite(n)) return n;
    const cand = node.querySelector('[data-price],[data-last],[data-last-price],[data-current],[data-usd], .price, .last, .current, .live-price');
    if(cand){
      n = getPriceFromNode(cand);
      if(isFinite(n)) return n;
    }
    const row = node.closest('tr, .row, li, .coin-item, .market-card');
    if(row){
      const c2 = row.querySelector('[data-price],[data-last],[data-last-price],[data-current],[data-usd], .price, .last, .current, .live-price');
      if(c2){
        n = toNum(c2.getAttribute('data-price')||c2.getAttribute('data-last')||c2.getAttribute('data-last-price')||c2.getAttribute('data-current')||c2.getAttribute('data-usd')||c2.innerText||c2.textContent);
        if(isFinite(n)) return n;
      }
    }
    return NaN;
  }
  function getSymbolFromNode(node){
    if(!node) return '';
    const attrs = ['data-symbol','data-pair','data-coin'];
    for(const a of attrs){
      if(node.hasAttribute && node.hasAttribute(a)){
        const s = (node.getAttribute(a)||'').trim();
        if(s) return s;
      }
    }
    const label = node.querySelector('[data-symbol],[data-pair],[data-coin], .symbol, .pair, .ticker, .coin');
    if(label) return (label.getAttribute('data-symbol')||label.getAttribute('data-pair')||label.getAttribute('data-coin')||label.innerText||'').trim();
    const row = node.closest('tr, .coin-item, .market-card, li');
    if(row){
      const t = row.querySelector('[data-symbol],[data-pair],[data-coin], .symbol, .pair, .ticker, .coin, .name');
      if(t) return (t.getAttribute('data-symbol')||t.getAttribute('data-pair')||t.getAttribute('data-coin')||t.innerText||'').trim();
    }
    return '';
  }
  const containers = [
    '#market-overview', '#market', '#coingecko-market', '#tab-market', '#MARKTÃBERSICHT', '#marktuebersicht',
    '.market-table', '.market-list', '.coingecko-table', '.market-grid'
  ];
  function addDelegation(root){
    root.addEventListener('click', function(e){
      const item = e.target.closest('[data-coin],[data-symbol],[data-pair], .coin-item, .market-card, tr, li');
      if(!item) return;
      const price = getPriceFromNode(item);
      const symbol = getSymbolFromNode(item);
      if(isFinite(price)) setEntryValue(price);
      if(symbol) setPairValue(symbol);
    }, true);
  }
  let bound = false;
  containers.forEach(sel => {
    document.querySelectorAll(sel).forEach(el => { addDelegation(el); bound = true; });
  });
  if(!bound){ addDelegation(document); }
})();
</script>
<!-- === END: Restore MarktÃ¼bersicht â Einstiegspreis/Paar Autofill (2025-08-17) === -->

<!-- === BEGIN: New-Trade Pflichtfelder (Datum, BÃ¶rse, Einstiegspreis, Margin) â 2025-08-17 === -->
<script>
(function(){
  // Hilfsfunktionen (bewÃ¤hrt & schlicht)
  function $all(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function txt(n){return (n && (n.innerText||n.textContent)||'').trim();}
  function isVisible(el){ if(!el) return false; var s=getComputedStyle(el); return s.display!=='none'&&s.visibility!=='hidden'&&+s.opacity!==0 && el.offsetParent!==null; }
  function toNumber(str){
    if(str==null) return NaN;
    var s=(''+str).trim().replace(/[^\d\-\.,]/g,'');
    if(!s) return NaN;
    var d=s.lastIndexOf('.'), c=s.lastIndexOf(',');
    if(d>-1 && c>-1){ if(c>d){ s=s.replace(/\./g,'').replace(',', '.'); } else { s=s.replace(/,/g,''); } }
    else if(c>-1){ s=s.replace(',', '.'); }
    var n=parseFloat(s);
    return isFinite(n)? n : NaN;
  }
  function mark(el){
    if(!el) return;
    var old=el.style.boxShadow;
    el.style.boxShadow='0 0 0 2px rgba(231,76,60,.9) inset';
    setTimeout(function(){ el.style.boxShadow=old; }, 1800);
  }

  // Sichtbaren "Neuen Trade"-Editor finden (traditionell Ã¼ber Feld-PrÃ¤senz)
  function findEditorCandidates(){
    return $all('form, .editor, .trade-new, #trade-new, .new-trade, .card, section, .panel, .popup, .dialog, .module');
  }
  function hasField(root, words){
    var inputs = $all('input, select', root);
    for(var i=0;i<inputs.length;i++){
      var n=(inputs[i].name||'').toLowerCase();
      var id=(inputs[i].id||'').toLowerCase();
      if(!isVisible(inputs[i])) continue;
      for(var j=0;j<words.length;j++){
        var w=words[j];
        if(n.includes(w) || id.includes(w)) return true;
        if(inputs[i].id){
          var lab = root.querySelector('label[for="'+inputs[i].id+'"]');
          if(lab && txt(lab).toLowerCase().includes(w)) return true;
        }
      }
    }
    return false;
  }
  function getVisibleEditor(){
    var c=findEditorCandidates();
    for(var i=0;i<c.length;i++){
      var el=c[i];
      if(!isVisible(el)) continue;
      if(hasField(el,['datum','open']) && hasField(el,['bÃ¶rse','boerse','exchange']) &&
         hasField(el,['einstieg','entry']) && hasField(el,['margin'])){
        return el;
      }
    }
    return null;
  }

  // Feldfinder (einfach, robust)
  function byLabel(root, words){
    var labs=$all('label', root);
    for(var i=0;i<labs.length;i++){
      var t=txt(labs[i]).toLowerCase();
      for(var j=0;j<words.length;j++){
        if(t.includes(words[j])){
          var fid=labs[i].getAttribute('for');
          if(fid){
            var el=root.querySelector('#'+CSS.escape(fid));
            if(el) return el;
          }
          var sib=labs[i].nextElementSibling;
          if(sib && (sib.tagName==='INPUT'||sib.tagName==='SELECT')) return sib;
          var inP=labs[i].parentElement && labs[i].parentElement.querySelector && labs[i].parentElement.querySelector('input,select');
          if(inP) return inP;
        }
      }
    }
    return null;
  }
  function findField(root, sel, words){ return root.querySelector(sel) || byLabel(root, words); }
  function fldDate(root){ return findField(root, 'input[type="datetime-local"], input[name*="datum" i], input[id*="datum" i], input[name*="open" i], input[id*="open" i]', ['datum','erÃ¶ffnung','eroeffnung','open']); }
  function fldExch(root){ return findField(root, 'select[name*="bÃ¶rse" i], select[name*="boerse" i], select[name*="exchange" i]', ['bÃ¶rse','boerse','exchange']); }
  function fldEntry(root){ return findField(root, 'input[name*="entry" i], input[id*="entry" i], input[name*="einstieg" i], input[id*="einstieg" i]', ['einstieg','entry']); }
  function fldMargin(root){ return findField(root, 'input[name*="margin" i], input[id*="margin" i]', ['margin']); }

  // Validierung nur beim echten Speichern/Anlegen im Editor
  function isSaveButton(btn){
    var t=(btn.textContent||btn.value||'').toUpperCase().replace(/\s+/g,' ').trim();
    var cls=(btn.className||'').toLowerCase();
    // Tabs/Navi ausschlieÃen
    if(btn.getAttribute('role')==='tab' || /tab|nav-link|navitem|pill/.test(cls) || btn.getAttribute('data-bs-toggle')==='tab') return false;
    return /(TRADE HINZUFÃGEN|TRADE ERÃFFNEN|NEUEN TRADE ANLEGEN|SPEICHERN|ÃNDERUNGEN SPEICHERN|ANLEGEN|SAVE|CREATE|ADD)/.test(t);
  }

  function validate(editor, ev){
    var d=fldDate(editor), b=fldExch(editor), e=fldEntry(editor), m=fldMargin(editor);
    if(!(d&&b&&e&&m)) return true; // kein Editor -> nichts blockieren
    var missing=[];
    var dv=(d.value||'').trim(); if(!dv) missing.push('ErÃ¶ffnungsdatum');
    var bv=(b.value||'').trim(); if(!bv || /^alle$/i.test(bv)) missing.push('BÃ¶rse');
    var evNum=toNumber(e.value); if(!(evNum>0)) missing.push('Einstiegspreis');
    var mvNum=toNumber(m.value); if(!(mvNum>0)) missing.push('Margin');
    if(missing.length){
      if(ev){ ev.preventDefault(); ev.stopPropagation(); }
      alert('Bitte folgende Pflichtfelder ausfÃ¼llen:\n- ' + missing.join('\n- '));
      // Fokus auf erstes fehlendes Feld
      var first = !dv ? d : (!bv || /^alle$/i.test(bv)) ? b : !(evNum>0) ? e : m;
      try{ first && first.focus(); }catch(_){}
      mark(first);
      return false;
    }
    return true;
  }

  document.addEventListener('click', function(e){
    var editor = getVisibleEditor(); if(!editor) return;
    if(!editor.contains(e.target)) return;
    var btn = e.target.closest('button, input[type="submit"], input[type="button"], a'); if(!btn) return;
    if(!isSaveButton(btn)) return;
    validate(editor, e);
  }, true);

  document.addEventListener('keydown', function(e){
    if(e.key!=='Enter') return;
    var editor = getVisibleEditor(); if(!editor) return;
    if(!editor.contains(document.activeElement)) return;
    validate(editor, e);
  }, true);
})();
</script>
<!-- === END: New-Trade Pflichtfelder (Datum, BÃ¶rse, Einstiegspreis, Margin) â 2025-08-17 === -->

<!-- === BEGIN: New-Trade Pflichtfelder v2 (harte Erzwingung) â 2025-08-17 === -->
<script>
(function(){
  function $all(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function txt(n){return (n && (n.innerText||n.textContent)||'').trim();}
  function isVisible(el){ if(!el) return false; var s=getComputedStyle(el); return s.display!=='none'&&s.visibility!=='hidden'&&+s.opacity!==0 && el.offsetParent!==null; }
  function toNumber(str){
    if(str==null) return NaN;
    var s=(''+str).trim().replace(/[^\d\-\.,]/g,'');
    if(!s) return NaN;
    var d=s.lastIndexOf('.'), c=s.lastIndexOf(',');
    if(d>-1 && c>-1){ if(c>d){ s=s.replace(/\./g,'').replace(',', '.'); } else { s=s.replace(/,/g,''); } }
    else if(c>-1){ s=s.replace(',', '.'); }
    var n=parseFloat(s);
    return isFinite(n)? n : NaN;
  }
  function mark(el){
    if(!el) return;
    var old=el.style.boxShadow;
    el.style.boxShadow='0 0 0 2px rgba(231,76,60,.9) inset';
    setTimeout(function(){ el.style.boxShadow=old; }, 1800);
  }

  // -------- Feld-Finder
  function byLabel(root, words){
    var labs=$all('label', root);
    for(var i=0;i<labs.length;i++){
      var t=txt(labs[i]).toLowerCase();
      for(var j=0;j<words.length;j++){
        if(t.includes(words[j])){
          var fid=labs[i].getAttribute('for');
          if(fid){
            var el=root.querySelector('#'+CSS.escape(fid));
            if(el) return el;
          }
          var sib=labs[i].nextElementSibling;
          if(sib && (sib.tagName==='INPUT'||sib.tagName==='SELECT')) return sib;
          var inP=labs[i].parentElement && labs[i].parentElement.querySelector && labs[i].parentElement.querySelector('input,select');
          if(inP) return inP;
        }
      }
    }
    return null;
  }
  function findField(root, sel, words){ return (root && root.querySelector && root.querySelector(sel)) || (root && byLabel(root, words)) || document.querySelector(sel) || byLabel(document, words); }
  function fldDate(root){ return findField(root, 'input[type="datetime-local"], input[name*="datum" i], input[id*="datum" i], input[name*="open" i], input[id*="open" i]', ['datum','erÃ¶ffnung','eroeffnung','open']); }
  function fldExch(root){ return findField(root, 'select[name*="bÃ¶rse" i], select[name*="boerse" i], select[name*="exchange" i]', ['bÃ¶rse','boerse','exchange']); }
  function fldEntry(root){ return findField(root, 'input[name*="entry" i], input[id*="entry" i], input[name*="einstieg" i], input[id*="einstieg" i]', ['einstieg','entry']); }
  function fldMargin(root){ return findField(root, 'input[name*="margin" i], input[id*="margin" i]', ['margin']); }

  function validateAround(btn, ev){
    var container = btn.closest('form, .editor, .trade-new, #trade-new, .new-trade, .card, section, .panel, .popup, .dialog, .module') || document;
    var d=fldDate(container), b=fldExch(container), e=fldEntry(container), m=fldMargin(container);
    // wenn Felder nicht gefunden wurden, versuche global sichtbar
    d = d || fldDate(document); b = b || fldExch(document); e = e || fldEntry(document); m = m || fldMargin(document);
    // wenn gar nichts auffindbar -> nicht blockieren
    if(!(d&&b&&e&&m)) return true;

    var missing=[];
    var dv=(d.value||'').trim(); if(!dv) missing.push('ErÃ¶ffnungsdatum');
    var bv=(b.value||'').trim(); if(!bv || /^alle$/i.test(bv)) missing.push('BÃ¶rse');
    var evNum=toNumber(e.value); if(!(evNum>0)) missing.push('Einstiegspreis');
    var mvNum=toNumber(m.value); if(!(mvNum>0)) missing.push('Margin');

    if(missing.length){
      if(ev){ ev.preventDefault(); ev.stopPropagation(); }
      try{ alert('Bitte folgende Pflichtfelder ausfÃ¼llen:\n- ' + missing.join('\n- ')); }catch(_){}
      var first = !dv ? d : (!bv || /^alle$/i.test(bv)) ? b : !(evNum>0) ? e : m;
      try{ first && first.focus(); }catch(_){}
      mark(first);
      return false;
    }
    return true;
  }

  function isSaveButton(btn){
    if(!btn) return false;
    var t=(btn.textContent||btn.value||'').toUpperCase().replace(/\s+/g,' ').trim();
    var cls=(btn.className||'').toLowerCase();
    var id=(btn.id||'').toLowerCase();
    // Tabs/Navi ausschlieÃen
    if(btn.getAttribute('role')==='tab' || /tab|nav-link|navitem|pill/.test(cls) || btn.getAttribute('data-bs-toggle')==='tab') return false;
    // HÃ¤ufige Texte + Klassen/IDs
    var matchText = /(NEUEN TRADE ANLEGEN|TRADE HINZUFÃGEN|TRADE ERÃFFNEN|SPEICHERN|ÃNDERUNGEN SPEICHERN|ANLEGEN|ADD|SAVE|CREATE)/.test(t);
    var matchAttr = /(save|create|add|commit)/.test(cls+' '+id+' '+(btn.name||''));
    return matchText || matchAttr;
  }

  document.addEventListener('click', function(e){
    var btn=e.target.closest('button, input[type="submit"], input[type="button"], a'); if(!btn) return;
    if(!isSaveButton(btn)) return;
    validateAround(btn, e);
  }, true);

  document.addEventListener('keydown', function(e){
    if(e.key!=='Enter') return;
    var active=document.activeElement; if(!active) return;
    // Wenn Enter aus dem Formular ausgelÃ¶st wird, prÃ¼fen
    var inEditor = active.closest && active.closest('form, .editor, .trade-new, #trade-new, .new-trade, .card, section, .panel, .popup, .dialog, .module');
    if(!inEditor) return;
    validateAround(active, e);
  }, true);

  // --- Storage-Schutz: verhindert das Speichern ungÃ¼ltiger Trades
  function guardStorage(storage){
    if(!storage) return;
    var keys = ['trades','openTrades','laufendeTrades','abgeschlosseneTrades'];
    var _set = storage.setItem.bind(storage);
    storage.setItem = function(k,v){
      try{
        if(k && keys.indexOf(k)>=0 && v){
          var arr = JSON.parse(v);
          if(Array.isArray(arr)){
            var bad = arr.find(function(it){
              if(!it) return true;
              var m = toNumber(it.margin || it.Margin || it.marginUSDT || it.margin_usdt || it.deposit);
              var e = toNumber(it.entry || it.einstieg || it.entryPrice || it.einstiegspreis);
              var ex = (it.exchange || it.boerse || it.bÃ¶rse || '').toString();
              var od = (it.openDate || it.datum || it.open || it.erÃ¶ffnung || it.eroeffnung || '').toString();
              return !(m>0 && e>0 && ex && !/^alle$/i.test(ex) && od);
            });
            if(bad){ alert('Trade konnte nicht gespeichert werden: Pflichtfelder fehlen.'); return; }
          }
        }
      }catch(_){}
      return _set(k,v);
    };
  }
  guardStorage(localStorage);
  guardStorage(sessionStorage);

  // --- DOM-WÃ¤chter: lÃ¶scht unmittelbar ungÃ¼ltige Zeilen aus "Laufende Trades"
  function headerIndexLike(table, name){
    var heads = table.querySelectorAll('thead th, tr th'); var idx=-1;
    for(var i=0;i<heads.length;i++){
      var t=(heads[i].innerText||heads[i].textContent||'').trim().toLowerCase();
      if(t.indexOf(name.toLowerCase())>=0){ idx=i; break; }
    }
    return idx;
  }
  function validateRow(row){
    try{
      var table = row.closest('table'); if(!table) return true;
      var idxEntry = headerIndexLike(table,'entry'); if(idxEntry<0) idxEntry = headerIndexLike(table,'einstieg');
      var idxMargin = headerIndexLike(table,'margin');
      if(idxEntry<0 || idxMargin<0) return true;
      var cells = row.querySelectorAll('td, th, [role="cell"]');
      if(!cells || cells.length<=Math.max(idxEntry,idxMargin)) return true;
      var eVal = toNumber(txt(cells[idxEntry]));
      var mVal = toNumber(txt(cells[idxMargin]));
      if(!(eVal>0 && mVal>0)){
        row.parentNode && row.parentNode.removeChild(row);
        alert('UngÃ¼ltiger Trade wurde verworfen (Einstiegspreis und Margin sind Pflicht).');
        return false;
      }
    }catch(_){}
    return true;
  }
  function observeRunningTrades(){
    var tables = $all('table');
    for(var i=0;i<tables.length;i++){
      var t=tables[i];
      var hasEntry = headerIndexLike(t,'entry')>=0 || headerIndexLike(t,'einstieg')>=0;
      var hasMargin = headerIndexLike(t,'margin')>=0;
      if(!(hasEntry && hasMargin)) continue;
      var tb = t.tBodies && t.tBodies[0]; if(!tb) continue;
      var mo = new MutationObserver(function(muts){
        muts.forEach(function(m){
          m.addedNodes && Array.prototype.forEach.call(m.addedNodes, function(n){
            if(n.nodeType===1 && (n.matches('tr') || n.querySelector('td'))){ validateRow(n); }
          });
        });
      });
      mo.observe(tb, {childList:true, subtree:false});
      // Initial prÃ¼fen
      $all('tr', tb).forEach(validateRow);
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', observeRunningTrades);
  else observeRunningTrades();
  setTimeout(observeRunningTrades, 800);
})();
</script>
<!-- === END: New-Trade Pflichtfelder v2 (harte Erzwingung) â 2025-08-17 === -->

<!-- === BEGIN: Edit-Trade â Ausstiegspreis Pflicht bei Status "Geschlossen" â 2025-08-17 === -->
<script>
(function(){
  function $all(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function txt(n){return (n && (n.innerText||n.textContent)||'').trim();}
  function isVisible(el){ if(!el) return false; var s=getComputedStyle(el); return s.display!=='none'&&s.visibility!=='hidden'&&+s.opacity!==0 && el.offsetParent!==null; }
  function toNumber(str){
    if(str==null) return NaN;
    var s=(''+str).trim().replace(/[^\d\-\.,]/g,'');
    if(!s) return NaN;
    var d=s.lastIndexOf('.'), c=s.lastIndexOf(',');
    if(d>-1 && c>-1){ if(c>d){ s=s.replace(/\./g,'').replace(',', '.'); } else { s=s.replace(/,/g,''); } }
    else if(c>-1){ s=s.replace(',', '.'); }
    var n=parseFloat(s);
    return isFinite(n)? n : NaN;
  }
  function mark(el){
    if(!el) return;
    var old=el.style.boxShadow;
    el.style.boxShadow='0 0 0 2px rgba(231,76,60,.9) inset';
    setTimeout(function(){ el.style.boxShadow=old; }, 1800);
  }

  // Sichtbaren Bearbeiten-Dialog finden (enthÃ¤lt Status & Ausstiegspreis)
  function getEditDialog(){
    var cands = $all('.modal, .dialog, .popup, .sheet, .card, section, form, .panel');
    for(var i=0;i<cands.length;i++){
      var el=cands[i];
      if(!isVisible(el)) continue;
      // muss sowohl "Status" (Select) als auch "Ausstiegspreis" (Input) enthalten
      var hasStatus = !!(el.querySelector('select') && /status/i.test((el.innerText||'').toLowerCase()));
      var hasExit   = !!(el.querySelector('input')  && /ausstiegs?preis/i.test((el.innerText||'').toLowerCase()));
      if(hasStatus && hasExit) return el;
    }
    return null;
  }
  function findExitInput(root){
    // per Label
    var labs=$all('label', root);
    for(var i=0;i<labs.length;i++){
      var t=txt(labs[i]).toLowerCase();
      if(t.indexOf('ausstiegs')>=0 && t.indexOf('preis')>=0){
        var fid=labs[i].getAttribute('for');
        if(fid){
          var el=root.querySelector('#'+CSS.escape(fid));
          if(el) return el;
        }
        var sib=labs[i].nextElementSibling;
        if(sib && sib.tagName==='INPUT') return sib;
        var inP=labs[i].parentElement && labs[i].parentElement.querySelector && labs[i].parentElement.querySelector('input');
        if(inP) return inP;
      }
    }
    // Fallback gÃ¤ngige Selektoren
    return root.querySelector('input[name*="exit" i], input[id*="exit" i], input[name*="ausstieg" i], input[id*="ausstieg" i]');
  }
  function findStatusSelect(root){
    // per Label
    var labs=$all('label', root);
    for(var i=0;i<labs.length;i++){
      var t=txt(labs[i]).toLowerCase();
      if(t.indexOf('status')>=0){
        var fid=labs[i].getAttribute('for');
        if(fid){
          var el=root.querySelector('#'+CSS.escape(fid));
          if(el && el.tagName==='SELECT') return el;
        }
        var sib=labs[i].nextElementSibling;
        if(sib && sib.tagName==='SELECT') return sib;
        var inP=labs[i].parentElement && labs[i].parentElement.querySelector && labs[i].parentElement.querySelector('select');
        if(inP) return inP;
      }
    }
    // Fallback
    return root.querySelector('select[name*="status" i], select[id*="status" i]');
  }
  function isClosed(selectEl){
    if(!selectEl) return false;
    var v=(selectEl.value||'').toLowerCase();
    var t=txt(selectEl).toLowerCase();
    return v.indexOf('geschlossen')>=0 || t.indexOf('geschlossen')>=0 || v==='closed' || v==='close';
  }

  function validateExitOnSave(ev){
    var dlg = getEditDialog();
    if(!dlg) return;
    var statusSel = findStatusSelect(dlg);
    var exitInp   = findExitInput(dlg);
    if(!statusSel || !exitInp) return;
    if(!isClosed(statusSel)) return; // nur prÃ¼fen, wenn "Geschlossen"
    var val = toNumber(exitInp.value);
    if(!(val>0)){
      if(ev){ ev.preventDefault(); ev.stopPropagation(); }
      alert('Bitte einen Ausstiegspreis angeben. Bei Status "Geschlossen" ist der Ausstiegspreis Pflicht.');
      try{ exitInp.focus(); }catch(_){}
      mark(exitInp);
      return false;
    }
    return true;
  }

  // Save-Buttons im Dialog: "ÃNDERUNGEN SPEICHERN", "SPEICHERN"
  function isSaveButton(btn){
    if(!btn) return false;
    var t=(btn.textContent||btn.value||'').toUpperCase().replace(/\s+/g,' ').trim();
    return /(ÃNDERUNGEN SPEICHERN|SPEICHERN|SAVE)/.test(t);
  }

  document.addEventListener('click', function(e){
    var dlg = getEditDialog(); if(!dlg) return;
    if(!dlg.contains(e.target)) return;
    var btn=e.target.closest('button, input[type="submit"], input[type="button"], a'); if(!btn) return;
    if(!isSaveButton(btn)) return;
    validateExitOnSave(e);
  }, true);

  document.addEventListener('keydown', function(e){
    if(e.key!=='Enter') return;
    var dlg = getEditDialog(); if(!dlg) return;
    if(!dlg.contains(document.activeElement)) return;
    validateExitOnSave(e);
  }, true);

  // UX: sobald Status auf "Geschlossen" gestellt wird, Feld als required hervorheben
  document.addEventListener('change', function(e){
    var dlg = getEditDialog(); if(!dlg) return;
    if(!dlg.contains(e.target)) return;
    var st = findStatusSelect(dlg), ex = findExitInput(dlg);
    if(!st || !ex) return;
    if(isClosed(st)){
      try{ ex.required = true; }catch(_){}
      ex.placeholder = ex.placeholder || 'Ausstiegspreis erforderlich bei "Geschlossen"';
      ex.style.outline = '2px solid rgba(231,76,60,.6)';
    }else{
      try{ ex.required = false; }catch(_){}
      ex.style.outline = '';
    }
  }, true);
})();
</script>
<!-- === END: Edit-Trade â Ausstiegspreis Pflicht bei Status "Geschlossen" â 2025-08-17 === -->



<!-- === BEGIN: Richtung-Dropdown: Spot robust + Hebel-Logik (Edit & Neu) â 2025-08-17 v2 === -->
<script>
(function(){
  function $all(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel));}
  function txt(n){return (n && (n.innerText||n.textContent)||'').trim();}
  function isVisible(el){ if(!el) return false; var s=getComputedStyle(el); return s.display!=='none'&&s.visibility!=='hidden'&&+s.opacity!==0 && el.offsetParent!==null; }

  function candidateContainers(){
    return $all('.modal, .dialog, .popup, .sheet, .card, section, form, .panel, .new-trade, #trade-new, .editor');
  }

  function findRichtungSelects(root){
    var sels = $all('select', root||document).filter(function(s){
      if(!isVisible(s)) return false;
      var n=(s.name||'').toLowerCase(), i=(s.id||'').toLowerCase();
      var lab=''; if(s.id){ var l=(document.querySelector('label[for="'+s.id+'"]')); lab=l?txt(l).toLowerCase():''; }
      return n.includes('richtung') || i.includes('richtung') || lab.includes('richtung');
    });
    return sels;
  }
  function findHebelInput(root){
    var ins = $all('input', root||document).filter(function(inp){
      if(!isVisible(inp)) return false;
      var n=(inp.name||'').toLowerCase(), i=(inp.id||'').toLowerCase();
      var lab=''; if(inp.id){ var l=(document.querySelector('label[for="'+inp.id+'"]')); lab=l?txt(l).toLowerCase():''; }
      return n.includes('hebel') || n.includes('leverage') || i.includes('hebel') || i.includes('leverage') || lab.includes('hebel') || lab.includes('leverage');
    });
    return ins[0] || null;
  }

  function ensureSpot(select){
    if(!select) return;
    // PrÃ¼fe vorhandene Optionen
    var has=false;
    for(var i=0;i<select.options.length;i++){
      var v=(select.options[i].value||'').toLowerCase();
      var t=txt(select.options[i]).toLowerCase();
      if(v==='spot' || t==='spot'){ has=true; break; }
    }
    if(!has){
      var opt=document.createElement('option');
      opt.value='Spot';
      opt.textContent='Spot';
      select.appendChild(opt);
    }
  }

  function applyLeverageLogic(select){
    var hebel = findHebelInput(select.closest('.modal, .dialog, .popup, .sheet, .card, section, form, .panel, .new-trade, #trade-new, .editor') || document);
    if(!hebel) return;
    var val=(select.value||'').toLowerCase();
    if(val==='spot'){
      if(!String(hebel.value||'').trim()) hebel.value='1';
      hebel.disabled=true;
      hebel.title='Bei Spot kein Hebel.';
    }else{
      hebel.disabled=false;
      hebel.title='';
    }
  }

  function touchAll(){
    candidateContainers().forEach(function(c){
      findRichtungSelects(c).forEach(function(sel){
        ensureSpot(sel);
        applyLeverageLogic(sel);
        if(!sel.__spotBound){
          sel.addEventListener('change', function(){ ensureSpot(sel); applyLeverageLogic(sel); });
          sel.__spotBound=true;
        }
      });
    });
  }

  // Initial, nach DOM Ready
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', touchAll); } else { touchAll(); }
  // Re-ensure kurzfristig nach UI-Aktionen (Popup Ã¶ffnet, Optionen werden neu gebaut)
  var lastKick=0;
  function kick(){
    var now=Date.now();
    if(now-lastKick<150) return;
    lastKick=now;
    setTimeout(touchAll, 0);
    setTimeout(touchAll, 250);
    setTimeout(touchAll, 800);
  }
  document.addEventListener('click', kick, true);
  document.addEventListener('keyup', kick, true);

  // MutationObserver als zusÃ¤tzliches Netz
  var mo=new MutationObserver(function(){ touchAll(); });
  mo.observe(document.body, {childList:true, subtree:true});
})();
</script>
<!-- === END: Richtung-Dropdown: Spot robust + Hebel-Logik (Edit & Neu) â 2025-08-17 v2 === -->



<script>
// --- Spot leverage enforcement V2 (prefix-matched & modal-safe) ---
(function spotLeverageFixV2(){
  function idPrefix(el){
    var id = (el && el.id) ? el.id : "";
    var i = id.indexOf("-");
    return i > 0 ? id.slice(0, i) : "";
  }
  function findLeverageFor(sideSel){
    var prefix = idPrefix(sideSel);
    // 1) Try direct id match: <prefix>-lev
    if (prefix) {
      var byId = document.getElementById(prefix + "-lev");
      if (byId) return byId;
    }
    // 2) Climb ancestors to find a leverage input within the same container
    var node = sideSel;
    while (node && node !== document.documentElement) {
      if (node.querySelector){
        var within = node.querySelector('input[id$="-lev"], select[id$="-lev"]');
        if (within) return within;
      }
      node = node.parentElement;
    }
    // 3) Fallback: choose the leverage input that shares the longest common prefix
    var all = Array.from(document.querySelectorAll('input[id$="-lev"], select[id$="-lev"]'));
    var best = null, bestScore = -1, sid = sideSel.id || "";
    all.forEach(function(el){
      var score = 0;
      for (var k=0; k<Math.min(sid.length, el.id.length); k++){
        if (sid[k] === el.id[k]) score++; else break;
      }
      if (score > bestScore){ bestScore = score; best = el; }
    });
    return best;
  }
  function setLev(levEl, isSpot){
    if (!levEl) return;
    if (isSpot){
      levEl.value = "1";
      levEl.setAttribute('data-prev-disabled', levEl.disabled ? '1' : '0');
      levEl.disabled = true;
    } else {
      var was = levEl.getAttribute('data-prev-disabled');
      if (was === '1') { levEl.disabled = true; }
      else { levEl.disabled = false; }
      if (was === null) levEl.disabled = false;
    }
  }
  function applyOne(sideSel){
    var lev = findLeverageFor(sideSel);
    var isSpot = (sideSel.value && sideSel.value.trim().toLowerCase() === "spot");
    setLev(lev, isSpot);
  }
  function enforceAll(){
    document.querySelectorAll('select[id$="side"]').forEach(applyOne);
  }
  // Events
  document.addEventListener("change", function(e){
    if (e.target && e.target.matches('select[id$="side"]')) applyOne(e.target);
  });
  document.addEventListener("input", function(e){
    if (e.target && e.target.matches('select[id$="side"]')) applyOne(e.target);
  });
  document.addEventListener("DOMContentLoaded", enforceAll);
  window.addEventListener("load", enforceAll);
  // Modal-safe: observe new nodes and attribute changes
  var mo = new MutationObserver(function(muts){
    var need = false;
    for (var i=0; i<muts.length; i++){
      var m = muts[i];
      if (m.type === "childList" || m.type === "attributes"){
        need = true; break;
      }
    }
    if (need) enforceAll();
  });
  mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:["style","class","open","aria-hidden","hidden"]});
})();
</script>


<link rel="stylesheet" href="ctt_patch_styles_2025-08-18.css">
<script src="ctt_patches_2025-08-18.js"></script>
<script src="ctt_marketloader_fallback_2025-08-18.js"></script>

<script>
/**
 * FILEMODE_FORCE_PAGER (inline) â robust fÃ¼r file://
 * - 50 Zeilen/Seite, Pager oben & unten (Icons)
 * - Erzwingt Anzeige mit style.display = 'table-row'/'none' + !important
 * - LÃ¤uft in Intervallen (250ms), damit Fremd-Render Ã¼berschrieben werden
 * - Keine externen AbhÃ¤ngigkeiten
 */
(function(){
  const PAGE = 50, TICK = 250;
  const state = { page: 1 };

  function $(q, r){ return (r||document).querySelector(q); }
  function $$(q, r){ return Array.from((r||document).querySelectorAll(q)); }

  function findPanel(){
    // Suche Bereich mit Ãberschrift "MarktÃ¼bersicht"/"Market overview"
    const nodes = $$('section,div,article');
    for(const el of nodes){
      const h = el.querySelector('h2,h3,.h,.title,strong');
      if(h){
        const t = (h.textContent||'').toLowerCase();
        if(t.includes('marktÃ¼bersicht') || t.includes('market overview')) return el;
      }
    }
    return document.body;
  }
  function findTable(panel){
    return $('#cg-table', panel) || panel.querySelector('table');
  }
  function ensurePager(id, table, where){
    let p = document.getElementById(id);
    if(!p){
      p = document.createElement('div');
      p.id = id;
      p.style.display='none';
      p.style.gap='8px';
      p.style.alignItems='center';
      p.style.position='sticky';
      p.style[where==='top'?'top':'bottom']='0';
      p.style.zIndex='3';
      p.setAttribute('role','navigation');
      p.setAttribute('aria-label','Pagination');
      if(where==='top'){ table.parentNode.insertBefore(p, table); }
      else { table.parentNode.insertBefore(p, table.nextSibling); }
    }
    return p;
  }
  function mkBtn(icon, dis, cb){
    const b = document.createElement('button');
    b.className='btn small';
    b.textContent=icon;
    b.disabled=!!dis;
    if(!dis) b.onclick=cb;
    return b;
  }
  function renderPager(pager, total){
    const totalPages = Math.ceil(total / PAGE) || 1;
    const prevDis = state.page<=1;
    const nextDis = state.page>=totalPages;
    const show = totalPages>1;
    pager.innerHTML='';
    pager.style.display = show ? 'flex' : 'none';
    if(!show) return;
    pager.appendChild(mkBtn('â®', prevDis, ()=>{ state.page=1; }));
    pager.appendChild(mkBtn('â', prevDis, ()=>{ state.page=Math.max(1, state.page-1); }));
    const span = document.createElement('span'); span.style.padding='0 6px'; span.textContent=`Seite ${state.page} / ${totalPages}`; pager.appendChild(span);
    pager.appendChild(mkBtn('â¶', nextDis, ()=>{ state.page=Math.min(totalPages, state.page+1); }));
  }
  function slice(table){
    const tb = table.tBodies && table.tBodies[0] ? table.tBodies[0] : table.querySelector('tbody');
    if(!tb) return 0;
    const rows = Array.from(tb.querySelectorAll('tr'));
    const total = rows.length;
    const totalPages = Math.ceil(total / PAGE) || 1;
    if(state.page>totalPages) state.page=totalPages;
    const start=(state.page-1)*PAGE, end=start+PAGE;
    for(let i=0;i<rows.length;i++){
      const tr = rows[i];
      if(total>PAGE && !(i>=start && i<end)){
        tr.style.setProperty('display','none','important');
      }else{
        tr.style.setProperty('display','table-row','important');
      }
    }
    return total;
  }

  function tick(){
    const panel = findPanel();
    const table = findTable(panel);
    if(!table) return;
    const top = ensurePager('cg-pager-top', table, 'top');
    const bot = ensurePager('cg-pager-bottom', table, 'bottom');
    const total = slice(table);
    renderPager(top, total);
    renderPager(bot, total);
  }

  // Sofort starten + Intervall
  tick();
  setInterval(tick, TICK);
})();
</script>

<style id="ctt-pagerfix-style">
/* Dark-mode friendly pager styling */
.ctt-pager {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
  margin: 6px 0;
  border-top: 1px solid rgba(255,255,255,0.08);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.ctt-pager button {
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.06);
  padding: 6px 10px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
}
.ctt-pager button[disabled] {
  opacity: 0.4;
  cursor: not-allowed;
}
.ctt-page-indicator {
  min-width: 120px;
  text-align: center;
  font-variant-numeric: tabular-nums;
}
/* Hide any stray "EintrÃ¤ge/Anzeige" controls if they exist */
label, .entries, .page-size, .entries-select, #entriesSelect {
  /* We'll selectively hide via JS to avoid overreaching */
}
</style>

<script id="ctt-pagerfix-script">
(function(){
  // Namespaced to avoid collisions
  const CTT_PagerFix = {
    pageSize: 50,
    init(){
      // Remove "EintrÃ¤ge/Anzeige" controls if present (by text content)
      try {
        const maybeControls = Array.from(document.querySelectorAll("label, .entries, .page-size, .entries-select, #entriesSelect, .dataTables_length"));
        maybeControls.forEach(el => {
          const t = (el.textContent || "").toLowerCase();
          if (t.includes("eintrÃ¤ge") || t.includes("eintraege") || t.includes("anzeige") || t.includes("entries per page")) {
            el.remove();
          }
        });
      } catch(e){ /* no-op */ }

      // Find candidate tables: prefer ones marked explicitly, else any large tbody
      const explicit = Array.from(document.querySelectorAll('table[data-paginate="auto"], table.paged-table'));
      let tables = explicit.length ? explicit : Array.from(document.querySelectorAll("table"));

      tables = tables.filter(tb => {
        const tbody = tb.tBodies && tb.tBodies[0];
        if (!tbody) return false;
        const rows = Array.from(tbody.rows).filter(r => r.style.display !== "none");
        return rows.length > CTT_PagerFix.pageSize; // only paginate if > 50 rows
      });

      tables.forEach(tb => this.applyPager(tb));
    },
    applyPager(table){
      // Avoid double-applying
      if (table.dataset.cttPagerApplied === "1") return;
      table.dataset.cttPagerApplied = "1";

      const tbody = table.tBodies && table.tBodies[0];
      if (!tbody) return;

      // Snapshot rows to a list; we won't remove them, only toggle display
      const allRows = Array.from(tbody.rows);
      const total = allRows.length;
      const pageCount = Math.ceil(total / this.pageSize);

      if (pageCount <= 1) return; // nothing to do

      // Create pagers
      const topPager = this.makePager();
      const bottomPager = this.makePager();
      // Insert top above table; bottom below table
      table.parentNode.insertBefore(topPager, table);
      if (table.nextSibling) {
        table.parentNode.insertBefore(bottomPager, table.nextSibling);
      } else {
        table.parentNode.appendChild(bottomPager);
      }

      // State
      let currentPage = 1;

      const render = () => {
        const start = (currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;

        // Minimize layout thrash: detach tbody if possible
        // Show only rows in [start, end)
        for (let i = 0; i < allRows.length; i++) {
          const show = (i >= start && i < end);
          const r = allRows[i];
          if (show) {
            r.style.display = "";
          } else {
            r.style.display = "none";
          }
        }

        // Update indicators/buttons
        const updatePager = (pagerEl) => {
          const ind = pagerEl.querySelector(".ctt-page-indicator");
          ind.textContent = `Seite ${currentPage} / ${pageCount}`;
          pagerEl.querySelector('[data-act="first"]').disabled = (currentPage === 1);
          pagerEl.querySelector('[data-act="prev"]').disabled = (currentPage === 1);
          pagerEl.querySelector('[data-act="next"]').disabled = (currentPage === pageCount);
          pagerEl.querySelector('[data-act="last"]').disabled = (currentPage === pageCount);
        };

        updatePager(topPager);
        updatePager(bottomPager);
      };

      const goto = (p) => {
        if (p < 1) p = 1;
        if (p > pageCount) p = pageCount;
        currentPage = p;
        render();
      };

      const bindPager = (pagerEl) => {
        pagerEl.querySelector('[data-act="first"]').onclick = () => goto(1);
        pagerEl.querySelector('[data-act="prev"]').onclick  = () => goto(currentPage - 1);
        pagerEl.querySelector('[data-act="next"]').onclick  = () => goto(currentPage + 1);
        pagerEl.querySelector('[data-act="last"]').onclick  = () => goto(pageCount);
      };

      bindPager(topPager);
      bindPager(bottomPager);
      // Initial render (no flicker: render once after building)
      goto(1);
    },
    makePager(){
      const wrap = document.createElement("div");
      wrap.className = "ctt-pager";

      const mkBtn = (act, label) => {
        const b = document.createElement("button");
        b.type = "button";
        b.setAttribute("data-act", act);
        b.setAttribute("aria-label", act);
        b.textContent = label;
        return b;
      };

      const first = mkBtn("first", "â®");
      const prev  = mkBtn("prev",  "â");
      const ind   = document.createElement("div");
      ind.className = "ctt-page-indicator";
      ind.textContent = "Seite â / â";
      const next  = mkBtn("next",  "â¶");
      const last  = mkBtn("last",  "â­");

      wrap.append(first, prev, ind, next, last);
      return wrap;
    }
  };

  // Run after DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => CTT_PagerFix.init());
  } else {
    CTT_PagerFix.init();
  }
})();
</script>
</body>
</html>